<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#D4A574">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="description" content="Свет Души - приложение для поддержки при депрессии">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23FDF8F3' width='100' height='100' rx='20'/><circle cx='50' cy='45' r='25' fill='%23FCD34D'/><circle cx='50' cy='45' r='18' fill='%23FBBF24'/></svg>">
    <title>Свет Души</title>
    <script>
        if ('serviceWorker' in navigator && location.protocol !== 'file:') {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('SW registered'))
                    .catch(err => console.log('SW failed', err));
            });
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700&display=swap');
        
        :root {
            --golden-light: #F6C445;
            --golden-soft: #FAD978;
            --amber: #E8A838;
            --amber-warm: #D4882B;
            --peach-glow: #FDD5B1;
            --peach-soft: #FEE8D6;
            --rose-aurora: #F4A4A4;
            --twilight-blue: #4A6FA5;
            --twilight-deep: #2D4A6F;
            --night-sky: #1A2F4A;
            --violet: #6B5B8C;
            --violet-soft: #8A7AAA;
            --lavender: #B8A9C9;
            --harmony-green: #7BA885;
            --harmony-light: #A8C9AE;
            --sage: #9CAF88;
            --cream-light: #FFFBF5;
            --cream-warm: #FFF8F0;
            --sand: #F5EDE0;
            --earth-light: #E8DFD4;
            --text-primary: #2D2520;
            --text-secondary: #5C524A;
            --text-tertiary: #8A7F75;
            --text-on-dark: #FFFBF5;
            --shadow-sm: 0 1px 2px rgba(45, 37, 32, 0.05);
            --shadow-md: 0 4px 12px rgba(45, 37, 32, 0.08);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            --bg-primary: #FFFBF5;
            --bg-card: white;
            --bg-nav: rgba(255, 251, 245, 0.95);
        }
        
        .dark-theme {
            --golden-light: #D4A84B;
            --golden-soft: #B89A40;
            --amber: #C9922F;
            --amber-warm: #A67825;
            --peach-glow: #2D2A27;
            --peach-soft: #262422;
            --cream-light: #1A1816;
            --cream-warm: #222220;
            --sand: #2A2826;
            --earth-light: #3A3835;
            --text-primary: #E5E2DC;
            --text-secondary: #A5A099;
            --text-tertiary: #706B65;
            --text-on-dark: #E5E2DC;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.4);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.5);
            --bg-primary: #1A1816;
            --bg-card: #242220;
            --bg-nav: rgba(26, 24, 22, 0.98);
            --harmony-green: #5A8A65;
            --harmony-light: #4A7A55;
            --twilight-blue: #4A6A95;
            --twilight-deep: #2A4A6A;
            --violet: #6A5A8A;
            --violet-soft: #7A6A9A;
            --rose-aurora: #8A5A5A;
        }
        
        .dark-theme body {
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        
        .dark-theme .card {
            background: var(--bg-card) !important;
            border: 1px solid var(--earth-light) !important;
            color: var(--text-primary) !important;
        }
        
        .dark-theme .card-clickable:hover {
            background: #2D2B28 !important;
        }
        
        .dark-theme .bottom-nav {
            background: var(--bg-nav);
            border-top: 1px solid var(--earth-light);
        }
        
        .dark-theme .nav-item {
            color: var(--text-secondary);
        }
        
        .dark-theme .nav-item.active {
            color: var(--golden-light);
        }
        
        .dark-theme .btn-primary {
            background: linear-gradient(135deg, var(--amber), var(--golden-light));
            color: #1A1816;
        }
        
        .dark-theme .btn-secondary {
            background: var(--sand);
            color: var(--text-primary);
            border: 1px solid var(--earth-light);
        }
        
        .dark-theme input, .dark-theme textarea, .dark-theme select {
            background: var(--sand);
            color: var(--text-primary);
            border: 1px solid var(--earth-light);
        }
        
        .dark-theme input::placeholder, .dark-theme textarea::placeholder {
            color: var(--text-tertiary);
        }
        
        .dark-theme .journal-textarea {
            background: var(--sand);
            color: var(--text-primary);
        }
        
        .dark-theme .quote-card {
            background: linear-gradient(135deg, #2A3545, #1A2535) !important;
            border: 1px solid var(--twilight-blue);
            color: var(--text-primary) !important;
        }
        
        .dark-theme .quote-card *,
        .dark-theme .quote-text,
        .dark-theme .quote-author {
            color: #E5E2DC !important;
        }
        
        .dark-theme .recommendation-card {
            background: var(--bg-card) !important;
            border: 1px solid var(--earth-light);
            color: var(--text-primary) !important;
        }
        
        .dark-theme .recommendation-card * {
            color: var(--text-primary) !important;
        }
        
        .dark-theme .recommendation-title {
            color: var(--golden-light) !important;
        }
        
        .dark-theme .soul-chip {
            background: var(--sand);
            border: 1px solid var(--earth-light);
            color: var(--text-primary);
        }
        
        .dark-theme .soul-chip.active {
            background: var(--amber);
            color: #1A1816;
            border-color: var(--golden-light);
        }
        
        .dark-theme .alert {
            background: var(--sand);
            border: 1px solid var(--earth-light);
            color: var(--text-primary);
        }
        
        .dark-theme .alert-info {
            background: rgba(74, 106, 149, 0.2);
            border-color: var(--twilight-blue);
        }
        
        .dark-theme .progress-bar {
            background: var(--sand);
        }
        
        .dark-theme .progress-fill {
            background: linear-gradient(90deg, var(--amber), var(--golden-light));
        }
        
        .dark-theme h1, .dark-theme h2, .dark-theme h3, .dark-theme h4 {
            color: var(--text-primary);
        }
        
        .dark-theme p, .dark-theme span, .dark-theme div {
            color: inherit;
        }
        
        .dark-theme .category-chip {
            background: var(--sand);
            border: 1px solid var(--earth-light);
            color: var(--text-primary);
        }
        
        .dark-theme .category-chip.active {
            background: var(--amber);
            color: #1A1816;
        }
        
        /* Практики - единый тёмный стиль */
        .dark-theme .card[style*="background: #FEF"],
        .dark-theme .card[style*="background: #F0F"],
        .dark-theme .card[style*="background: #EFF"],
        .dark-theme .card[style*="background: #FCE"],
        .dark-theme .card[style*="background: #FFF"],
        .dark-theme .card[style*="background: #E0"],
        .dark-theme .card[style*="background: #D1"],
        .dark-theme .card[style*="background: linear-gradient"] {
            background: var(--bg-card) !important;
            border: 1px solid var(--earth-light) !important;
            color: var(--text-primary) !important;
        }
        
        .dark-theme .card[style*="background"] * {
            color: var(--text-primary) !important;
        }
        
        .dark-theme .card[style*="background"] .btn-primary {
            color: #1A1816 !important;
        }
        
        /* Цветовые акценты для карточек практик */
        .dark-theme .card[style*="background: #FEF3C7"],
        .dark-theme .card[style*="background: #FDE68A"] {
            background: #2D2820 !important;
            border-left: 3px solid var(--golden-light) !important;
        }
        
        .dark-theme .card[style*="background: #F0FDF4"],
        .dark-theme .card[style*="background: #D1FAE5"] {
            background: #202D22 !important;
            border-left: 3px solid var(--harmony-green) !important;
        }
        
        .dark-theme .card[style*="background: #FEF2F2"],
        .dark-theme .card[style*="background: #FECACA"],
        .dark-theme .card[style*="background: #FEE2E2"] {
            background: #2D2020 !important;
            border-left: 3px solid var(--rose-aurora) !important;
        }
        
        .dark-theme .card[style*="background: #EFF6FF"],
        .dark-theme .card[style*="background: #DBEAFE"] {
            background: #202530 !important;
            border-left: 3px solid var(--twilight-blue) !important;
        }
        
        .dark-theme .card[style*="background: #F3E8FF"],
        .dark-theme .card[style*="background: #E9D5FF"],
        .dark-theme .card[style*="background: #EDE9FE"] {
            background: #252030 !important;
            border-left: 3px solid var(--violet) !important;
        }
        
        .dark-theme .card[style*="background: #FFEDD5"],
        .dark-theme .card[style*="background: #FED7AA"] {
            background: #2D2520 !important;
            border-left: 3px solid #B8860B !important;
        }
        
        /* Все inline стили с белым фоном */
        .dark-theme [style*="background: white"],
        .dark-theme [style*="background: #FFF"],
        .dark-theme [style*="background:#FFF"] {
            background: var(--bg-card) !important;
            color: var(--text-primary) !important;
        }
        
        /* Теги/чипы */
        .dark-theme [style*="border-radius: 15px"],
        .dark-theme [style*="border-radius: 10px"] {
            background: var(--sand) !important;
            color: var(--text-primary) !important;
            border: 1px solid var(--earth-light) !important;
        }
        
        /* Ссылки телефонов */
        .dark-theme a {
            color: var(--golden-light);
        }
        
        /* Подсказки и мелкий текст */
        .dark-theme [style*="color: var(--text-secondary)"],
        .dark-theme [style*="color: var(--text-tertiary)"] {
            color: var(--text-secondary) !important;
        }
        
        /* Кнопки в карточках */
        .dark-theme .btn-small {
            background: var(--sand);
            color: var(--text-primary);
            border: 1px solid var(--earth-light);
        }
        
        .dark-theme .btn-small.btn-primary {
            background: var(--amber);
            color: #1A1816;
            border: none;
        }
        
        /* Исправление цитаты на главной */
        .dark-theme .quote-card,
        .dark-theme [class*="quote"] {
            background: linear-gradient(135deg, #2A3040, #1A2535) !important;
            color: #E5E2DC !important;
        }
        
        /* Универсальный переопределитель для тёмной темы */
        .dark-theme .card {
            background: var(--bg-card) !important;
            color: var(--text-primary) !important;
            border: 1px solid var(--earth-light) !important;
        }
        
        .dark-theme .card h1,
        .dark-theme .card h2,
        .dark-theme .card h3,
        .dark-theme .card h4,
        .dark-theme .card p,
        .dark-theme .card span,
        .dark-theme .card div,
        .dark-theme .card strong,
        .dark-theme .card label {
            color: var(--text-primary) !important;
        }
        
        .dark-theme .card .btn-primary {
            color: #1A1816 !important;
        }
        
        /* Практики - цветовой акцент слева по категории */
        .dark-theme .card-clickable[style] {
            border-left: 3px solid var(--golden-light) !important;
        }
        
        /* Переопределение всех inline background в тёмной теме */
        .dark-theme [style*="background:"],
        .dark-theme [style*="background :"],
        .dark-theme div[style*="background"],
        .dark-theme [style*="background: #F"],
        .dark-theme [style*="background: #E"],
        .dark-theme [style*="background: #D"],
        .dark-theme [style*="background: linear"],
        .dark-theme [style*="background: rgb"] {
            background: var(--bg-card) !important;
            color: var(--text-primary) !important;
        }
        
        .dark-theme [style*="background"] h1,
        .dark-theme [style*="background"] h2,
        .dark-theme [style*="background"] h3,
        .dark-theme [style*="background"] p,
        .dark-theme [style*="background"] span,
        .dark-theme [style*="background"] strong,
        .dark-theme [style*="background"] div {
            color: var(--text-primary) !important;
        }
        
        /* Номер шага в практике */
        .dark-theme .step-number,
        .dark-theme [style*="background: var(--golden)"],
        .dark-theme [style*="background: var(--amber)"] {
            background: var(--amber) !important;
            color: #1A1816 !important;
        }
        
        /* Карточка шага практики в тёмной теме */
        .dark-theme .step-card {
            background: rgba(42, 40, 38, 0.9) !important;
            color: var(--text-primary) !important;
        }
        
        .dark-theme .step-num {
            background: linear-gradient(135deg, var(--amber), var(--golden-light)) !important;
            color: #1A1816 !important;
        }
        
        .dark-theme .step-text {
            color: var(--text-primary) !important;
        }
        
        /* Карточка с любым inline background в тёмной теме */
        .dark-theme .card[style] {
            background: var(--bg-card) !important;
            border: 1px solid var(--earth-light) !important;
        }
        
        /* Рекомендации и алерты */
        .dark-theme .recommendation-card {
            background: var(--bg-card) !important;
            color: var(--text-primary) !important;
            border: 1px solid var(--earth-light) !important;
        }
        
        .dark-theme .recommendation-card *,
        .dark-theme .recommendation-title {
            color: var(--text-primary) !important;
        }
        
        /* Исправление полей ввода имени */
        .dark-theme input[type="text"],
        .dark-theme input:not([type]) {
            background: var(--sand) !important;
            color: var(--text-primary) !important;
            border: 1px solid var(--earth-light) !important;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { font-size: 16px; }
        body {
            font-family: 'Nunito', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--cream-light);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
            overscroll-behavior: none;
        }
        h1, h2, h3, h4 { font-weight: 600; line-height: 1.3; }
        h1 { font-size: 1.5rem; }
        h2 { font-size: 1.25rem; }
        h3 { font-size: 1.1rem; }
        
        .app { 
            min-height: 100vh; 
            padding-bottom: calc(70px + var(--safe-bottom)); 
        }
        
        .main { 
            padding: 1rem; 
            padding-top: max(1rem, env(safe-area-inset-top)); 
        }
        
        /* Нижняя навигация */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--cream-warm);
            border-top: 1px solid var(--earth-light);
            display: flex;
            justify-content: space-around;
            padding: 0.5rem 0;
            padding-bottom: calc(0.5rem + var(--safe-bottom));
            z-index: 100;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.4rem 0.75rem;
            border-radius: 12px;
            color: var(--text-tertiary);
            font-size: 0.65rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .nav-item.active {
            color: var(--amber);
            background: rgba(232, 168, 56, 0.1);
        }
        .nav-icon { font-size: 1.3rem; margin-bottom: 2px; }
        
        /* Карточки */
        .card {
            background: var(--cream-warm);
            border-radius: 16px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            box-shadow: var(--shadow-sm);
        }
        .card-clickable { cursor: pointer; }
        .card-clickable:active { transform: scale(0.98); opacity: 0.9; }
        
        /* Кнопки */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 12px 20px;
            border-radius: 12px;
            font-family: inherit;
            font-weight: 600;
            font-size: 0.9rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--amber), var(--golden-light));
            color: var(--text-on-dark);
            box-shadow: var(--shadow-md);
        }
        .btn-primary:active { transform: scale(0.96); }
        .btn-secondary {
            background: var(--cream-warm);
            color: var(--text-primary);
            border: 1px solid var(--earth-light);
        }
        .btn-small { padding: 8px 14px; font-size: 0.8rem; }
        .btn-full { width: 100%; }
        
        /* Состояния души */
        .soul-states { 
            display: flex; 
            gap: 0.4rem; 
            overflow-x: auto; 
            padding: 0.5rem 0; 
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        .soul-states::-webkit-scrollbar { display: none; }
        .soul-chip {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 10px;
            border-radius: 12px;
            background: var(--cream-warm);
            min-width: 60px;
            flex-shrink: 0;
            cursor: pointer;
            transition: all 0.2s;
        }
        .soul-chip.active {
            background: linear-gradient(135deg, var(--amber), var(--golden-light));
            color: var(--text-on-dark);
        }
        .soul-emoji { font-size: 1.2rem; }
        .soul-label { font-size: 0.6rem; font-weight: 500; margin-top: 2px; }
        
        /* Категории */
        .category-pills { 
            display: flex; 
            gap: 0.4rem; 
            overflow-x: auto; 
            padding: 0.5rem 0;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        .category-pills::-webkit-scrollbar { display: none; }
        .category-pill {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            border-radius: 20px;
            background: var(--cream-warm);
            font-size: 0.75rem;
            white-space: nowrap;
            flex-shrink: 0;
            cursor: pointer;
        }
        .category-pill.active {
            background: var(--amber);
            color: var(--text-on-dark);
        }
        
        /* Рекомендации */
        .recommendation-card {
            background: linear-gradient(135deg, var(--golden-soft) 0%, var(--peach-soft) 100%);
            border-radius: 16px;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }
        .recommendation-title { font-weight: 600; margin-bottom: 0.25rem; }
        .recommendation-reason { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.5rem; }
        
        /* Цитата */
        .quote-card {
            background: linear-gradient(135deg, var(--lavender), var(--violet-soft));
            color: var(--text-on-dark);
            border-radius: 16px;
            padding: 1.25rem;
            text-align: center;
        }
        .quote-text { font-size: 1rem; font-style: italic; margin-bottom: 0.5rem; }
        .quote-author { font-size: 0.8rem; opacity: 0.8; }
        
        /* Приветствие */
        .greeting { font-size: 1.4rem; font-weight: 600; margin-bottom: 0.25rem; }
        .greeting-sub { color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem; }
        
        /* Сетки */
        .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; }
        
        /* Практика */
        .practice-meta { display: flex; gap: 0.75rem; margin-top: 0.5rem; font-size: 0.75rem; color: var(--text-tertiary); }
        
        /* Шаги практики */
        .step-card {
            display: flex;
            gap: 0.75rem;
            background: rgba(255,255,255,0.7);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }
        .step-num {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: linear-gradient(135deg, var(--amber), var(--golden-light));
            color: var(--text-on-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            flex-shrink: 0;
        }
        .step-text { font-size: 0.95rem; line-height: 1.5; }
        
        /* Прогресс */
        .progress-bar { height: 4px; background: var(--earth-light); border-radius: 2px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--amber), var(--golden-light)); border-radius: 2px; transition: width 0.3s; }
        
        /* Чат */
        .chat-container { display: flex; flex-direction: column; height: calc(100vh - 140px); }
        .chat-messages { flex: 1; overflow-y: auto; padding: 0.5rem 0; }
        .chat-msg { display: flex; gap: 8px; margin-bottom: 0.75rem; max-width: 85%; }
        .chat-msg.user { margin-left: auto; flex-direction: row-reverse; }
        .chat-avatar { width: 32px; height: 32px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1rem; flex-shrink: 0; }
        .chat-avatar.ai { background: linear-gradient(135deg, var(--golden-soft), var(--peach-glow)); }
        .chat-avatar.user { background: var(--violet-soft); }
        .chat-bubble { padding: 10px 14px; border-radius: 14px; font-size: 0.9rem; line-height: 1.4; }
        .chat-msg.ai .chat-bubble { background: var(--cream-warm); border-bottom-left-radius: 4px; }
        .chat-msg.user .chat-bubble { background: linear-gradient(135deg, var(--amber), var(--golden-light)); color: var(--text-on-dark); border-bottom-right-radius: 4px; }
        .chat-input-container { display: flex; gap: 8px; padding: 0.75rem; background: var(--cream-warm); border-radius: 16px; margin-top: 0.5rem; }
        .chat-input { flex: 1; border: none; background: transparent; font-family: inherit; font-size: 0.9rem; color: var(--text-primary); outline: none; }
        
        /* Дневник */
        .journal-entry { background: var(--cream-warm); border-radius: 12px; padding: 1rem; margin-bottom: 0.5rem; }
        .journal-textarea { width: 100%; min-height: 150px; border: 1px solid var(--earth-light); border-radius: 12px; padding: 1rem; font-family: inherit; font-size: 0.95rem; line-height: 1.6; resize: none; background: var(--cream-light); outline: none; }
        .journal-textarea:focus { border-color: var(--amber); }
        
        /* Статистика */
        .stat-card { text-align: center; padding: 1rem; background: var(--cream-warm); border-radius: 12px; }
        .stat-value { font-size: 1.5rem; font-weight: 700; color: var(--amber); }
        .stat-label { font-size: 0.7rem; color: var(--text-tertiary); margin-top: 2px; }
        
        /* Природный бейдж */
        .theme-badge { display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; border-radius: 16px; font-size: 0.75rem; font-weight: 500; }
        
        /* Темперамент */
        .temperament-card { padding: 0.75rem; border-radius: 12px; text-align: center; cursor: pointer; border: 2px solid transparent; }
        .temperament-card.active { border-color: var(--amber); }
        .temperament-icon { font-size: 1.5rem; margin-bottom: 0.25rem; }
        .temperament-name { font-weight: 600; font-size: 0.8rem; }
        .temperament-element { font-size: 0.65rem; color: var(--text-tertiary); }
        
        /* Алерты */
        .alert { padding: 0.75rem; border-radius: 12px; margin-bottom: 0.75rem; display: flex; gap: 8px; align-items: flex-start; font-size: 0.85rem; }
        .alert-info { background: #E0F2FE; border-left: 3px solid #0EA5E9; }
        .alert-warning { background: #FEF3C7; border-left: 3px solid var(--amber); }
        
        /* Анимации */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .fade-in { animation: fadeIn 0.3s ease forwards; }
        
        /* Ритм дня */
        .day-period { padding: 0.75rem; border-radius: 12px; margin-bottom: 0.5rem; background: var(--cream-warm); }
        .day-period.active { border-left: 3px solid var(--amber); background: var(--sand); }
        .day-period-header { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem; }
        .day-period-icon { font-size: 1.25rem; }
        .day-period-time { font-size: 0.7rem; color: var(--text-tertiary); }
    </style>
</head>
<body>
    <div id="root"></div>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ═══════════════════════════════════════════════════════════════
        // БАЗА ДАННЫХ
        // ═══════════════════════════════════════════════════════════════
        
        const DB = {
            get: (key, def = null) => {
                try {
                    const item = localStorage.getItem('svetdushi_' + key);
                    return item ? JSON.parse(item) : def;
                } catch { return def; }
            },
            set: (key, value) => {
                try { localStorage.setItem('svetdushi_' + key, JSON.stringify(value)); } catch {}
            },
            getStateHistory: () => DB.get('state_history', []),
            addState: (state) => {
                const history = DB.getStateHistory();
                history.push({ state, timestamp: Date.now(), date: new Date().toISOString() });
                if (history.length > 100) history.shift();
                DB.set('state_history', history);
            },
            getJournal: () => DB.get('journal', []),
            addJournalEntry: (entry) => {
                const journal = DB.getJournal();
                journal.unshift({ ...entry, id: Date.now(), date: new Date().toISOString() });
                DB.set('journal', journal);
            },
            getPracticeHistory: () => DB.get('practice_history', []),
            addPractice: (practiceId, duration) => {
                const history = DB.getPracticeHistory();
                history.push({ practiceId, duration, timestamp: Date.now(), date: new Date().toISOString() });
                DB.set('practice_history', history);
            },
            getProfile: () => DB.get('profile', { temperament: null, name: '' }),
            setProfile: (profile) => DB.set('profile', profile),
            // Прогулки трекер
            getWalks: () => DB.get('walks', []),
            addWalk: (walk) => {
                const walks = DB.getWalks();
                walks.push({ ...walk, id: Date.now(), date: new Date().toISOString() });
                DB.set('walks', walks);
                return walks;
            },
            getWalkStats: () => {
                const walks = DB.getWalks();
                const now = Date.now();
                const weekAgo = now - 7 * 24 * 60 * 60 * 1000;
                const monthAgo = now - 30 * 24 * 60 * 60 * 1000;
                
                const weekWalks = walks.filter(w => new Date(w.date).getTime() > weekAgo);
                const monthWalks = walks.filter(w => new Date(w.date).getTime() > monthAgo);
                
                // Подсчёт серии (streak)
                let currentStreak = 0;
                let checkDate = new Date();
                checkDate.setHours(0, 0, 0, 0);
                
                while (true) {
                    const dayStart = checkDate.getTime();
                    const dayEnd = dayStart + 24 * 60 * 60 * 1000;
                    const hasWalk = walks.some(w => {
                        const wTime = new Date(w.date).getTime();
                        return wTime >= dayStart && wTime < dayEnd;
                    });
                    if (hasWalk) {
                        currentStreak++;
                        checkDate.setDate(checkDate.getDate() - 1);
                    } else if (currentStreak === 0 && checkDate.getTime() === new Date().setHours(0,0,0,0)) {
                        // Сегодня ещё нет прогулки, проверим вчера
                        checkDate.setDate(checkDate.getDate() - 1);
                    } else {
                        break;
                    }
                    if (currentStreak > 365) break; // защита от бесконечного цикла
                }
                
                const natureWalks = walks.filter(w => w.type === 'forest' || w.type === 'park' || w.location?.includes('лес') || w.location?.includes('парк')).length;
                const cityWalks = walks.filter(w => w.type === 'city').length;
                const sunriseWalks = walks.filter(w => w.timeOfDay === 'sunrise' || (new Date(w.date).getHours() >= 5 && new Date(w.date).getHours() < 8)).length;
                const sunsetWalks = walks.filter(w => w.timeOfDay === 'sunset' || (new Date(w.date).getHours() >= 17 && new Date(w.date).getHours() < 20)).length;
                
                return {
                    totalWalks: walks.length,
                    totalMinutes: walks.reduce((sum, w) => sum + (w.duration || 0), 0),
                    weekWalks: weekWalks.length,
                    weekMinutes: weekWalks.reduce((sum, w) => sum + (w.duration || 0), 0),
                    monthWalks: monthWalks.length,
                    monthMinutes: monthWalks.reduce((sum, w) => sum + (w.duration || 0), 0),
                    currentStreak,
                    averageDuration: walks.length > 0 ? Math.round(walks.reduce((sum, w) => sum + (w.duration || 0), 0) / walks.length) : 0,
                    natureWalks,
                    cityWalks,
                    sunriseWalks,
                    sunsetWalks,
                    lastWalk: walks.length > 0 ? walks[walks.length - 1] : null,
                    todayWalked: walks.some(w => {
                        const wDate = new Date(w.date);
                        const today = new Date();
                        return wDate.toDateString() === today.toDateString();
                    })
                };
            },
            getWalkGoal: () => DB.get('walk_goal', { dailyMinutes: 30, weeklyMinutes: 150 }),
            setWalkGoal: (goal) => DB.set('walk_goal', goal),
            // Планировщик бани
            getSaunaDay: () => DB.get('sauna_day', null), // 0-6 (Вс-Сб) или null
            setSaunaDay: (day) => DB.set('sauna_day', day),
            getSaunaHistory: () => DB.get('sauna_history', []),
            addSaunaVisit: (visit) => {
                const history = DB.getSaunaHistory();
                history.push({ ...visit, id: Date.now(), date: new Date().toISOString() });
                DB.set('sauna_history', history);
            },
            // Питание
            getNutritionProgress: () => DB.get('nutrition_progress', { startDate: null, currentDay: 0, completedDays: [], meals: [] }),
            setNutritionProgress: (progress) => DB.set('nutrition_progress', progress),
            startNutritionProgram: () => {
                DB.set('nutrition_progress', { 
                    startDate: new Date().toISOString(), 
                    currentDay: 1, 
                    completedDays: [], 
                    meals: [],
                    streak: 0
                });
            },
            logMeal: (meal) => {
                const progress = DB.getNutritionProgress();
                progress.meals.push({ ...meal, id: Date.now(), date: new Date().toISOString() });
                DB.setNutritionProgress(progress);
            },
            completeNutritionDay: (day) => {
                const progress = DB.getNutritionProgress();
                if (!progress.completedDays.includes(day)) {
                    progress.completedDays.push(day);
                    progress.currentDay = Math.max(progress.currentDay, day + 1);
                    progress.streak = progress.completedDays.length;
                }
                DB.setNutritionProgress(progress);
            },
            // PHQ-9 История
            getPhqHistory: () => DB.get('phq_history', []),
            addPhqResult: (score) => {
                const history = DB.getPhqHistory();
                history.push({ score, date: new Date().toISOString() });
                DB.set('phq_history', history);
                DB.set('last_phq_date', new Date().toISOString());
            },
            getLastPhqDate: () => DB.get('last_phq_date', null),
            shouldShowPhqReminder: () => {
                const lastDate = DB.getLastPhqDate();
                if (!lastDate) return true;
                const daysSince = Math.floor((Date.now() - new Date(lastDate).getTime()) / (1000 * 60 * 60 * 24));
                return daysSince >= 2;
            },
            // Рецепты
            getRecipes: () => DB.get('recipes', []),
            addRecipe: (recipe) => {
                const recipes = DB.getRecipes();
                recipes.unshift({ ...recipe, id: Date.now(), createdAt: new Date().toISOString() });
                DB.set('recipes', recipes);
                return recipes;
            },
            updateRecipe: (id, updates) => {
                const recipes = DB.getRecipes();
                const idx = recipes.findIndex(r => r.id === id);
                if (idx !== -1) {
                    recipes[idx] = { ...recipes[idx], ...updates };
                    DB.set('recipes', recipes);
                }
                return recipes;
            },
            deleteRecipe: (id) => {
                const recipes = DB.getRecipes().filter(r => r.id !== id);
                DB.set('recipes', recipes);
                return recipes;
            },
            // ═══════════════════════════════════════════════════════════════
            // ЧИСТАЯ АРХИТЕКТУРА: DOMAIN LAYER - Аналитика и корреляции
            // ═══════════════════════════════════════════════════════════════
            
            // Дерево души (метафора роста)
            getTreeState: () => DB.get('tree_state', { 
                level: 1, 
                growth: 0, 
                stage: 'seed', // seed, sprout, sapling, tree, flowering
                lastWatered: null,
                totalPractices: 0,
                totalWalks: 0,
                totalJournals: 0,
                streak: 0,
                fruits: []
            }),
            updateTree: (action) => {
                const tree = DB.getTreeState();
                const growthPoints = {
                    practice: 10,
                    walk: 15,
                    journal: 5,
                    ritual_morning: 20,
                    ritual_evening: 20,
                    meditation: 12,
                    bath: 25
                };
                
                tree.growth += growthPoints[action] || 5;
                tree.lastWatered = Date.now();
                
                if (action === 'practice') tree.totalPractices++;
                if (action === 'walk') tree.totalWalks++;
                if (action === 'journal') tree.totalJournals++;
                
                // Переход на следующий уровень
                const levelThresholds = [0, 100, 300, 600, 1000, 1500, 2000];
                const stages = ['seed', 'sprout', 'sapling', 'tree', 'flowering', 'garden'];
                
                for (let i = levelThresholds.length - 1; i >= 0; i--) {
                    if (tree.growth >= levelThresholds[i]) {
                        tree.level = i + 1;
                        tree.stage = stages[Math.min(i, stages.length - 1)];
                        break;
                    }
                }
                
                // Плоды за достижения
                if (tree.totalPractices === 10 && !tree.fruits.includes('first_10')) {
                    tree.fruits.push('first_10');
                }
                if (tree.totalWalks === 20 && !tree.fruits.includes('walker')) {
                    tree.fruits.push('walker');
                }
                
                DB.set('tree_state', tree);
                return tree;
            },
            
            // Ритуалы дня
            getRituals: () => DB.get('rituals', {
                morning: { enabled: true, time: '07:00', steps: ['breathing', 'water', 'state', 'practice', 'intention'] },
                evening: { enabled: true, time: '21:00', steps: ['release', 'gratitude', 'journal', 'warmth', 'sleep'] }
            }),
            setRituals: (rituals) => DB.set('rituals', rituals),
            getRitualHistory: () => DB.get('ritual_history', []),
            completeRitual: (type) => {
                const history = DB.getRitualHistory();
                history.push({ type, date: new Date().toISOString(), timestamp: Date.now() });
                if (history.length > 200) history.shift();
                DB.set('ritual_history', history);
                DB.updateTree('ritual_' + type);
                return history;
            },
            
            // Программы (курсы)
            getPrograms: () => DB.get('programs', {}),
            startProgram: (programId) => {
                const programs = DB.getPrograms();
                programs[programId] = { 
                    startedAt: new Date().toISOString(), 
                    currentDay: 1, 
                    completedDays: [],
                    paused: false
                };
                DB.set('programs', programs);
                return programs[programId];
            },
            completeProgramDay: (programId, day) => {
                const programs = DB.getPrograms();
                if (programs[programId]) {
                    if (!programs[programId].completedDays.includes(day)) {
                        programs[programId].completedDays.push(day);
                    }
                    programs[programId].currentDay = day + 1;
                    DB.set('programs', programs);
                }
                return programs[programId];
            },
            
            // Корреляции и инсайты
            getInsights: () => {
                const states = DB.getStateHistory();
                const practices = DB.getPracticeHistory();
                const walks = DB.getWalks();
                const phq = DB.getPhqHistory();
                const rituals = DB.getRitualHistory();
                
                const insights = [];
                
                // Анализ влияния практик на состояние
                if (practices.length >= 5 && states.length >= 5) {
                    const practiceEffects = {};
                    practices.forEach(p => {
                        const stateAfter = states.find(s => 
                            new Date(s.date).getTime() > new Date(p.date).getTime() &&
                            new Date(s.date).getTime() < new Date(p.date).getTime() + 24*60*60*1000
                        );
                        if (stateAfter) {
                            if (!practiceEffects[p.practiceId]) practiceEffects[p.practiceId] = [];
                            practiceEffects[p.practiceId].push(stateAfter.state);
                        }
                    });
                    
                    const goodStates = ['hopeful', 'light', 'neutral'];
                    Object.entries(practiceEffects).forEach(([practice, states]) => {
                        if (states.length >= 3) {
                            const goodCount = states.filter(s => goodStates.includes(s)).length;
                            const rate = goodCount / states.length;
                            if (rate > 0.7) {
                                insights.push({
                                    type: 'practice_effective',
                                    practice,
                                    message: `Практика "${practice}" часто улучшает ваше состояние`,
                                    confidence: rate
                                });
                            }
                        }
                    });
                }
                
                // Анализ влияния прогулок
                if (walks.length >= 5) {
                    const longWalks = walks.filter(w => w.duration >= 30);
                    if (longWalks.length >= 3) {
                        insights.push({
                            type: 'walk_duration',
                            message: 'Прогулки более 30 минут дают лучший эффект',
                            confidence: 0.8
                        });
                    }
                    
                    const natureWalks = walks.filter(w => w.type === 'forest' || w.type === 'park');
                    if (natureWalks.length >= 3) {
                        insights.push({
                            type: 'nature_benefit',
                            message: 'Прогулки на природе особенно полезны для вас',
                            confidence: 0.75
                        });
                    }
                }
                
                // Анализ ритуалов
                if (rituals.length >= 7) {
                    const morningCount = rituals.filter(r => r.type === 'morning').length;
                    const eveningCount = rituals.filter(r => r.type === 'evening').length;
                    
                    if (morningCount >= 5) {
                        insights.push({
                            type: 'ritual_morning',
                            message: 'Утренний ритуал стал вашей привычкой! Продолжайте.',
                            confidence: 0.9
                        });
                    }
                }
                
                // PHQ тренд
                if (phq.length >= 2) {
                    const recent = phq.slice(-3);
                    const trend = recent[recent.length - 1].score - recent[0].score;
                    if (trend < -3) {
                        insights.push({
                            type: 'phq_improving',
                            message: 'Ваше состояние улучшается! PHQ-9 снизился.',
                            confidence: 0.85
                        });
                    } else if (trend > 3) {
                        insights.push({
                            type: 'phq_warning',
                            message: 'Заметен рост PHQ-9. Возможно, нужна дополнительная поддержка.',
                            confidence: 0.8,
                            isWarning: true
                        });
                    }
                }
                
                return insights;
            },
            
            // Предиктивная система
            getPrediction: () => {
                const states = DB.getStateHistory();
                const phq = DB.getPhqHistory();
                
                if (states.length < 7) return null;
                
                const recentStates = states.slice(-7);
                const heavyCount = recentStates.filter(s => s.state === 'heavy' || s.state === 'low_energy').length;
                
                if (heavyCount >= 4) {
                    // Паттерн ухудшения
                    const previousDeclines = [];
                    // Ищем похожие паттерны в истории
                    for (let i = 7; i < states.length - 7; i++) {
                        const window = states.slice(i, i + 7);
                        const windowHeavy = window.filter(s => s.state === 'heavy' || s.state === 'low_energy').length;
                        if (windowHeavy >= 4) {
                            // Что помогло после этого?
                            const afterWindow = states.slice(i + 7, i + 14);
                            const improved = afterWindow.some(s => s.state === 'neutral' || s.state === 'hopeful');
                            if (improved) {
                                previousDeclines.push({ index: i, recovered: true });
                            }
                        }
                    }
                    
                    return {
                        type: 'decline_warning',
                        message: 'Ваш паттерн похож на начало прошлого спада',
                        recommendations: [
                            'Ежедневные прогулки хотя бы 20 минут',
                            'Тёплый душ или ванна перед сном',
                            'Согревающие практики',
                            'Снизить нагрузку где возможно'
                        ],
                        canRecover: previousDeclines.length > 0
                    };
                }
                
                return null;
            },
            
            // Кризисный план
            getCrisisPlan: () => DB.get('crisis_plan', {
                contacts: [],
                triggers: [],
                copingStrategies: [],
                safePlace: '',
                emergencyNumbers: [
                    { name: 'Телефон доверия', number: '8-800-2000-122' },
                    { name: 'Психологическая помощь', number: '051' }
                ]
            }),
            setCrisisPlan: (plan) => DB.set('crisis_plan', plan),
            
            // Статистика для аналитики
            getAnalytics: () => {
                const states = DB.getStateHistory();
                const practices = DB.getPracticeHistory();
                const walks = DB.getWalks();
                const phq = DB.getPhqHistory();
                const rituals = DB.getRitualHistory();
                const tree = DB.getTreeState();
                
                const now = Date.now();
                const weekAgo = now - 7 * 24 * 60 * 60 * 1000;
                const monthAgo = now - 30 * 24 * 60 * 60 * 1000;
                
                const weekStates = states.filter(s => new Date(s.date).getTime() > weekAgo);
                const monthStates = states.filter(s => new Date(s.date).getTime() > monthAgo);
                const weekPractices = practices.filter(p => new Date(p.date).getTime() > weekAgo);
                const monthPractices = practices.filter(p => new Date(p.date).getTime() > monthAgo);
                const weekRituals = rituals.filter(r => r.timestamp > weekAgo);
                
                // Подсчёт состояний
                const stateCount = {};
                monthStates.forEach(s => {
                    stateCount[s.state] = (stateCount[s.state] || 0) + 1;
                });
                
                // Лучшие практики
                const practiceCount = {};
                monthPractices.forEach(p => {
                    practiceCount[p.practiceId] = (practiceCount[p.practiceId] || 0) + 1;
                });
                const topPractices = Object.entries(practiceCount)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);
                
                return {
                    tree,
                    weekPractices: weekPractices.length,
                    monthPractices: monthPractices.length,
                    weekRituals: weekRituals.length,
                    stateDistribution: stateCount,
                    topPractices,
                    phqTrend: phq.slice(-5),
                    totalDays: Math.ceil((now - (states[0]?.timestamp || now)) / (24*60*60*1000)),
                    insights: DB.getInsights(),
                    prediction: DB.getPrediction()
                };
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // ЧИСТАЯ АРХИТЕКТУРА: DOMAIN LAYER - Программы и ритуалы
        // ═══════════════════════════════════════════════════════════════
        
        const PROGRAMS = {
            light_exit: {
                id: 'light_exit',
                title: 'Выход к свету',
                subtitle: 'Программа для тяжёлых состояний',
                icon: '🌅',
                duration: 21,
                description: 'Мягкая 21-дневная программа для постепенного выхода из тяжёлого состояния',
                forStates: ['heavy', 'low_energy'],
                days: [
                    { day: 1, title: 'Признание', focus: 'Признать своё состояние без осуждения', practices: ['breathing_calm', 'warm_feet'], tip: 'Сегодня только одно: быть добрым к себе' },
                    { day: 2, title: 'Тело', focus: 'Вспомнить о теле', practices: ['warm_shower', 'breathing_calm'], tip: 'Тело — ваш союзник' },
                    { day: 3, title: 'Тепло', focus: 'Согреться изнутри и снаружи', practices: ['warm_feet', 'tea_ritual'], tip: 'Тепло лечит' },
                    { day: 4, title: 'Дыхание', focus: 'Углубить дыхание', practices: ['breathing_calm', 'breathing_energy'], tip: 'Дыхание — мост к покою' },
                    { day: 5, title: 'Движение', focus: 'Мягкое движение', practices: ['walk_simple', 'stretching'], tip: 'Любое движение — победа' },
                    { day: 6, title: 'Свет', focus: 'Впустить свет', practices: ['light_morning', 'walk_simple'], tip: 'Свет влияет на химию мозга' },
                    { day: 7, title: 'Отдых', focus: 'Позволить себе отдохнуть', practices: ['sleep_prep', 'gratitude'], tip: 'Вы прошли неделю!' },
                    { day: 8, title: 'Благодарность', focus: 'Найти за что благодарить', practices: ['gratitude', 'journaling'], tip: 'Даже маленькое — считается' },
                    { day: 9, title: 'Природа', focus: 'Связь с природой', practices: ['walk_nature', 'grounding'], tip: 'Природа исцеляет' },
                    { day: 10, title: 'Вода', focus: 'Очищение водой', practices: ['contrast_shower', 'hydration'], tip: 'Вода — жизнь' },
                    { day: 11, title: 'Еда', focus: 'Осознанное питание', practices: ['mindful_eating', 'meal_prep'], tip: 'Еда — это забота о себе' },
                    { day: 12, title: 'Ритм', focus: 'Найти свой ритм', practices: ['morning_ritual', 'evening_ritual'], tip: 'Ритуалы создают опору' },
                    { day: 13, title: 'Творчество', focus: 'Выразить себя', practices: ['watercolor_emotion', 'journaling'], tip: 'Творчество освобождает' },
                    { day: 14, title: 'Радость', focus: 'Маленькие радости', practices: ['pleasure_list', 'walk_beauty'], tip: 'Вы на полпути!' },
                    { day: 15, title: 'Связь', focus: 'Связь с другими', practices: ['reach_out', 'gratitude'], tip: 'Вы не одиноки' },
                    { day: 16, title: 'Прощение', focus: 'Отпустить прошлое', practices: ['forgiveness', 'breathing_release'], tip: 'Прощение освобождает вас' },
                    { day: 17, title: 'Ценности', focus: 'Вспомнить что важно', practices: ['values_reflection', 'journaling'], tip: 'Ценности — ваш компас' },
                    { day: 18, title: 'Сила', focus: 'Вспомнить свою силу', practices: ['strength_recall', 'affirmations'], tip: 'Вы сильнее, чем думаете' },
                    { day: 19, title: 'Мечты', focus: 'Позволить себе мечтать', practices: ['vision_board', 'journaling'], tip: 'Мечты — дорога к свету' },
                    { day: 20, title: 'План', focus: 'Маленькие шаги вперёд', practices: ['action_plan', 'commitment'], tip: 'Один шаг за раз' },
                    { day: 21, title: 'Свет', focus: 'Вы — свет', practices: ['celebration', 'gratitude', 'intention'], tip: '🎉 Вы прошли программу!' }
                ]
            },
            anxiety_taming: {
                id: 'anxiety_taming',
                title: 'Укрощение тревоги',
                subtitle: '14 дней работы с тревогой',
                icon: '🦋',
                duration: 14,
                description: 'Программа для тех, кто хочет научиться управлять тревогой',
                forStates: ['anxious'],
                days: [
                    { day: 1, title: 'Узнавание', focus: 'Познакомиться с тревогой', practices: ['anxiety_education', 'breathing_478'], tip: 'Тревога — это сигнал, не враг' },
                    { day: 2, title: 'Дыхание', focus: 'Дыхание как инструмент', practices: ['breathing_478', 'breathing_box'], tip: 'Дыхание всегда с вами' },
                    { day: 3, title: 'Тело', focus: 'Где тревога в теле?', practices: ['body_scan', 'tension_release'], tip: 'Тело помнит всё' },
                    { day: 4, title: 'Заземление', focus: '5-4-3-2-1', practices: ['grounding_senses', 'cold_water'], tip: 'Вернуться в здесь и сейчас' },
                    { day: 5, title: 'Мысли', focus: 'Мысли — не факты', practices: ['thought_defusion', 'journaling'], tip: 'Вы не ваши мысли' },
                    { day: 6, title: 'Принятие', focus: 'Не бороться, а принять', practices: ['acceptance', 'self_compassion'], tip: 'Сопротивление усиливает' },
                    { day: 7, title: 'Итоги', focus: 'Что работает для вас?', practices: ['reflection', 'toolkit'], tip: 'Первая неделя позади!' },
                    { day: 8, title: 'Триггеры', focus: 'Знать свои триггеры', practices: ['trigger_mapping', 'journaling'], tip: 'Знание — сила' },
                    { day: 9, title: 'Границы', focus: 'Защита своего покоя', practices: ['boundary_setting', 'saying_no'], tip: 'Нет — полное предложение' },
                    { day: 10, title: 'Движение', focus: 'Тревога любит застой', practices: ['walk_brisk', 'shake_it'], tip: 'Движение освобождает' },
                    { day: 11, title: 'Природа', focus: 'Исцеление природой', practices: ['forest_bathing', 'nature_sounds'], tip: 'Природа успокаивает' },
                    { day: 12, title: 'Сон', focus: 'Качественный сон', practices: ['sleep_hygiene', 'evening_ritual'], tip: 'Сон — фундамент' },
                    { day: 13, title: 'План', focus: 'Ваш антитревожный план', practices: ['coping_plan', 'emergency_kit'], tip: 'Подготовка = спокойствие' },
                    { day: 14, title: 'Мастерство', focus: 'Вы справляетесь!', practices: ['celebration', 'maintenance'], tip: '🎉 Программа завершена!' }
                ]
            },
            melancholic_warmth: {
                id: 'melancholic_warmth',
                title: 'Согревание души',
                subtitle: 'Для меланхолического темперамента',
                icon: '🔥',
                duration: 14,
                description: 'Специальная программа согревающих практик для меланхоликов',
                forTemperament: 'melancholic',
                days: [
                    { day: 1, title: 'Тёплое начало', focus: 'Впустить тепло', practices: ['warm_feet', 'tea_ritual'], tip: 'Тепло — ваше лекарство' },
                    { day: 2, title: 'Утренний свет', focus: 'Свет как витамин', practices: ['light_morning', 'warm_breakfast'], tip: 'Свет запускает день' },
                    { day: 3, title: 'Движение', focus: 'Мягкое тепло движения', practices: ['walk_slow', 'stretching'], tip: 'Тело создаёт тепло' },
                    { day: 4, title: 'Дыхание огня', focus: 'Согреться дыханием', practices: ['breathing_fire', 'warm_shower'], tip: 'Дыхание разжигает огонь' },
                    { day: 5, title: 'Питание', focus: 'Согревающая еда', practices: ['warm_meal', 'spices'], tip: 'Имбирь, корица, перец' },
                    { day: 6, title: 'Баня', focus: 'Глубокое прогревание', practices: ['sauna', 'tea_after'], tip: 'Баня — русская терапия' },
                    { day: 7, title: 'Интеграция', focus: 'Сохранить тепло', practices: ['warm_routine', 'gratitude'], tip: 'Первая неделя!' },
                    { day: 8, title: 'Цвета', focus: 'Тёплые цвета', practices: ['watercolor_warm', 'color_therapy'], tip: 'Оранжевый, жёлтый, красный' },
                    { day: 9, title: 'Масла', focus: 'Согревающие ароматы', practices: ['oil_massage', 'aromatherapy'], tip: 'Имбирь, корица, апельсин' },
                    { day: 10, title: 'Общение', focus: 'Тепло близких', practices: ['warm_connection', 'hug_practice'], tip: 'Люди согревают душу' },
                    { day: 11, title: 'Творчество', focus: 'Огонь творчества', practices: ['creative_fire', 'journaling'], tip: 'Творить = гореть' },
                    { day: 12, title: 'Природа', focus: 'Солнце и земля', practices: ['sun_gazing', 'earthing'], tip: 'Природное тепло' },
                    { day: 13, title: 'Ритуал', focus: 'Ваш тёплый ритуал', practices: ['personal_ritual', 'fire_meditation'], tip: 'Создайте свой ритуал' },
                    { day: 14, title: 'Внутренний огонь', focus: 'Огонь внутри вас', practices: ['inner_fire', 'celebration'], tip: '🔥 Вы согрелись!' }
                ]
            },
            deep_sleep: {
                id: 'deep_sleep',
                title: 'Глубокий сон',
                subtitle: '7 дней для качественного сна',
                icon: '🌙',
                duration: 7,
                description: 'Программа для улучшения качества сна',
                forStates: ['anxious', 'heavy'],
                days: [
                    { day: 1, title: 'Аудит сна', focus: 'Понять свой сон', practices: ['sleep_audit', 'journaling'], tip: 'Осознанность — первый шаг' },
                    { day: 2, title: 'Вечерний ритуал', focus: 'Подготовка ко сну', practices: ['evening_ritual', 'screen_off'], tip: 'Ритуал = сигнал телу' },
                    { day: 3, title: 'Тело', focus: 'Расслабить тело', practices: ['body_scan', 'warm_bath'], tip: 'Тепло → расслабление' },
                    { day: 4, title: 'Разум', focus: 'Успокоить мысли', practices: ['thought_release', 'journaling'], tip: 'Выгрузить мысли на бумагу' },
                    { day: 5, title: 'Среда', focus: 'Спальня для сна', practices: ['room_optimization', 'darkness'], tip: 'Темно, прохладно, тихо' },
                    { day: 6, title: 'Ритм', focus: 'Циркадные ритмы', practices: ['light_schedule', 'consistent_time'], tip: 'Тело любит ритм' },
                    { day: 7, title: 'Мастерство', focus: 'Ваша формула сна', practices: ['sleep_formula', 'commitment'], tip: '🌙 Сладких снов!' }
                ]
            }
        };
        
        const RITUALS = {
            morning: {
                id: 'morning',
                title: 'Утренний ритуал',
                icon: '☀️',
                description: 'Осознанное начало дня',
                duration: '10-20 мин',
                steps: [
                    { id: 'breathing', title: 'Дыхание благодарности', duration: 2, description: 'Три глубоких вдоха с благодарностью за новый день' },
                    { id: 'water', title: 'Стакан тёплой воды', duration: 1, description: 'Пробудить тело изнутри' },
                    { id: 'state', title: 'Проверка состояния', duration: 1, description: 'Как я себя чувствую?' },
                    { id: 'practice', title: 'Практика по состоянию', duration: 10, description: 'Подобранная практика' },
                    { id: 'intention', title: 'Намерение на день', duration: 2, description: 'Каким я хочу быть сегодня?' }
                ]
            },
            evening: {
                id: 'evening',
                title: 'Вечерний ритуал',
                icon: '🌙',
                description: 'Мягкое завершение дня',
                duration: '15-25 мин',
                steps: [
                    { id: 'release', title: 'Отпускание дня', duration: 3, description: 'Что я отпускаю сегодня?' },
                    { id: 'gratitude', title: 'Три благодарности', duration: 3, description: 'За что я благодарен?' },
                    { id: 'journal', title: 'Запись в дневник', duration: 5, description: 'Мысли, чувства, инсайты' },
                    { id: 'warmth', title: 'Тёплый ритуал', duration: 10, description: 'Душ, ванна или тёплые ноги' },
                    { id: 'sleep', title: 'Подготовка ко сну', duration: 5, description: 'Дыхание, расслабление' }
                ]
            }
        };
        
        // Новые практики для акварели с уточнением
        const WATERCOLOR_PRACTICES = [
            { 
                id: 'watercolor_warmth', 
                category: 'watercolor', 
                title: 'Тёплые цвета', 
                short: 'Согревающая практика акварелью', 
                steps: [
                    'Подготовьте акварельные краски тёплых тонов',
                    'Вам понадобятся: красный, оранжевый, жёлтый, охра',
                    'Смочите бумагу тёплой водой',
                    'Начните с жёлтого в центре листа',
                    'Добавляйте оранжевый вокруг',
                    'Красный — на краях',
                    'Дайте цветам свободно перетекать',
                    'Наблюдайте за теплом на бумаге',
                    'Почувствуйте тепло внутри себя'
                ], 
                duration: 25, 
                bg: '#FFE4C9', 
                states: ['heavy', 'low_energy'] 
            },
            { 
                id: 'watercolor_calm', 
                category: 'watercolor', 
                title: 'Спокойное море', 
                short: 'Успокаивающая акварельная медитация', 
                steps: [
                    'Подготовьте акварельные краски холодных тонов',
                    'Синий, голубой, бирюзовый, фиолетовый',
                    'Смочите бумагу — это будет море',
                    'Нанесите светло-голубой вверху — небо',
                    'Добавьте глубокий синий внизу — вода',
                    'Позвольте цветам встретиться на горизонте',
                    'Добавьте белые блики — волны',
                    'Дышите медленно, как волны',
                    'Море успокаивает разум'
                ], 
                duration: 20, 
                bg: '#E0F2FE', 
                states: ['anxious', 'neutral'] 
            }
        ];

        // ═══════════════════════════════════════════════════════════════
        // АНТРОПОСОФИЯ
        // ═══════════════════════════════════════════════════════════════
        
        // Тест на определение темперамента
        const TEMPERAMENT_TEST = {
            questions: [
                {
                    text: 'Как вы обычно реагируете на новые идеи?',
                    answers: [
                        { text: 'Загораюсь энтузиазмом, сразу хочу попробовать', type: 'sanguine' },
                        { text: 'Быстро оцениваю и действую, если вижу пользу', type: 'choleric' },
                        { text: 'Глубоко обдумываю, взвешиваю все за и против', type: 'melancholic' },
                        { text: 'Спокойно принимаю к сведению, не тороплюсь', type: 'phlegmatic' }
                    ]
                },
                {
                    text: 'Как вы ведёте себя в компании?',
                    answers: [
                        { text: 'Общителен(ьна), легко знакомлюсь, много шучу', type: 'sanguine' },
                        { text: 'Часто беру инициативу, организую, веду за собой', type: 'choleric' },
                        { text: 'Предпочитаю глубокие разговоры с близкими', type: 'melancholic' },
                        { text: 'Наблюдаю, слушаю, включаюсь когда нужно', type: 'phlegmatic' }
                    ]
                },
                {
                    text: 'Как вы переживаете неудачи?',
                    answers: [
                        { text: 'Быстро расстраиваюсь, но быстро отхожу', type: 'sanguine' },
                        { text: 'Злюсь, но это даёт энергию исправить ситуацию', type: 'choleric' },
                        { text: 'Долго переживаю, анализирую, что пошло не так', type: 'melancholic' },
                        { text: 'Принимаю спокойно, не драматизирую', type: 'phlegmatic' }
                    ]
                },
                {
                    text: 'Какой темп жизни вам ближе?',
                    answers: [
                        { text: 'Быстрый, разнообразный, много всего сразу', type: 'sanguine' },
                        { text: 'Интенсивный, целеустремлённый, результативный', type: 'choleric' },
                        { text: 'Размеренный, с временем для глубины и рефлексии', type: 'melancholic' },
                        { text: 'Спокойный, стабильный, без спешки', type: 'phlegmatic' }
                    ]
                },
                {
                    text: 'Что вас больше всего заряжает энергией?',
                    answers: [
                        { text: 'Общение, новые впечатления, смена обстановки', type: 'sanguine' },
                        { text: 'Достижение целей, преодоление препятствий', type: 'choleric' },
                        { text: 'Творчество, искусство, глубокие переживания', type: 'melancholic' },
                        { text: 'Уединение, природа, спокойные занятия', type: 'phlegmatic' }
                    ]
                },
                {
                    text: 'Как вы принимаете решения?',
                    answers: [
                        { text: 'Быстро, по наитию, доверяю чувствам', type: 'sanguine' },
                        { text: 'Решительно, ориентируясь на результат', type: 'choleric' },
                        { text: 'Тщательно обдумываю, взвешиваю последствия', type: 'melancholic' },
                        { text: 'Не тороплюсь, даю ситуации созреть', type: 'phlegmatic' }
                    ]
                },
                {
                    text: 'Как вы относитесь к рутине?',
                    answers: [
                        { text: 'Скучаю, нужно разнообразие и новизна', type: 'sanguine' },
                        { text: 'Терплю, если она ведёт к цели', type: 'choleric' },
                        { text: 'Могу погрузиться, если дело имеет смысл', type: 'melancholic' },
                        { text: 'Комфортна, создаёт ощущение стабильности', type: 'phlegmatic' }
                    ]
                },
                {
                    text: 'Какие эмоции вы чаще испытываете?',
                    answers: [
                        { text: 'Радость, оптимизм, воодушевление', type: 'sanguine' },
                        { text: 'Азарт, решимость, иногда раздражение', type: 'choleric' },
                        { text: 'Глубокие чувства, иногда грусть и тоску', type: 'melancholic' },
                        { text: 'Спокойствие, умиротворение, равновесие', type: 'phlegmatic' }
                    ]
                },
                {
                    text: 'Как вы восстанавливаетесь после стресса?',
                    answers: [
                        { text: 'Общаюсь с друзьями, развлекаюсь, переключаюсь', type: 'sanguine' },
                        { text: 'Занимаюсь спортом или активной деятельностью', type: 'choleric' },
                        { text: 'Уединяюсь, слушаю музыку, размышляю', type: 'melancholic' },
                        { text: 'Отдыхаю, сплю, занимаюсь спокойными делами', type: 'phlegmatic' }
                    ]
                },
                {
                    text: 'Как вы относитесь к переменам?',
                    answers: [
                        { text: 'Люблю! Перемены — это интересно', type: 'sanguine' },
                        { text: 'Принимаю, если они ведут к улучшению', type: 'choleric' },
                        { text: 'Осторожно, нужно время адаптироваться', type: 'melancholic' },
                        { text: 'Предпочитаю стабильность, но адаптируюсь', type: 'phlegmatic' }
                    ]
                },
                {
                    text: 'Какое время суток вам ближе?',
                    answers: [
                        { text: 'День — время активности и общения', type: 'sanguine' },
                        { text: 'Утро — энергичный старт дня', type: 'choleric' },
                        { text: 'Вечер или ночь — время для глубины', type: 'melancholic' },
                        { text: 'Любое, когда можно спокойно заниматься делами', type: 'phlegmatic' }
                    ]
                },
                {
                    text: 'Как вы относитесь к конфликтам?',
                    answers: [
                        { text: 'Стараюсь сгладить, перевести в шутку', type: 'sanguine' },
                        { text: 'Вступаю, отстаиваю свою позицию', type: 'choleric' },
                        { text: 'Избегаю, но глубоко переживаю', type: 'melancholic' },
                        { text: 'Сохраняю спокойствие, ищу компромисс', type: 'phlegmatic' }
                    ]
                }
            ],
            
            getDescription: (type) => {
                const descriptions = {
                    sanguine: {
                        title: 'Сангвиник',
                        icon: '🌞',
                        element: 'Воздух',
                        color: '#FCD34D',
                        strengths: ['Оптимизм и жизнерадостность', 'Лёгкость в общении', 'Быстрая адаптация', 'Творческое мышление'],
                        challenges: ['Развивайте способность погружаться глубже в темы и отношения', 'Практикуйте завершение начатых дел — это приносит удовлетворение', 'Находите ценность в тишине и уединении'],
                        practices: ['Акварель', 'Прогулки', 'Дыхательные практики'],
                        tip: 'Развивайте глубину через дневник и медитацию'
                    },
                    choleric: {
                        title: 'Холерик',
                        icon: '🔥',
                        element: 'Огонь',
                        color: '#F97316',
                        strengths: ['Энергичность и решительность', 'Лидерские качества', 'Целеустремлённость', 'Способность вести за собой'],
                        challenges: ['Учитесь делать паузы — они усиливают ваши решения', 'Терпение — это суперсила, которую вы можете развить', 'Восстановление так же важно, как и действие'],
                        practices: ['Активные прогулки', 'Баня', 'Практики присутствия'],
                        tip: 'Практикуйте паузы и осознанность для баланса'
                    },
                    melancholic: {
                        title: 'Меланхолик',
                        icon: '🌙',
                        element: 'Земля',
                        color: '#8B5CF6',
                        strengths: ['Глубина чувств', 'Творческая чувствительность', 'Эмпатия', 'Способность к рефлексии'],
                        challenges: ['Ваша глубина — дар; добавляйте к ней свет и движение', 'Относитесь к себе с той же добротой, что и к другим', 'Позволяйте себе моменты лёгкости и игры'],
                        practices: ['Свет', 'Тепло', 'Благодарность', 'Чудо дня'],
                        tip: 'Добавляйте света и тепла, практикуйте благодарность'
                    },
                    phlegmatic: {
                        title: 'Флегматик',
                        icon: '💧',
                        element: 'Вода',
                        color: '#06B6D4',
                        strengths: ['Спокойствие и уравновешенность', 'Надёжность', 'Терпение', 'Устойчивость к стрессу'],
                        challenges: ['Ваш темп — это сила; иногда стоит добавить ускорения', 'Новые начинания приносят свежую энергию', 'Маленькие шаги каждый день создают большие перемены'],
                        practices: ['Активные прогулки', 'Массаж', 'Дыхание'],
                        tip: 'Добавляйте активности и разнообразия в жизнь'
                    }
                };
                return descriptions[type];
            }
        };
        
        const NATURAL_WISDOM = {
            temperaments: {
                sanguine: { id: 'sanguine', name: 'Сангвиник', element: 'Воздух', icon: '🌬️', color: '#F6C445', practices: ['breathing', 'gratitude'], description: 'Воздушный, лёгкий темперамент' },
                choleric: { id: 'choleric', name: 'Холерик', element: 'Огонь', icon: '🔥', color: '#E85D04', practices: ['warmth_heart', 'antifragile'], description: 'Огненный, волевой темперамент' },
                melancholic: { id: 'melancholic', name: 'Меланхолик', element: 'Земля', icon: '🌍', color: '#6B5B8C', practices: ['light_morning', 'color_gold'], description: 'Земной, глубокий темперамент' },
                phlegmatic: { id: 'phlegmatic', name: 'Флегматик', element: 'Вода', icon: '💧', color: '#4A6FA5', practices: ['warmth_tea', 'warmth_footbath'], description: 'Водный, спокойный темперамент' }
            },
            naturalDays: {
                0: { theme: 'Свет', name: 'Вс', icon: '☀️', color: '#F6C445', oils: ['апельсин', 'ладан', 'бергамот'], oilEffect: 'Радость и свет' },
                1: { theme: 'Вода', name: 'Пн', icon: '💧', color: '#60A5FA', oils: ['лаванда', 'ромашка', 'мелисса'], oilEffect: 'Покой и обновление' },
                2: { theme: 'Огонь', name: 'Вт', icon: '🔥', color: '#DC2626', oils: ['розмарин', 'имбирь'], oilEffect: 'Энергия и сила' },
                3: { theme: 'Воздух', name: 'Ср', icon: '🌬️', color: '#F59E0B', oils: ['мята', 'эвкалипт', 'лимон'], oilEffect: 'Ясность и лёгкость' },
                4: { theme: 'Дерево', name: 'Чт', icon: '🌳', color: '#22C55E', oils: ['кедр', 'сандал', 'пихта'], oilEffect: 'Рост и мудрость' },
                5: { theme: 'Цветение', name: 'Пт', icon: '🌸', color: '#EC4899', oils: ['роза', 'герань'], oilEffect: 'Гармония и красота' },
                6: { theme: 'Земля', name: 'Сб', icon: '🪨', color: '#78716C', oils: ['кипарис', 'можжевельник'], oilEffect: 'Глубина и корни' }
            },
            oilsByMood: {
                heavy: { oils: ['апельсин', 'грейпфрут', 'бергамот'], effect: 'Поднимают настроение' },
                low_energy: { oils: ['розмарин', 'мята', 'эвкалипт'], effect: 'Пробуждают энергию' },
                anxious: { oils: ['лаванда', 'ромашка', 'мелисса'], effect: 'Успокаивают' },
                neutral: { oils: ['кедр', 'сандал', 'ладан'], effect: 'Углубляют осознанность' },
                hopeful: { oils: ['герань', 'роза'], effect: 'Укрепляют надежду' },
                grateful: { oils: ['ладан', 'мирра', 'роза'], effect: 'Углубляют благодарность' },
                light: { oils: ['апельсин', 'лимон', 'мандарин'], effect: 'Усиливают радость' }
            },
            getCurrentRhythm: () => {
                const hour = new Date().getHours();
                if (hour >= 6 && hour < 9) return { name: 'Утро', quality: 'Пробуждение', key: 'morning' };
                if (hour >= 9 && hour < 12) return { name: 'Позднее утро', quality: 'Мышление', key: 'lateMorning' };
                if (hour >= 12 && hour < 15) return { name: 'Полдень', quality: 'Воля', key: 'midday' };
                if (hour >= 15 && hour < 18) return { name: 'День', quality: 'Социальное', key: 'afternoon' };
                if (hour >= 18 && hour < 21) return { name: 'Вечер', quality: 'Чувства', key: 'evening' };
                if (hour >= 21 || hour < 3) return { name: 'Ночь', quality: 'Покой', key: 'night' };
                return { name: 'Предрассвет', quality: 'Духовное', key: 'preDown' };
            },
            getNaturalDay: () => NATURAL_WISDOM.naturalDays[new Date().getDay()],
            analyzeStateHistory: (history) => {
                if (!history || history.length === 0) return null;
                const last7Days = history.filter(h => Date.now() - h.timestamp < 7 * 24 * 60 * 60 * 1000);
                const stateCounts = {};
                last7Days.forEach(h => { stateCounts[h.state] = (stateCounts[h.state] || 0) + 1; });
                const dominantState = Object.entries(stateCounts).sort((a, b) => b[1] - a[1])[0]?.[0];
                let trend = 'stable';
                if (last7Days.length >= 3) {
                    const stateValues = { heavy: 1, low_energy: 2, anxious: 3, neutral: 4, hopeful: 5, grateful: 6, light: 7 };
                    const recent = last7Days.slice(-3).map(h => stateValues[h.state] || 4);
                    const earlier = last7Days.slice(0, 3).map(h => stateValues[h.state] || 4);
                    const recentAvg = recent.reduce((a, b) => a + b, 0) / recent.length;
                    const earlierAvg = earlier.reduce((a, b) => a + b, 0) / earlier.length;
                    if (recentAvg > earlierAvg + 0.5) trend = 'improving';
                    else if (recentAvg < earlierAvg - 0.5) trend = 'declining';
                }
                return { totalEntries: last7Days.length, dominantState, trend };
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // ДАННЫЕ
        // ═══════════════════════════════════════════════════════════════
        
        const SOUL_STATES = [
            { id: 'heavy', emoji: '🌑', label: 'Тяжело' },
            { id: 'low_energy', emoji: '🌒', label: 'Мало сил' },
            { id: 'anxious', emoji: '🌓', label: 'Тревога' },
            { id: 'neutral', emoji: '🌔', label: 'Спокойно' },
            { id: 'hopeful', emoji: '🌕', label: 'Надежда' },
            { id: 'grateful', emoji: '🌟', label: 'Благодарность' },
            { id: 'light', emoji: '☀️', label: 'Светло' }
        ];

        const CATEGORIES = [
            { id: 'light', name: 'Свет', icon: '☀️' },
            { id: 'warmth', name: 'Тепло', icon: '🔥' },
            { id: 'spa', name: 'СПА', icon: '🛁' },
            { id: 'watercolor', name: 'Акварель', icon: '🎨', description: 'Терапия акварельными красками по Гёте' },
            { id: 'walk', name: 'Прогулки', icon: '🚶' },
            { id: 'breathing', name: 'Дыхание', icon: '🌬️' },
            { id: 'body', name: 'Тело', icon: '🧘' },
            { id: 'nondual', name: 'Присутствие', icon: '✨' },
            { id: 'gratitude', name: 'Благодарность', icon: '🙏' },
            { id: 'journal', name: 'Дневник', icon: '📝' }
        ];
        
        // ═══════════════════════════════════════════════════════════════
        // СИСТЕМА АДАПТИВНОЙ МОТИВАЦИИ
        // На основе лучших практик психологии (КПТ, ACT, MBCT)
        // ═══════════════════════════════════════════════════════════════
        
        // Описания практик для первого использования
        const PRACTICE_DESCRIPTIONS = {
            breathing: {
                title: 'Якорное дыхание',
                essence: 'Дыхание — это мост между телом и умом. Когда мы направляем внимание на дыхание, мы возвращаемся в настоящий момент, где нет прошлого и будущего, а есть только «здесь и сейчас».',
                science: 'Медленное дыхание активирует парасимпатическую нервную систему, снижая уровень кортизола и адреналина.',
                whatToExpect: 'Не нужно ничего особенного чувствовать. Просто наблюдай за дыханием. Если ум уходит — это нормально, мягко возвращай внимание.',
                firstTime: true
            },
            walk_forest: {
                title: 'Лесная прогулка',
                essence: 'Японская практика «синрин-йоку» (лесное купание) показала, что даже 20 минут среди деревьев снижают уровень стресса. Лес не требует от нас ничего — он просто принимает.',
                science: 'Фитонциды деревьев укрепляют иммунитет, а зелёный цвет успокаивает нервную систему.',
                whatToExpect: 'Не нужно идти быстро или далеко. Просто побудь среди деревьев. Прислушайся, понюхай, прикоснись к коре.',
                firstTime: true
            },
            walk_observe: {
                title: 'Осознанная прогулка',
                essence: 'Это практика присутствия в движении. Обычно мы ходим "на автопилоте", думая о чём-то другом. Осознанная прогулка — это возможность вернуться в тело и мир вокруг.',
                science: 'Осознанное движение снижает руминацию (навязчивые негативные мысли) на 25%.',
                whatToExpect: 'Иди медленнее обычного. Замечай ощущения в стопах, движение воздуха, цвета и звуки. Когда ум уходит — возвращай внимание.',
                firstTime: true
            },
            walk_beauty: {
                title: 'Поиск красоты',
                essence: 'Эта практика тренирует "мышцу внимания" к позитивному. При депрессии мозг склонен фильтровать негатив. Мы сознательно переключаем фокус на красивое.',
                science: 'Позитивная психология показывает: намеренный поиск красоты повышает субъективное благополучие.',
                whatToExpect: 'Поставь цель: найти 5 красивых вещей. Это может быть что угодно — облако, цветок, улыбка, узор на стене.',
                firstTime: true
            },
            mbct_bodyscan: {
                title: 'Сканирование тела',
                essence: 'Тело хранит эмоции. Часто мы не замечаем напряжения, пока оно не превратится в боль. Сканирование тела — это способ "услышать" своё тело до того, как оно закричит.',
                science: 'Практика из MBCT (когнитивная терапия на основе осознанности), доказавшая эффективность в предотвращении рецидивов депрессии.',
                whatToExpect: 'Лёжа, медленно перемещай внимание от стоп к голове. Не пытайся расслабиться — просто наблюдай.',
                firstTime: true
            },
            gratitude: {
                title: 'Практика благодарности',
                essence: 'Благодарность — это не отрицание проблем, а расширение взгляда. Мы тренируемся замечать то хорошее, что уже есть, не игнорируя трудности.',
                science: 'Исследования показывают: 3 недели ежедневной благодарности значимо повышают уровень счастья.',
                whatToExpect: 'Найди 3 вещи, за которые благодарен сегодня. Они могут быть маленькими: тёплый чай, мягкая подушка, звонок друга.',
                firstTime: true
            },
            nondual_presence: {
                title: 'Чистое присутствие',
                essence: 'Это практика из недуальных традиций. Мы отдыхаем как само осознавание, не цепляясь за мысли и не отталкивая их. Просто открытость тому, что есть.',
                science: 'Состояние "открытого осознавания" связано с активацией дефолтной сети мозга в расслабленном режиме.',
                whatToExpect: 'Не нужно ничего делать или достигать. Просто побудь. Замечай звуки, ощущения, мысли — без оценки.',
                firstTime: true
            },
            loving_kindness: {
                title: 'Любящая доброта (Метта)',
                essence: 'Древняя буддийская практика развития безусловной любви — сначала к себе, потом к близким, затем ко всем существам. Особенно важна для тех, кто склонен к самокритике.',
                science: 'Исследования показывают увеличение позитивных эмоций и уменьшение самокритики после 7 дней практики.',
                whatToExpect: 'Начни с себя. Повторяй: "Пусть я буду счастлив(а), здоров(а), в безопасности". Чувствовать что-то особенное не обязательно.',
                firstTime: true
            },
            sauna: {
                title: 'Посещение бани',
                essence: 'Баня — это ритуал очищения тела и души. Жар расслабляет мышцы, выводит токсины, а контраст температур тонизирует сосуды и нервную систему.',
                science: 'Регулярная баня снижает риск депрессии на 33% (финские исследования).',
                whatToExpect: 'Не торопись. Первый заход короткий (5-7 минут). Пей воду. Слушай своё тело.',
                firstTime: true
            },
            journal_deep: {
                title: 'Глубокое письмо',
                essence: 'Письмо — способ "выгрузить" мысли из головы на бумагу. Когда мы пишем, мы структурируем хаос внутри. Это не дневник событий — это исследование внутреннего мира.',
                science: 'Экспрессивное письмо снижает симптомы депрессии и тревоги (исследования Пеннебейкера).',
                whatToExpect: 'Пиши 10-15 минут без остановки. Не редактируй, не перечитывай сразу. Позволь руке двигаться.',
                firstTime: true
            },
            forgiveness: {
                title: 'Практика прощения',
                essence: 'Прощение — это не одобрение обиды и не забвение. Это освобождение себя от груза, который мы несём. Мы прощаем не ради другого, а ради собственной свободы.',
                science: 'Прощение связано со снижением уровня кортизола и улучшением сердечно-сосудистого здоровья.',
                whatToExpect: 'Это может быть непросто. Начни с малого. Прощение — процесс, не событие. Будь терпелив к себе.',
                firstTime: true
            }
        };
        
        // Фразы поддержки при "откате" (когда состояние ухудшилось)
        const ROLLBACK_SUPPORT = {
            // Переход от хорошего к нейтральному/плохому
            fromGoodToNeutral: [
                'Колебания — это нормально. Путь к свету не всегда прямой 🌊',
                'Ты был(а) в лучшем состоянии — значит, знаешь дорогу обратно 💫',
                'Это не откат назад — это часть естественных волн жизни 🌅',
                'Хорошие дни показали тебе, что они возможны. Они вернутся ☀️',
                'Сегодня потяжелее — и это тоже пройдёт. Ты справлялся раньше 💪'
            ],
            // Переход от нейтрального к тяжёлому
            fromNeutralToHeavy: [
                'Тяжело. Я вижу. Не нужно притворяться, что всё хорошо 🤍',
                'Сейчас трудно — но это состояние, не приговор. Оно изменится ⏳',
                'Разрешаю тебе сегодня просто быть. Без подвигов 🌙',
                'Даже маленький шаг в тяжести — это большая победа 👣',
                'Ты здесь. Ты открыл(а) приложение. Это уже забота о себе ❤️'
            ],
            // Переход от хорошего сразу к тяжёлому
            fromGoodToHeavy: [
                'Резкие перемены бывают. Это не значит, что прогресс потерян 🌊',
                'Тело и психика иногда "догоняют" нас. Дай себе время восстановиться 🛏️',
                'Помнишь, как было хорошо? Это твоё, и оно к тебе вернётся ✨',
                'Сегодня — день для очень маленьких шагов. Или для отдыха 🌿',
                'Нет ничего сломанного. Есть усталость, которая пройдёт 💙'
            ],
            // Несколько дней подряд тяжело
            persistentHeavy: [
                'Несколько дней тяжело — знаю, это выматывает. Но ты держишься 💪',
                'Длительная тяжесть — повод быть особенно бережным к себе 🤍',
                'Если тяжело несколько дней — может, стоит поговорить с кем-то? 📞',
                'Ты не один/одна в этом. Многие проходили через подобное ❤️',
                'Даже в затяжной тьме — ты продолжаешь заботиться о себе. Это сила 🌟'
            ],
            // Первый откат после улучшения
            firstRollback: [
                'Это первый "откат" после улучшения — они почти неизбежны 📊',
                'В психологии это называют "нормальными колебаниями восстановления" 📈',
                'Один шаг назад после двух вперёд — часть пути, не провал 🚶',
                'Твой мозг перестраивается. Иногда он "сопротивляется" — это нормально 🧠',
                'Откат не отменяет прогресса. Он — часть прогресса 💫'
            ]
        };
        
        // Фразы для адаптационного периода (первые 14 дней)
        const ONBOARDING_PHASES = {
            // Дни 1-3: Знакомство
            introduction: {
                days: [1, 2, 3],
                greeting: [
                    'Добро пожаловать в "Свет Души" 🌅',
                    'Рад(а) видеть тебя здесь 💛',
                    'Первые дни — время познакомиться с приложением 📱'
                ],
                guidance: [
                    'Не нужно делать всё сразу. Начни с одной практики в день.',
                    'Главное сейчас — просто отмечать своё состояние каждый день.',
                    'Исследуй приложение без давления. Нет правильного или неправильного.',
                    'Если что-то не откликается — пропусти. Здесь нет обязательств.'
                ],
                encouragement: [
                    'Сам факт, что ты здесь — уже шаг к свету ✨',
                    'Не торопись. У нас впереди много времени вместе 🌿',
                    'Твоё состояние — твоё. Нет "неправильных" чувств 🤍'
                ]
            },
            // Дни 4-7: Исследование
            exploration: {
                days: [4, 5, 6, 7],
                greeting: [
                    'Первая неделя! Ты уже многое попробовал(а) 🌟',
                    'Продолжаем исследовать вместе 🔍',
                    'Каждый день — новое открытие 💫'
                ],
                guidance: [
                    'Попробуй разные практики — найди то, что подходит именно тебе.',
                    'Обрати внимание на прогулки — они особенно эффективны.',
                    'Если какая-то практика не подошла — это нормально. У каждого свой путь.',
                    'Замечаешь ли ты связь между практиками и состоянием?'
                ],
                encouragement: [
                    'Неделя — это уже привычка в зачатке! 🌱',
                    'Ты исследуешь себя — это требует смелости 💪',
                    'Нет неудач — есть опыт и информация 📊'
                ]
            },
            // Дни 8-10: Закрепление
            consolidation: {
                days: [8, 9, 10],
                greeting: [
                    'Больше недели вместе! 🎉',
                    'Ты формируешь новые привычки 🌿',
                    'Продолжай в своём ритме 🚶'
                ],
                guidance: [
                    'Выбери 2-3 практики, которые больше всего откликаются.',
                    'Попробуй делать их примерно в одно время каждый день.',
                    'Ритуалы создают опору. Утро и вечер — лучшее время.',
                    'Записывай заметки — они помогут увидеть прогресс.'
                ],
                encouragement: [
                    'Ты строишь фундамент заботы о себе 🏗️',
                    '10 дней — это уже серьёзно! 💪',
                    'Маленькие шаги складываются в большой путь 👣'
                ]
            },
            // Дни 11-14: Интеграция
            integration: {
                days: [11, 12, 13, 14],
                greeting: [
                    'Две недели! Это важная веха 🏆',
                    'Ты прошёл(а) адаптационный период! 🌟',
                    'Практики становятся частью жизни 💫'
                ],
                guidance: [
                    'Теперь ты знаешь, что работает для тебя.',
                    'Обрати внимание на аналитику — видишь закономерности?',
                    'Попробуй программы — они помогут углубить практику.',
                    'Если был откат — это нормально. Главное — продолжать.'
                ],
                encouragement: [
                    'Две недели ежедневной заботы о себе — это достижение! 🎉',
                    'Ты уже не тот человек, что 14 дней назад 🌱→🌳',
                    'Адаптация завершена. Теперь — устойчивый рост 📈'
                ]
            },
            // После 14 дней: Продолжение
            ongoing: {
                days: null, // 15+
                greeting: [
                    'С возвращением! ☀️',
                    'Рад(а) видеть тебя снова 💛',
                    'Продолжаем путь к свету 🌅'
                ],
                guidance: [],
                encouragement: [
                    'Ты заботишься о себе уже {days} дней! 🌟',
                    'Постоянство — это суперсила 💪',
                    'Каждый день — новая возможность 🌱'
                ]
            }
        };
        
        // Контекстно-зависимые фразы по состояниям
        const STATE_BASED_MOTIVATION = {
            heavy: {
                morning: [
                    'Утро может быть тяжёлым. Не требуй от себя многого сегодня 🌅',
                    'Просто встать — уже победа в такой день 🛏️→☀️',
                    'Тяжёлое утро не определяет весь день 🌤️'
                ],
                day: [
                    'В тяжести — маленькие шаги. Попей воды. Выгляни в окно 💧',
                    'Не нужно исправлять своё состояние. Просто побудь с ним 🤍',
                    'Даже в тяжести ты заслуживаешь заботы о себе ❤️'
                ],
                evening: [
                    'День был тяжёлым — но ты его прожил(а). Это уже много 🌙',
                    'Вечер — время отдыха. Позволь себе просто быть 🛋️',
                    'Завтра — новый день. Сейчас — отдых 😴'
                ],
                practice_suggestions: ['warmth_footbath', 'breathing', 'warmth_tea']
            },
            low_energy: {
                morning: [
                    'Мало сил — значит, день для бережности к себе 🌱',
                    'Не нужно выжимать из себя энергию. Сохраняй её 🔋',
                    'Тёплое начало дня поможет: чай, одеяло, без спешки 🍵'
                ],
                day: [
                    'При низкой энергии — маленькие "порции" активности 🐢',
                    '5 минут на воздухе могут помочь больше, чем час лёжа 🌿',
                    'Еда, вода, свет — базовые вещи, которые дают силы 🍎💧☀️'
                ],
                evening: [
                    'Вечер — не время критиковать себя за "непродуктивность" 🌙',
                    'Отдых — это тоже важное дело 💤',
                    'Тело просит восстановления. Слушай его 👂'
                ],
                practice_suggestions: ['warmth_tea', 'walk_sunrise', 'light_morning']
            },
            anxious: {
                morning: [
                    'Тревожное утро. Начни с дыхания — оно всегда с тобой 🌬️',
                    'Тревога лжёт о будущем. Вернись в это утро, в эту минуту ⏰',
                    'Что ты можешь сделать прямо сейчас? Только это и важно 👣'
                ],
                day: [
                    'При тревоге: ноги на пол, 5 вдохов, посмотри вокруг 👁️',
                    'Тревога — это энергия. Прогулка поможет её "заземлить" 🚶',
                    'Ты справлялся(ась) с тревогой раньше. Справишься и сейчас 💪'
                ],
                evening: [
                    'Вечерняя тревога часто связана с усталостью. Отдохни 🛏️',
                    'Отложи решения на утро. Сейчас — время успокоения 🌙',
                    'Тёплая ванна или стопы в тепле помогут расслабиться 🛁'
                ],
                practice_suggestions: ['breathing', 'walk_forest', 'warmth_footbath']
            },
            neutral: {
                morning: [
                    'Нейтральное утро — хорошая база для дня 🌅',
                    'Не плохо, не отлично — и это нормально 🤍',
                    'Сегодня можно попробовать что-то новое 🌱'
                ],
                day: [
                    'Нейтральное состояние — время для осознанных практик 🧘',
                    'Это хороший момент, чтобы заметить: что даёт энергию? ⚡',
                    'Прогулка или практика могут сдвинуть стрелку к "хорошо" 📈'
                ],
                evening: [
                    'Ровный день — это тоже хорошо. Стабильность ценна 📊',
                    'Вечер для благодарности: за что благодарен(на) сегодня? 🙏',
                    'Хороший момент для спокойной рефлексии 📝'
                ],
                practice_suggestions: ['walk_observe', 'nondual_presence', 'journal_deep']
            },
            hopeful: {
                morning: [
                    'Чувствуешь надежду — это важно! Береги это чувство 🌟',
                    'Утро с надеждой — отличный старт 🌅',
                    'Надежда — это не наивность, это сила 💪'
                ],
                day: [
                    'День с надеждой — день возможностей 🚀',
                    'Используй это состояние для практик, которые "сложнее" 📈',
                    'Надежда + действие = прогресс ✨'
                ],
                evening: [
                    'Запомни это чувство. Оно твоё, оно реально ❤️',
                    'Вечер для закрепления: что поддержало надежду сегодня? 📝',
                    'Завтра тоже может быть хорошим днём 🌙→☀️'
                ],
                practice_suggestions: ['walk_beauty', 'gratitude', 'watercolor_sunrise']
            },
            grateful: {
                morning: [
                    'Благодарное утро — редкий подарок. Насладись им 🎁',
                    'С благодарностью день становится светлее ☀️',
                    'Заметь, что вызвало эту благодарность 🔍'
                ],
                day: [
                    'Благодарность расширяет взгляд. Что ещё замечаешь? 👁️',
                    'Поделись благодарностью — она от этого умножается 💕',
                    'Это состояние — результат твоей работы над собой 🏆'
                ],
                evening: [
                    'Благодарный вечер — лучшее завершение дня 🌙',
                    'Запиши 3 вещи, за которые благодарен(на) сегодня 📝',
                    'Засыпай с этим чувством — оно целительно 😴💚'
                ],
                practice_suggestions: ['gratitude', 'walk_beauty', 'loving_kindness']
            },
            light: {
                morning: [
                    'Лёгкое утро! Это то, ради чего мы работаем 🌟',
                    'Чувствуешь лёгкость — замечательно! ☀️',
                    'Это твоя награда за заботу о себе 🎉'
                ],
                day: [
                    'День с лёгкостью — день для радости и творчества 🎨',
                    'Можно сделать что-то, что откладывал(а) ✅',
                    'Энергия есть — используй её с удовольствием! ⚡'
                ],
                evening: [
                    'Лёгкий день — это возможно, и ты это знаешь теперь 💫',
                    'Поблагодари себя за путь, который привёл к этому дню 🙏',
                    'Такие дни — не случайность, а результат 📈'
                ],
                practice_suggestions: ['walk_forest', 'watercolor_emotion', 'walk_observe']
            }
        };
        
        // Функция анализа динамики состояния
        const analyzeStateTrajectory = (stateHistory) => {
            if (!stateHistory || stateHistory.length < 2) {
                return { type: 'insufficient_data', details: null };
            }
            
            const stateValues = {
                heavy: 1, low_energy: 2, anxious: 3,
                neutral: 4, hopeful: 5, grateful: 6, light: 7
            };
            
            const recent = stateHistory.slice(-7); // Последние 7 записей
            const values = recent.map(s => stateValues[s.state] || 4);
            
            const currentValue = values[values.length - 1];
            const previousValue = values[values.length - 2];
            const avgLast3 = values.slice(-3).reduce((a, b) => a + b, 0) / Math.min(3, values.length);
            const avgFirst3 = values.slice(0, 3).reduce((a, b) => a + b, 0) / Math.min(3, values.length);
            
            // Определяем тип динамики
            const change = currentValue - previousValue;
            const trend = avgLast3 - avgFirst3;
            
            // Счётчик тяжёлых дней подряд
            let heavyStreak = 0;
            for (let i = stateHistory.length - 1; i >= 0; i--) {
                if (stateValues[stateHistory[i].state] <= 2) {
                    heavyStreak++;
                } else {
                    break;
                }
            }
            
            // Был ли откат?
            const hadGoodDays = values.some(v => v >= 5);
            const isRollback = hadGoodDays && currentValue <= 3 && change < 0;
            
            // Это первый откат?
            const isFirstRollback = isRollback && 
                stateHistory.filter(s => stateValues[s.state] <= 3).length <= 2;
            
            return {
                current: currentValue,
                previous: previousValue,
                change: change,
                trend: trend,
                heavyStreak: heavyStreak,
                isRollback: isRollback,
                isFirstRollback: isFirstRollback,
                rollbackSeverity: isRollback ? 
                    (previousValue >= 5 && currentValue <= 2 ? 'severe' : 'moderate') : null,
                isImproving: trend > 0.5,
                isStable: Math.abs(trend) < 0.5,
                isDeclining: trend < -0.5
            };
        };
        
        // Функция получения адаптивного приветствия
        const getAdaptiveGreeting = (profile, stateHistory, usageStats) => {
            const hour = new Date().getHours();
            const timeOfDay = hour < 12 ? 'morning' : hour < 18 ? 'day' : 'evening';
            const daysSinceStart = usageStats?.daysSinceFirstUse || 1;
            const trajectory = analyzeStateTrajectory(stateHistory);
            const currentState = stateHistory?.length > 0 ? 
                stateHistory[stateHistory.length - 1].state : 'neutral';
            
            // Определяем фазу адаптации
            let phase = ONBOARDING_PHASES.ongoing;
            for (const key of ['introduction', 'exploration', 'consolidation', 'integration']) {
                if (ONBOARDING_PHASES[key].days.includes(daysSinceStart)) {
                    phase = ONBOARDING_PHASES[key];
                    break;
                }
            }
            
            let greeting = '';
            let guidance = '';
            let encouragement = '';
            
            // Приветствие
            const greetings = phase.greeting;
            greeting = greetings[Math.floor(Math.random() * greetings.length)];
            if (profile?.name) {
                greeting = greeting.replace('!', `, ${profile.name}!`);
            }
            
            // Если есть откат — приоритет поддержке
            if (trajectory.isRollback) {
                let supportMessages;
                if (trajectory.isFirstRollback) {
                    supportMessages = ROLLBACK_SUPPORT.firstRollback;
                } else if (trajectory.rollbackSeverity === 'severe') {
                    supportMessages = ROLLBACK_SUPPORT.fromGoodToHeavy;
                } else if (trajectory.current <= 2) {
                    supportMessages = ROLLBACK_SUPPORT.fromNeutralToHeavy;
                } else {
                    supportMessages = ROLLBACK_SUPPORT.fromGoodToNeutral;
                }
                encouragement = supportMessages[Math.floor(Math.random() * supportMessages.length)];
            }
            // Несколько дней тяжело подряд
            else if (trajectory.heavyStreak >= 3) {
                const messages = ROLLBACK_SUPPORT.persistentHeavy;
                encouragement = messages[Math.floor(Math.random() * messages.length)];
            }
            // Обычная логика по состоянию
            else if (STATE_BASED_MOTIVATION[currentState]) {
                const stateMessages = STATE_BASED_MOTIVATION[currentState][timeOfDay];
                if (stateMessages?.length > 0) {
                    encouragement = stateMessages[Math.floor(Math.random() * stateMessages.length)];
                }
            }
            
            // Добавляем guidance для периода адаптации
            if (daysSinceStart <= 14 && phase.guidance?.length > 0) {
                guidance = phase.guidance[Math.floor(Math.random() * phase.guidance.length)];
            }
            
            // Заменяем плейсхолдеры
            encouragement = encouragement.replace('{days}', daysSinceStart);
            
            return { greeting, guidance, encouragement, trajectory, phase: phase === ONBOARDING_PHASES.ongoing ? 'ongoing' : Object.keys(ONBOARDING_PHASES).find(k => ONBOARDING_PHASES[k] === phase) };
        };
        
        // Функция проверки первого использования практики
        const isFirstPracticeUse = (practiceId, practiceHistory) => {
            if (!practiceHistory || practiceHistory.length === 0) return true;
            return !practiceHistory.some(p => p.practiceId === practiceId);
        };
        
        // Функция получения описания практики
        const getPracticeDescription = (practiceId) => {
            return PRACTICE_DESCRIPTIONS[practiceId] || null;
        };
        
        // ═══════════════════════════════════════════════════════════════
        // МОДУЛЬ РАСПОРЯДКА ДНЯ И УВЕДОМЛЕНИЙ
        // Планирование событий, уведомления, вибросигналы
        // ═══════════════════════════════════════════════════════════════
        
        const DAILY_SCHEDULE = {
            // Шаблоны событий для быстрого добавления
            eventTemplates: [
                { id: 'wake', icon: '🌅', title: 'Подъём', defaultTime: '06:30', category: 'routine', duration: 15 },
                { id: 'morning_practice', icon: '🧘', title: 'Утренняя практика', defaultTime: '06:45', category: 'practice', duration: 20 },
                { id: 'breakfast', icon: '🍳', title: 'Завтрак', defaultTime: '07:30', category: 'meal', duration: 30 },
                { id: 'work_start', icon: '💼', title: 'Начало работы', defaultTime: '09:00', category: 'work', duration: 60 },
                { id: 'break_morning', icon: '☕', title: 'Перерыв', defaultTime: '11:00', category: 'break', duration: 15 },
                { id: 'lunch', icon: '🥗', title: 'Обед', defaultTime: '13:00', category: 'meal', duration: 45 },
                { id: 'walk', icon: '🚶', title: 'Прогулка', defaultTime: '13:45', category: 'practice', duration: 30 },
                { id: 'work_afternoon', icon: '💻', title: 'Рабочий блок', defaultTime: '14:30', category: 'work', duration: 120 },
                { id: 'break_afternoon', icon: '🍵', title: 'Перерыв', defaultTime: '16:30', category: 'break', duration: 15 },
                { id: 'work_end', icon: '🏁', title: 'Завершение работы', defaultTime: '18:00', category: 'work', duration: 30 },
                { id: 'dinner', icon: '🍽️', title: 'Ужин', defaultTime: '19:00', category: 'meal', duration: 45 },
                { id: 'evening_practice', icon: '🌙', title: 'Вечерняя практика', defaultTime: '20:30', category: 'practice', duration: 20 },
                { id: 'journal', icon: '📝', title: 'Дневник', defaultTime: '21:00', category: 'practice', duration: 15 },
                { id: 'sleep_prep', icon: '🛁', title: 'Подготовка ко сну', defaultTime: '21:30', category: 'routine', duration: 30 },
                { id: 'sleep', icon: '😴', title: 'Отбой', defaultTime: '22:00', category: 'routine', duration: 0 }
            ],
            
            // Категории с цветами
            categories: {
                routine: { color: '#E0E7FF', name: 'Режим', icon: '⏰' },
                practice: { color: '#D1FAE5', name: 'Практика', icon: '🧘' },
                meal: { color: '#FEF3C7', name: 'Питание', icon: '🍽️' },
                work: { color: '#FEE8D6', name: 'Работа', icon: '💼' },
                break: { color: '#F0FDF4', name: 'Отдых', icon: '☕' },
                custom: { color: '#F5F0FF', name: 'Своё', icon: '✨' }
            },
            
            // Сообщения для уведомлений
            notificationMessages: {
                wake: ['Доброе утро! Новый день — новые возможности 🌅', 'Время вставать. Ты справишься с этим днём 💪'],
                morning_practice: ['Время для утренней практики 🧘', '15 минут для себя — лучшее начало дня'],
                breakfast: ['Время завтрака. Питай тело осознанно 🍳', 'Завтрак готов? Ешь медленно и с благодарностью'],
                work_start: ['Начинаем рабочий день 💼', 'Фокус и спокойствие. Ты готов(а)'],
                break_morning: ['Перерыв! Встань, потянись, подыши ☕', '5 минут для глаз и тела'],
                lunch: ['Обеденный перерыв 🥗', 'Время восстановить силы'],
                walk: ['Время прогулки! Природа ждёт 🚶', 'Даже 15 минут на воздухе меняют состояние'],
                work_afternoon: ['Возвращаемся к делам 💻', 'Вторая половина дня — ты можешь'],
                break_afternoon: ['Короткий перерыв 🍵', 'Отдохни глаза, потянись'],
                work_end: ['Рабочий день завершается 🏁', 'Время подвести итоги и отпустить'],
                dinner: ['Время ужина 🍽️', 'Вечерняя трапеза — время замедлиться'],
                evening_practice: ['Вечерняя практика 🌙', 'Успокой ум перед сном'],
                journal: ['Время для дневника 📝', 'Запиши день — отпусти его'],
                sleep_prep: ['Готовимся ко сну 🛁', 'Тело и ум готовятся к отдыху'],
                sleep: ['Время спать 😴', 'Спокойной ночи. Завтра — новый день'],
                custom: ['Время для запланированного события ⏰', 'Не забудь о важном']
            },
            
            // Настройки уведомлений по уровню строгости
            strictnessLevels: {
                gentle: {
                    name: 'Мягкие',
                    description: 'Можно смахнуть, без повтора',
                    vibrationPattern: [100, 50, 100],
                    priority: 'default',
                    persistent: false,
                    repeatInterval: 0
                },
                moderate: {
                    name: 'Умеренные',
                    description: 'Повтор через 5 минут если не открыто',
                    vibrationPattern: [200, 100, 200, 100, 200],
                    priority: 'high',
                    persistent: false,
                    repeatInterval: 5
                },
                strict: {
                    name: 'Строгие',
                    description: 'Нельзя смахнуть, требует действия',
                    vibrationPattern: [300, 200, 300, 200, 300, 200, 300],
                    priority: 'max',
                    persistent: true,
                    repeatInterval: 3
                }
            },
            
            // Получить уровень строгости по дням использования
            getStrictnessLevel: (daysSinceFirstUse) => {
                if (daysSinceFirstUse >= 7) return 'strict';
                if (daysSinceFirstUse >= 3) return 'moderate';
                return 'gentle';
            },
            
            // Форматирование времени
            formatTime: (time) => {
                const [h, m] = time.split(':');
                return `${h}:${m}`;
            },
            
            // Парсинг времени в минуты от полуночи
            timeToMinutes: (time) => {
                const [h, m] = time.split(':').map(Number);
                return h * 60 + m;
            },
            
            // Минуты в время
            minutesToTime: (minutes) => {
                const h = Math.floor(minutes / 60) % 24;
                const m = minutes % 60;
                return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
            },
            
            // Получить следующее событие
            getNextEvent: (schedule) => {
                if (!schedule || schedule.length === 0) return null;
                
                const now = new Date();
                const currentMinutes = now.getHours() * 60 + now.getMinutes();
                
                const sorted = [...schedule]
                    .filter(e => e.enabled !== false)
                    .sort((a, b) => DAILY_SCHEDULE.timeToMinutes(a.time) - DAILY_SCHEDULE.timeToMinutes(b.time));
                
                for (const event of sorted) {
                    const eventMinutes = DAILY_SCHEDULE.timeToMinutes(event.time);
                    if (eventMinutes > currentMinutes) {
                        return {
                            ...event,
                            minutesUntil: eventMinutes - currentMinutes
                        };
                    }
                }
                
                // Если все события прошли, вернуть первое на завтра
                if (sorted.length > 0) {
                    const first = sorted[0];
                    const firstMinutes = DAILY_SCHEDULE.timeToMinutes(first.time);
                    return {
                        ...first,
                        minutesUntil: (24 * 60 - currentMinutes) + firstMinutes,
                        isTomorrow: true
                    };
                }
                
                return null;
            },
            
            // Получить текущее/недавнее событие
            getCurrentEvent: (schedule) => {
                if (!schedule || schedule.length === 0) return null;
                
                const now = new Date();
                const currentMinutes = now.getHours() * 60 + now.getMinutes();
                
                const sorted = [...schedule]
                    .filter(e => e.enabled !== false)
                    .sort((a, b) => DAILY_SCHEDULE.timeToMinutes(b.time) - DAILY_SCHEDULE.timeToMinutes(a.time));
                
                for (const event of sorted) {
                    const eventMinutes = DAILY_SCHEDULE.timeToMinutes(event.time);
                    const eventEnd = eventMinutes + (event.duration || 30);
                    if (currentMinutes >= eventMinutes && currentMinutes <= eventEnd) {
                        return {
                            ...event,
                            isActive: true,
                            minutesPassed: currentMinutes - eventMinutes
                        };
                    }
                }
                
                return null;
            },
            
            // Создать дефолтное расписание
            createDefaultSchedule: () => {
                return DAILY_SCHEDULE.eventTemplates.map(template => ({
                    id: template.id,
                    templateId: template.id,
                    icon: template.icon,
                    title: template.title,
                    time: template.defaultTime,
                    category: template.category,
                    duration: template.duration,
                    enabled: true,
                    notify: true
                }));
            },
            
            // Получить сообщение для уведомления
            getNotificationMessage: (eventId) => {
                const messages = DAILY_SCHEDULE.notificationMessages[eventId] || DAILY_SCHEDULE.notificationMessages.custom;
                return messages[Math.floor(Math.random() * messages.length)];
            }
        };
        
        // ═══════════════════════════════════════════════════════════════
        // МОДУЛЬ БИОГРАФИЧЕСКОЙ РАБОТЫ (антропософский подход)
        // Семилетия, возрастные кризисы, узлы Луны, полярности
        // ═══════════════════════════════════════════════════════════════
        
        const BIOGRAPHY_WORK = {
            // Семилетия жизни с их задачами и темами
            septennials: [
                {
                    range: [0, 7],
                    name: 'Первое семилетие',
                    theme: 'Доверие к миру',
                    element: 'Физическое тело',
                    color: '#FFE4E4',
                    icon: '👶',
                    tasks: ['Формирование базового доверия', 'Развитие физического тела', 'Подражание и впитывание мира'],
                    questions: [
                        'Каким было моё детство? Что я помню из этого периода?',
                        'Чувствовал(а) ли я себя в безопасности?',
                        'Кто были главные люди рядом? Что они мне дали?',
                        'Какие запахи, звуки, ощущения остались в памяти?'
                    ],
                    crisis: { age: 7, name: 'Смена зубов', description: 'Переход от подражания к обучению' }
                },
                {
                    range: [7, 14],
                    name: 'Второе семилетие',
                    theme: 'Авторитет и красота',
                    element: 'Эфирное тело (жизненные силы)',
                    color: '#FEF3C7',
                    icon: '🧒',
                    tasks: ['Развитие чувства прекрасного', 'Следование авторитету', 'Формирование привычек и ритмов'],
                    questions: [
                        'Кто был моим авторитетом? Кем я восхищался(ась)?',
                        'Какие события школьных лет оставили след?',
                        'Что было красивым в моей жизни тогда?',
                        'Какие привычки сформировались в этот период?'
                    ],
                    crisis: { age: 9, name: 'Рубикон детства', description: 'Первое осознание отделённости от мира, "я" и "не-я"' },
                    crisis2: { age: 12, name: 'Предподростковый кризис', description: 'Начало критического мышления' }
                },
                {
                    range: [14, 21],
                    name: 'Третье семилетие',
                    theme: 'Поиск истины и идеалов',
                    element: 'Астральное тело (душа)',
                    color: '#E0E7FF',
                    icon: '🧑',
                    tasks: ['Развитие собственного суждения', 'Поиск идеалов и смысла', 'Первая любовь, дружба'],
                    questions: [
                        'Какие идеалы были важны в юности?',
                        'Против чего я бунтовал(а)?',
                        'Какие книги, идеи, люди повлияли на меня?',
                        'Что я тогда считал(а) справедливым/несправедливым?'
                    ],
                    crisis: { age: 18, name: 'Совершеннолетие', description: 'Рождение собственного "Я", выбор пути' },
                    crisis2: { age: 21, name: 'Рождение Я', description: 'Полное духовное совершеннолетие' }
                },
                {
                    range: [21, 28],
                    name: 'Четвёртое семилетие',
                    theme: 'Опыт и эксперимент',
                    element: 'Душа ощущающая',
                    color: '#D1FAE5',
                    icon: '🌱',
                    tasks: ['Активный опыт мира', 'Профессиональные пробы', 'Отношения и партнёрство'],
                    questions: [
                        'Какие эксперименты я делал(а) в жизни?',
                        'Какие ошибки оказались важным опытом?',
                        'Как развивались отношения с людьми?',
                        'Что я узнал(а) о себе через работу?'
                    ],
                    crisis: { age: 28, name: 'Возврат Сатурна', description: 'Первый большой жизненный итог, пересмотр пути' }
                },
                {
                    range: [28, 35],
                    name: 'Пятое семилетие',
                    theme: 'Организация и структура',
                    element: 'Душа рассудочная',
                    color: '#FEE8D6',
                    icon: '🏗️',
                    tasks: ['Построение карьеры и семьи', 'Организация жизни', 'Ответственность'],
                    questions: [
                        'Что я строил(а) в этот период?',
                        'За что взял(а) ответственность?',
                        'Какие структуры создал(а) в жизни?',
                        'Что давало чувство стабильности?'
                    ],
                    crisis: { age: 33, name: 'Христов возраст', description: 'Кризис смысла, вопрос "для чего я живу?"' }
                },
                {
                    range: [35, 42],
                    name: 'Шестое семилетие',
                    theme: 'Кризис середины жизни',
                    element: 'Душа сознательная',
                    color: '#E8EEF4',
                    icon: '🔥',
                    tasks: ['Переоценка ценностей', 'Встреча с тенью', 'Поиск подлинного "Я"'],
                    questions: [
                        'Что я понял(а) о себе к середине жизни?',
                        'От каких иллюзий пришлось отказаться?',
                        'Что оказалось по-настоящему важным?',
                        'Какие части себя я подавлял(а)?'
                    ],
                    crisis: { age: 37, name: 'Узел Луны (второй)', description: 'Возможность радикального обновления' },
                    crisis2: { age: 42, name: 'Середина жизни', description: 'Поворот от внешнего к внутреннему' }
                },
                {
                    range: [42, 49],
                    name: 'Седьмое семилетие',
                    theme: 'Мудрость опыта',
                    element: 'Самодух (начало)',
                    color: '#F5F0FF',
                    icon: '🦉',
                    tasks: ['Передача опыта', 'Интеграция пережитого', 'Новые формы творчества'],
                    questions: [
                        'Чему научила меня первая половина жизни?',
                        'Что я могу передать другим?',
                        'Какие новые способности открываются?',
                        'Как изменилось отношение к успеху и неудаче?'
                    ],
                    crisis: { age: 46, name: 'Узел Луны (третий)', description: 'Кармический узел, возможность освобождения' }
                },
                {
                    range: [49, 56],
                    name: 'Восьмое семилетие',
                    theme: 'Внутренняя свобода',
                    element: 'Самодух',
                    color: '#FFE4E4',
                    icon: '🕊️',
                    tasks: ['Освобождение от внешних ожиданий', 'Развитие индивидуальности', 'Духовные поиски'],
                    questions: [
                        'От чего я освободился(ась)?',
                        'Что делаю по-настоящему своё?',
                        'Какие духовные вопросы встают передо мной?',
                        'Как изменилось отношение к смерти?'
                    ],
                    crisis: { age: 56, name: 'Третий возврат Сатурна', description: 'Второй большой итог, подготовка к старости' }
                },
                {
                    range: [56, 63],
                    name: 'Девятое семилетие',
                    theme: 'Дары и служение',
                    element: 'Жизнедух (начало)',
                    color: '#FEF3C7',
                    icon: '🎁',
                    tasks: ['Бескорыстное служение', 'Передача мудрости', 'Забота о следующих поколениях'],
                    questions: [
                        'Что я могу дать миру безвозмездно?',
                        'Какую мудрость несу в себе?',
                        'Как забочусь о тех, кто придёт после?',
                        'В чём моё наследие?'
                    ],
                    crisis: { age: 63, name: 'Третья инициация', description: 'Переход к истинной зрелости' }
                },
                {
                    range: [63, 100],
                    name: 'Зрелые годы',
                    theme: 'Мудрость и завершение',
                    element: 'Духочеловек',
                    color: '#E0E7FF',
                    icon: '🌟',
                    tasks: ['Обзор жизни', 'Примирение', 'Подготовка к переходу'],
                    questions: [
                        'Какой была "красная нить" моей жизни?',
                        'С чем я примирился(ась)?',
                        'Что остаётся незавершённым?',
                        'Какое послание я оставляю?'
                    ]
                }
            ],
            
            // Узлы Луны (каждые 18.6 лет)
            lunarNodes: [
                { age: 18.6, name: 'Первый узел Луны', meaning: 'Встреча с кармой, первый выбор судьбы' },
                { age: 37.2, name: 'Второй узел Луны', meaning: 'Радикальный пересмотр, возможность освобождения' },
                { age: 55.8, name: 'Третий узел Луны', meaning: 'Интеграция жизненного опыта' },
                { age: 74.4, name: 'Четвёртый узел Луны', meaning: 'Завершение и подготовка' }
            ],
            
            // Полярности для рефлексии
            polarities: [
                { pair: ['Свобода', 'Зависимость'], question: 'Где в жизни я ощущаю свободу? Где — зависимость?' },
                { pair: ['Близость', 'Одиночество'], question: 'Как я балансирую потребность в близости и уединении?' },
                { pair: ['Стабильность', 'Риск'], question: 'Чего больше в моей жизни — надёжности или приключений?' },
                { pair: ['Материальное', 'Духовное'], question: 'Как связаны мои материальные и духовные стремления?' },
                { pair: ['Давать', 'Получать'], question: 'Что легче для меня — давать или принимать?' },
                { pair: ['Прошлое', 'Будущее'], question: 'Где моё внимание — в прошлом или в планах?' },
                { pair: ['Контроль', 'Доверие'], question: 'Стремлюсь ли я контролировать всё или могу доверять?' },
                { pair: ['Активность', 'Созерцание'], question: 'Как чередуются в жизни действие и покой?' }
            ],
            
            // Биографические вопросы для "красной нити"
            redThreadQuestions: [
                'Какая тема повторяется в моей жизни снова и снова?',
                'Если бы моя жизнь была книгой — о чём она?',
                'Какой тип людей я привлекаю в свою жизнь?',
                'Какой тип конфликтов повторяется?',
                'Что я ищу уже много лет?',
                'Какие таланты я так и не развил(а)?',
                'Что мне говорили о себе разные люди в разные годы?',
                'Какие "совпадения" меняли мою жизнь?',
                'От чего я бежал(а) всю жизнь?',
                'К чему неизменно возвращаюсь?'
            ],
            
            // Вопросы для работы с конкретным событием
            eventQuestions: [
                'Чему меня научило это событие?',
                'Как бы сложилась жизнь без него?',
                'Что во мне тогда рождалось нового?',
                'Какие силы помогли пережить это?',
                'Что я тогда не понимал(а), а понимаю сейчас?',
                'Какой подарок скрыт в этом опыте?'
            ],
            
            // Принципы биографической работы (из антропософского подхода)
            principles: [
                {
                    title: 'Человек как автор биографии',
                    icon: '✍️',
                    description: 'Биография не просто «случилась» — она создаётся в диалоге с судьбой и окружением.',
                    practice: 'Вместо «со мной сделали» — «как я встречался с событиями и что из них делаю сейчас».'
                },
                {
                    title: 'Целостность: тело – душа – дух',
                    icon: '🔮',
                    description: 'Жизнь рассматривается в трёх измерениях: телесное (здоровье, работа), душевное (чувства, отношения), духовное (ценности, смысл).',
                    practice: 'Изменения в одном уровне отражаются в других. Работа идёт с целостной картиной.'
                },
                {
                    title: 'Неоценочное отношение',
                    icon: '🤍',
                    description: 'Никакой ретроспективной самокритики «правильно/неправильно».',
                    practice: 'Попытка понять закономерность и смысл выбора в тот момент.'
                },
                {
                    title: 'Связь личного и надличного',
                    icon: '🌍',
                    description: 'Личная история — часть более широкого контекста: рода, эпохи, общечеловеческой эволюции.',
                    practice: 'Через биографию проявляется «задача души» в этом воплощении.'
                }
            ],
            
            // Практические упражнения биографической работы
            exercises: [
                {
                    id: 'life_tape',
                    title: 'Хронологическая карта жизни',
                    icon: '📜',
                    description: 'Создайте «ленту» жизни: годы, города, школы, работы, значимые люди, болезни, потери, встречи, вдохновения.',
                    instructions: [
                        'Возьмите лист бумаги или откройте документ',
                        'Нарисуйте горизонтальную линию — это ваша жизнь',
                        'Разделите на семилетия (0-7, 7-14, 14-21...)',
                        'Отметьте ключевые события в каждом периоде',
                        'Выделите вершины (счастье, успех) и провалы (кризисы, потери)',
                        'Ищите повторяющиеся паттерны'
                    ],
                    duration: '30-60 минут',
                    frequency: 'Однократно, обновлять раз в год'
                },
                {
                    id: 'letter_to_self',
                    title: 'Письмо себе в прошлое',
                    icon: '✉️',
                    description: 'Напишите письмо себе в определённый возраст. Что бы вы сказали тому себе?',
                    instructions: [
                        'Выберите возраст (например, 14, 21, 28 лет)',
                        'Представьте себя в том возрасте максимально ярко',
                        'Напишите письмо от сегодняшнего себя',
                        'Что вы знаете теперь, чего не знали тогда?',
                        'Какую поддержку вы хотели бы получить?',
                        'Сохраните письмо и вернитесь к нему через неделю'
                    ],
                    duration: '20-30 минут',
                    frequency: 'По потребности'
                },
                {
                    id: 'peaks_and_valleys',
                    title: 'Вершины и долины',
                    icon: '⛰️',
                    description: 'Нарисуйте график жизни: по горизонтали — годы, по вертикали — субъективное благополучие.',
                    instructions: [
                        'Нарисуйте координатную ось: X — возраст, Y — «как было»',
                        'Поставьте точку для каждого года жизни',
                        'Соедините точки линией',
                        'Подпишите ключевые пики и падения',
                        'Что было общего в периоды подъёма? Спада?',
                        'Какие решения предшествовали изменениям?'
                    ],
                    duration: '30-45 минут',
                    frequency: 'Однократно'
                },
                {
                    id: 'childhood_landscape',
                    title: 'Ландшафт детства',
                    icon: '🏡',
                    description: 'Нарисуйте (даже схематично) место, где прошло детство. Что было важным?',
                    instructions: [
                        'Возьмите чистый лист и цветные карандаши',
                        'Нарисуйте дом, улицу, места детства',
                        'Отметьте: где было безопасно? Где страшно?',
                        'Где вы играли? С кем?',
                        'Какие запахи, звуки, ощущения вспоминаются?',
                        'Принцип «пронесения через ночь»: вернитесь к рисунку завтра'
                    ],
                    duration: '40-60 минут',
                    frequency: 'Однократно'
                },
                {
                    id: 'repeating_patterns',
                    title: 'Повторяющиеся паттерны',
                    icon: '🔄',
                    description: 'Исследуйте, какие типы людей, конфликтов и решений повторяются в вашей жизни.',
                    instructions: [
                        'Запишите 5-7 значимых людей из разных периодов',
                        'Что общего между ними?',
                        'Запишите 5-7 конфликтов/трудностей',
                        'Какой тип решений вы обычно принимаете?',
                        'Видите ли закономерность?',
                        'Что это говорит о вашей «задаче»?'
                    ],
                    duration: '30-40 минут',
                    frequency: 'Раз в полгода'
                },
                {
                    id: 'future_chapter',
                    title: 'Следующая глава',
                    icon: '📖',
                    description: 'Если ваша биография — книга, какую главу вы хотите написать дальше?',
                    instructions: [
                        'Представьте, что ваша жизнь — книга с главами',
                        'Как называется текущая глава?',
                        'Как вы хотите назвать следующую?',
                        'Какие события войдут в эту главу?',
                        'Что конкретно вы можете сделать в ближайшие недели?',
                        'Запишите 3 конкретных шага'
                    ],
                    duration: '20-30 минут',
                    frequency: 'Раз в месяц'
                }
            ],
            
            // Вопросы для триады тело-душа-дух
            triadQuestions: {
                body: {
                    title: 'Телесное измерение',
                    icon: '🏃',
                    questions: [
                        'Как моё тело чувствует себя в этом периоде жизни?',
                        'Какие болезни или симптомы появились? Что они говорят?',
                        'Где я живу? Как это влияет на меня?',
                        'Как я забочусь о теле? Достаточно ли?',
                        'Что тело просит: движения, отдыха, природы?'
                    ]
                },
                soul: {
                    title: 'Душевное измерение',
                    icon: '💗',
                    questions: [
                        'Какие чувства преобладают сейчас?',
                        'Какие отношения поддерживают? Какие истощают?',
                        'Что радует душу? Что печалит?',
                        'Есть ли непрожитые чувства из прошлого?',
                        'Кому я благодарен? На кого обижен?'
                    ]
                },
                spirit: {
                    title: 'Духовное измерение',
                    icon: '✨',
                    questions: [
                        'В чём смысл того, что я делаю?',
                        'Какие ценности действительно мои, а какие навязаны?',
                        'Что останется после меня?',
                        'Какова моя «задача» в этом воплощении?',
                        'Чему учит меня жизнь прямо сейчас?'
                    ]
                }
            },
            
            // Пять этапов биографической работы
            workStages: [
                {
                    stage: 1,
                    title: 'Создание рамки и запроса',
                    description: 'Формулирование конкретного вопроса: что именно болит, где ощущается «узел».',
                    questions: [
                        'Почему я обращаюсь к биографии сейчас?',
                        'Что в моей жизни не даёт покоя?',
                        'Где я чувствую «застревание»?'
                    ]
                },
                {
                    stage: 2,
                    title: 'Сбор материала',
                    description: 'Хронологическая карта жизни, выделение ключевых событий и мотивов.',
                    questions: [
                        'Какие события были поворотными?',
                        'Кто были ключевые люди каждого периода?',
                        'Какие моменты счастья и кризиса я помню?'
                    ]
                },
                {
                    stage: 3,
                    title: 'Осмысление через вопросы',
                    description: 'Биографические вопросы, работа с полярностями, художественные методы.',
                    questions: [
                        'Чему научило каждое событие?',
                        'Какие полярности (свобода-зависимость, близость-одиночество) присутствуют?',
                        'Что было бы, если бы того события не было?'
                    ]
                },
                {
                    stage: 4,
                    title: 'Выделение закономерностей',
                    description: 'Поиск ритмов, узлов, «красной нити» жизни.',
                    questions: [
                        'Какая тема повторяется?',
                        'Какие связи между событиями я вижу?',
                        'В чём моя «красная нить»?'
                    ]
                },
                {
                    stage: 5,
                    title: 'Переход к будущему',
                    description: 'Обновлённое отношение к прошлому, формирование намерений и конкретных шагов.',
                    questions: [
                        'Как изменился мой взгляд на прошлое?',
                        'Какую главу я хочу написать дальше?',
                        'Что конкретно я сделаю в ближайшие недели?'
                    ]
                }
            ],
            
            // Вопросы для переходных периодов
            transitionQuestions: {
                9: {
                    name: 'Рубикон детства (9 лет)',
                    questions: [
                        'Как я осознал(а) свою отделённость от мира?',
                        'Что было страшным в этом возрасте?',
                        'Как взрослые поддержали меня в этот момент?'
                    ]
                },
                18: {
                    name: 'Совершеннолетие (18-21)',
                    questions: [
                        'Какой путь я выбрал(а) на развилке?',
                        'Какие возможности были открыты? Какие закрыты?',
                        'Кем я хотел(а) стать тогда? Стал(а) ли?'
                    ]
                },
                28: {
                    name: 'Возврат Сатурна (28-30)',
                    questions: [
                        'Каким был мой первый большой итог жизни?',
                        'Что пришлось пересмотреть?',
                        'Какие юношеские иллюзии развеялись?'
                    ]
                },
                35: {
                    name: 'Середина жизни (35-42)',
                    questions: [
                        'Что оказалось действительно важным?',
                        'От каких иллюзий пришлось отказаться?',
                        'Какие части себя я подавлял(а)?',
                        'Что просит моя душа на следующую половину жизни?'
                    ]
                },
                49: {
                    name: 'Мудрость (49+)',
                    questions: [
                        'Чему научила меня первая половина жизни?',
                        'Что я могу передать другим?',
                        'Какие новые способности открываются?'
                    ]
                }
            },
            
            // Определение текущего семилетия
            getCurrentSeptennial: (birthDate) => {
                if (!birthDate) return null;
                const birth = new Date(birthDate);
                const now = new Date();
                const ageInYears = (now - birth) / (365.25 * 24 * 60 * 60 * 1000);
                
                for (const sept of BIOGRAPHY_WORK.septennials) {
                    if (ageInYears >= sept.range[0] && ageInYears < sept.range[1]) {
                        return {
                            ...sept,
                            currentAge: Math.floor(ageInYears),
                            yearsInPeriod: Math.floor(ageInYears - sept.range[0]),
                            yearsLeft: Math.ceil(sept.range[1] - ageInYears)
                        };
                    }
                }
                return BIOGRAPHY_WORK.septennials[BIOGRAPHY_WORK.septennials.length - 1];
            },
            
            // Определение ближайших кризисов/переходов
            getUpcomingTransitions: (birthDate) => {
                if (!birthDate) return [];
                const birth = new Date(birthDate);
                const now = new Date();
                const ageInYears = (now - birth) / (365.25 * 24 * 60 * 60 * 1000);
                
                const transitions = [];
                
                // Проверяем кризисы в семилетиях
                for (const sept of BIOGRAPHY_WORK.septennials) {
                    if (sept.crisis && sept.crisis.age > ageInYears && sept.crisis.age < ageInYears + 5) {
                        const yearsUntil = sept.crisis.age - ageInYears;
                        transitions.push({
                            ...sept.crisis,
                            yearsUntil: yearsUntil,
                            isImminent: yearsUntil < 1
                        });
                    }
                    if (sept.crisis2 && sept.crisis2.age > ageInYears && sept.crisis2.age < ageInYears + 5) {
                        const yearsUntil = sept.crisis2.age - ageInYears;
                        transitions.push({
                            ...sept.crisis2,
                            yearsUntil: yearsUntil,
                            isImminent: yearsUntil < 1
                        });
                    }
                }
                
                // Проверяем узлы Луны
                for (const node of BIOGRAPHY_WORK.lunarNodes) {
                    if (node.age > ageInYears && node.age < ageInYears + 3) {
                        transitions.push({
                            ...node,
                            yearsUntil: node.age - ageInYears,
                            isLunarNode: true,
                            isImminent: (node.age - ageInYears) < 1
                        });
                    }
                }
                
                return transitions.sort((a, b) => a.yearsUntil - b.yearsUntil);
            },
            
            // Получение биографического сообщения для текущего состояния
            getBiographyInsight: (birthDate, currentState) => {
                const sept = BIOGRAPHY_WORK.getCurrentSeptennial(birthDate);
                const transitions = BIOGRAPHY_WORK.getUpcomingTransitions(birthDate);
                
                if (!sept) return null;
                
                let insight = {
                    septennial: sept,
                    transitions: transitions,
                    message: '',
                    question: ''
                };
                
                // Сообщение в зависимости от состояния и периода
                if (currentState === 'heavy' || currentState === 'low_energy') {
                    if (sept.range[0] === 35) {
                        insight.message = 'Середина жизни — время глубокой переоценки. Тяжесть может быть знаком, что душа просит нового направления.';
                    } else if (transitions.some(t => t.isImminent)) {
                        insight.message = 'Ты приближаешься к важному переходу. Тяжесть часто предшествует трансформации.';
                    } else {
                        insight.message = `В ${sept.name.toLowerCase()} главная тема — "${sept.theme}". Как твоё состояние связано с этой задачей?`;
                    }
                } else {
                    insight.message = `Ты в ${sept.name.toLowerCase()}. Это время для: ${sept.tasks[0].toLowerCase()}.`;
                }
                
                // Вопрос дня
                insight.question = sept.questions[Math.floor(Math.random() * sept.questions.length)];
                
                return insight;
            }
        };
        
        // Мотивационные сообщения для прогулок
        const WALK_MOTIVATIONS = {
            start: [
                'Каждый шаг — это движение к свету 🌅',
                'Природа ждёт тебя. Она всегда рада гостям 🌿',
                'Свежий воздух — лучшее лекарство для души 💨',
                'Сегодня отличный день для прогулки! ☀️',
                'Движение — это жизнь. Пора двигаться! 🚶',
                'Деревья готовы поделиться своей силой 🌳',
                'Небо ждёт твоего взгляда 🌤️'
            ],
            during: [
                'Ты молодец! Продолжай в том же духе 💪',
                'Каждая минута на воздухе — подарок телу 🎁',
                'Замечай красоту вокруг — она везде ✨',
                'Дыши глубже, чувствуй жизнь 🌬️',
                'Твоё тело благодарит тебя за движение 🙏'
            ],
            complete: [
                'Отлично! Ты сделал(а) это! 🎉',
                'Прогулка завершена. Ты стал(а) чуточку сильнее 💪',
                'Природа поделилась с тобой своей энергией 🌿',
                'Каждая прогулка — маленькая победа над тьмой ☀️',
                'Ты заботишься о себе. Это важно! ❤️'
            ],
            streak: [
                'Потрясающе! {days} дней подряд! 🔥',
                '{days} дней прогулок! Ты формируешь привычку! 🌟',
                'Серия {days} дней! Так держать! 💪'
            ],
            reminder: [
                'Сегодня ещё не было прогулки. Может, выйти на 10 минут? 🌤️',
                'Свежий воздух ждёт тебя! 🌿',
                'Даже короткая прогулка лучше, чем никакой 🚶'
            ],
            // Фразы для типа "Город" 🏙️
            city: [
                'Город — живой организм. Прислушайся к его пульсу 🏙️',
                'Посмотри на здания — каждое хранит свою историю 🏛️',
                'Заметь игру света в окнах и витринах ✨',
                'Городские улицы — это артерии жизни 🛤️',
                'Обрати внимание на архитектурные детали вокруг 🏗️',
                'Каждый прохожий — отдельная вселенная 👥',
                'Город красив в любое время года 🌆',
                'Слушай звуки города — это его музыка 🎵',
                'Найди что-то новое на знакомой улице 🔍',
                'Тротуары помнят миллионы шагов до тебя 👣',
                'Посмотри вверх — городское небо тоже прекрасно 🌤️',
                'Уличные фонари — маяки в городском море 💡',
                'Город просыпается и засыпает вместе с тобой 🌃',
                'Каждый квартал — отдельный мир для исследования 🗺️',
                'Асфальт под ногами держит тебя крепко 🛣️'
            ],
            // Фразы для типа "Наблюдение" 👁️
            observe: [
                'Замедлись. Что ты видишь прямо сейчас? 👁️',
                'Заметь три звука вокруг тебя 👂',
                'Как ощущается воздух на коже? 🌬️',
                'Посмотри на небо — оно всегда разное ☁️',
                'Твои ноги чувствуют землю. Ты здесь 🦶',
                'Каждый вдох — это настоящий момент 🌸',
                'Мир полон деталей, которые мы не замечаем 🔍',
                'Присутствуй полностью в этом шаге 👣',
                'Что замечает твоё тело прямо сейчас? 🧘',
                'Обрати внимание на запахи вокруг 👃',
                'Солнечный свет или тень — всё часть момента ☀️',
                'Ты идёшь, и это уже прекрасно 🚶',
                'Заметь текстуры вокруг — гладкое, шершавое 🖐️',
                'Какие цвета преобладают вокруг тебя? 🎨',
                'Этот момент больше никогда не повторится ⏳',
                'Дыхание — твой якорь в настоящем ⚓',
                'Каждый шаг — маленькая медитация 🙏'
            ],
            // Фразы для типа "Лес/Парк" 🌳
            forest: [
                'Деревья дышат вместе с тобой 🌳',
                'Лес принимает тебя таким, какой ты есть 🌲',
                'Прислушайся к шелесту листьев — это голос природы 🍃',
                'Фитонциды деревьев укрепляют твой иммунитет 🛡️',
                'Корни деревьев уходят глубоко, как твоя сила 🌱',
                'Птицы поют для тебя бесплатный концерт 🐦',
                'Зелёный цвет успокаивает нервную систему 💚',
                'Прикоснись к коре дерева — почувствуй его жизнь 🤲',
                'Лесной воздух — настоящий эликсир здоровья 💨',
                'Деревья стоят здесь десятилетиями. Учись у них терпению 🕰️',
                'Тропинка ведёт тебя — доверься ей 🛤️',
                'Солнечные лучи сквозь листву — природный калейдоскоп ☀️',
                'Каждое дерево — живое существо с душой 💫',
                'Мох, трава, земля — всё это живое 🌿',
                'Лес не торопится. И тебе не нужно 🐢',
                'Вдохни запах хвои — он очищает мысли 🌲',
                'Природа не знает депрессии. Побудь с ней 🌸',
                'Ты часть этого леса, часть природы 🌍'
            ],
            // Фразы для типа "Активная" 🏃
            active: [
                'Чувствуй, как работают мышцы — они становятся сильнее 💪',
                'Сердце качает кровь — ты живёшь на полную! ❤️',
                'Эндорфины уже вырабатываются. Скоро почувствуешь! 🌟',
                'Каждый шаг сжигает калории и стресс 🔥',
                'Ты быстрее, чем вчера! 🚀',
                'Дыхание учащается — это нормально и полезно 💨',
                'Тело создано для движения. Двигайся! 🏃',
                'Пот — это жир, который плачет! 💧',
                'Ты тренируешь не только тело, но и волю 🧠',
                'После этого будет приятная усталость 😌',
                'Активность — лучший антидепрессант без побочек 💊',
                'Каждый метр — победа над ленью 🏆',
                'Кровь приливает к мозгу — мысли проясняются 💡',
                'Ты сильнее, чем думаешь! 💪',
                'Темп задаёшь ты сам(а) 🎯',
                'Это инвестиция в своё здоровье 📈',
                'После движения сон будет крепче 😴'
            ],
            // Фразы для типа "Красота" ✨
            beauty: [
                'Красота скрывается в мелочах. Найди её! ✨',
                'Посмотри — что красивого ты видишь прямо сейчас? 👀',
                'Облака рисуют картины только для тебя ☁️',
                'Свет и тень создают удивительные узоры 🌓',
                'Природа — величайший художник 🎨',
                'Заметь игру красок вокруг 🌈',
                'Даже обычное может быть прекрасным 💎',
                'Красота — это способ видеть 👁️',
                'Что вызывает у тебя восхищение? 😍',
                'Каждый цветок — маленькое чудо 🌺',
                'Архитектура, природа, люди — везде есть красота 🏛️',
                'Сфотографируй красоту глазами — сохрани в памяти 📸',
                'Красивое исцеляет душу 💝',
                'Ищи красоту — и она найдёт тебя ✨',
                'Мир прекрасен, если смотреть с любовью 💕',
                'Остановись у чего-то красивого на минуту ⏸️',
                'Благодарность за красоту умножает её 🙏',
                'Ты тоже часть этой красоты 🌟'
            ]
        };
        
        // Цели и достижения для прогулок
        const WALK_ACHIEVEMENTS = [
            { id: 'first_walk', name: 'Первый шаг', icon: '👣', description: 'Записать первую прогулку', condition: (stats) => stats.totalWalks >= 1 },
            { id: 'week_streak', name: 'Неделя в движении', icon: '🔥', description: '7 дней подряд', condition: (stats) => stats.currentStreak >= 7 },
            { id: 'ten_walks', name: 'Десятка', icon: '🎯', description: '10 прогулок', condition: (stats) => stats.totalWalks >= 10 },
            { id: 'hour_total', name: 'Час на воздухе', icon: '⏱️', description: '60 минут за неделю', condition: (stats) => stats.weekMinutes >= 60 },
            { id: 'three_hours', name: 'Мастер прогулок', icon: '🏆', description: '180 минут за неделю', condition: (stats) => stats.weekMinutes >= 180 },
            { id: 'month_streak', name: 'Месяц силы', icon: '💎', description: '30 дней подряд', condition: (stats) => stats.currentStreak >= 30 },
            { id: 'nature_lover', name: 'Любитель природы', icon: '🌳', description: '5 прогулок в лесу/парке', condition: (stats) => stats.natureWalks >= 5 },
            { id: 'city_walker', name: 'Городской ходок', icon: '🏙️', description: '10 прогулок в городе', condition: (stats) => (stats.cityWalks || 0) >= 10 },
            { id: 'sunrise_walker', name: 'Ранняя пташка', icon: '🌅', description: '3 прогулки на рассвете', condition: (stats) => stats.sunriseWalks >= 3 },
            { id: 'sunset_walker', name: 'Вечерний странник', icon: '🌇', description: '3 прогулки на закате', condition: (stats) => stats.sunsetWalks >= 3 }
        ];
        
        // Рекомендации по прогулкам в зависимости от состояния
        const WALK_RECOMMENDATIONS = {
            heavy: { duration: 15, type: 'walk_observe', tip: 'При тяжести достаточно короткой прогулки. Главное — выйти.' },
            low_energy: { duration: 10, type: 'walk_observe', tip: 'Не перенапрягайся. Даже 10 минут на воздухе помогут.' },
            anxious: { duration: 20, type: 'walk_forest', tip: 'Лес или парк особенно полезны при тревоге.' },
            neutral: { duration: 30, type: 'walk_observe', tip: 'Хорошее время для осознанной прогулки.' },
            hopeful: { duration: 30, type: 'walk_beauty', tip: 'Поищи красоту вокруг!' },
            grateful: { duration: 25, type: 'walk_beauty', tip: 'Прогулка благодарности — замечай, за что благодарен.' },
            light: { duration: 40, type: 'walk_forest', tip: 'Отличное состояние для долгой прогулки!' }
        };
        
        // Health-инсайты о пользе прогулок
        const HEALTH_INSIGHTS = [
            { icon: '🧠', title: 'Мозг', fact: '20 минут прогулки увеличивают приток крови к мозгу на 15%', benefit: 'Улучшение памяти и концентрации' },
            { icon: '❤️', title: 'Сердце', fact: '30 минут ходьбы снижают риск сердечных заболеваний на 19%', benefit: 'Укрепление сердечно-сосудистой системы' },
            { icon: '😊', title: 'Настроение', fact: 'Прогулка повышает уровень эндорфинов на 30%', benefit: 'Естественный антидепрессант' },
            { icon: '💪', title: 'Энергия', fact: '10 минут на воздухе бодрят лучше чашки кофе', benefit: 'Повышение жизненного тонуса' },
            { icon: '😴', title: 'Сон', fact: 'Дневные прогулки улучшают качество сна на 65%', benefit: 'Глубокий восстанавливающий сон' },
            { icon: '🌿', title: 'Стресс', fact: '20 минут в парке снижают кортизол на 20%', benefit: 'Снятие напряжения' },
            { icon: '🦴', title: 'Кости', fact: 'Ходьба укрепляет кости и суставы', benefit: 'Профилактика остеопороза' },
            { icon: '🔥', title: 'Метаболизм', fact: '30 мин ходьбы сжигают ~150 калорий', benefit: 'Поддержание здорового веса' },
            { icon: '🧘', title: 'Осознанность', fact: 'Прогулка в природе снижает руминацию на 25%', benefit: 'Меньше навязчивых мыслей' },
            { icon: '🌳', title: 'Фитонциды', fact: 'Лесной воздух содержит целебные фитонциды', benefit: 'Укрепление иммунитета' }
        ];
        
        // Анализ корреляции прогулок и настроения
        const analyzeWalkMoodCorrelation = (walks, stateHistory) => {
            if (walks.length < 3 || stateHistory.length < 3) return null;
            
            const stateValues = { heavy: 1, low_energy: 2, anxious: 3, neutral: 4, hopeful: 5, grateful: 6, light: 7 };
            const last14Days = [];
            
            for (let i = 0; i < 14; i++) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                date.setHours(0, 0, 0, 0);
                const dayEnd = date.getTime() + 24 * 60 * 60 * 1000;
                
                const dayWalks = walks.filter(w => {
                    const wTime = new Date(w.date).getTime();
                    return wTime >= date.getTime() && wTime < dayEnd;
                });
                
                const dayMoods = stateHistory.filter(s => {
                    const sTime = new Date(s.date).getTime();
                    return sTime >= date.getTime() && sTime < dayEnd;
                });
                
                const walkMinutes = dayWalks.reduce((sum, w) => sum + (w.duration || 0), 0);
                const avgMood = dayMoods.length > 0 
                    ? dayMoods.reduce((sum, m) => sum + (stateValues[m.state] || 4), 0) / dayMoods.length 
                    : null;
                
                last14Days.push({ date: date.toISOString(), walkMinutes, avgMood, dayOfWeek: date.getDay() });
            }
            
            // Сравнение дней с прогулками и без
            const daysWithWalks = last14Days.filter(d => d.walkMinutes > 0 && d.avgMood !== null);
            const daysWithoutWalks = last14Days.filter(d => d.walkMinutes === 0 && d.avgMood !== null);
            
            const avgMoodWithWalks = daysWithWalks.length > 0 
                ? daysWithWalks.reduce((sum, d) => sum + d.avgMood, 0) / daysWithWalks.length 
                : null;
            const avgMoodWithoutWalks = daysWithoutWalks.length > 0 
                ? daysWithoutWalks.reduce((sum, d) => sum + d.avgMood, 0) / daysWithoutWalks.length 
                : null;
            
            // Лучший день недели для прогулок
            const dayStats = [0, 1, 2, 3, 4, 5, 6].map(day => {
                const days = last14Days.filter(d => d.dayOfWeek === day);
                return {
                    day,
                    avgMinutes: days.length > 0 ? days.reduce((sum, d) => sum + d.walkMinutes, 0) / days.length : 0
                };
            });
            const bestDay = dayStats.reduce((best, d) => d.avgMinutes > best.avgMinutes ? d : best, dayStats[0]);
            const dayNames = ['Вс', 'Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб'];
            
            return {
                last14Days: last14Days.reverse(),
                avgMoodWithWalks,
                avgMoodWithoutWalks,
                moodImprovement: avgMoodWithWalks && avgMoodWithoutWalks 
                    ? ((avgMoodWithWalks - avgMoodWithoutWalks) / avgMoodWithoutWalks * 100).toFixed(0) 
                    : null,
                bestDay: dayNames[bestDay.day],
                bestDayMinutes: Math.round(bestDay.avgMinutes)
            };
        };

        const PRACTICES = [
            // СВЕТ
            { id: 'light_morning', category: 'light', title: 'Утренний свет', short: 'Встреча с утренним светом', steps: ['Встаньте у окна, выходящего на восток', 'Закройте глаза и почувствуйте тепло света', 'Представьте, как свет наполняет тело', 'Медленно откройте глаза', 'Побудьте в этом состоянии'], duration: 10, bg: '#FFF3C7', states: ['heavy', 'low_energy'] },
            { id: 'light_candle', category: 'light', title: 'Медитация на свечу', short: 'Созерцание живого огня', steps: ['Зажгите свечу', 'Направьте мягкий взгляд на пламя', 'Наблюдайте за танцем огня', 'Представьте свет внутри вас', 'Закройте глаза, сохранив образ'], duration: 15, bg: '#FFE4C9', states: ['anxious', 'heavy'] },
            
            // ТЕПЛО
            { id: 'warmth_heart', category: 'warmth', title: 'Тепло сердца', short: 'Пробуждение внутреннего тепла', steps: ['Положите ладони на сердце', 'Вспомните момент любви и тепла', 'Представьте огонёк в груди', 'Позвольте теплу распространиться', 'Скажите: «Во мне есть тепло»'], duration: 12, bg: '#FFE8E0', states: ['heavy', 'low_energy'] },
            { id: 'warmth_tea', category: 'warmth', title: 'Медитация с чаем', short: 'Осознанное питьё тёплого напитка', steps: ['Заварите чашку чая', 'Возьмите чашку двумя руками', 'Почувствуйте тепло в ладонях', 'Вдохните аромат', 'Пейте медленно, чувствуя тепло'], duration: 10, bg: '#FFF0D4', states: ['heavy', 'low_energy', 'anxious'] },
            { id: 'warmth_footbath', category: 'warmth', title: 'Ванночка для ног', short: 'Прогрев ног с эфирными маслами', steps: ['Приготовьте таз с тёплой водой (38-40°C)', 'Выберите масло по дню или настроению', 'При тяжести: апельсин, грейпфрут', 'При тревоге: лаванда, ромашка', 'При упадке сил: розмарин, мята', 'Добавьте 3-5 капель в воду', 'Опустите ноги и расслабьтесь', 'Побудьте 15-20 минут', 'Наденьте тёплые носки'], duration: 25, bg: '#FFE8E0', states: ['heavy', 'low_energy', 'anxious', 'neutral'] },
            { id: 'warmth_blanket', category: 'warmth', title: 'Кокон тепла', short: 'Укутывание в одеяло', steps: ['Возьмите тёплое одеяло', 'Укутайтесь полностью', 'Почувствуйте безопасность', 'Дышите медленно', 'Побудьте 15-20 минут'], duration: 20, bg: '#FFF0D4', states: ['heavy', 'anxious'] },
            { id: 'warmth_self_hug', category: 'warmth', title: 'Объятия себя', short: 'Самосострадание через прикосновение', steps: ['Скрестите руки на груди', 'Обнимите себя мягко', 'Покачивайтесь, если хочется', 'Скажите: «Я забочусь о тебе»', 'Побудьте в объятиях 2-3 минуты'], duration: 5, bg: '#FFE8E0', states: ['heavy', 'anxious', 'low_energy'] },
            { id: 'warmth_compress', category: 'warmth', title: 'Компресс на печень', short: 'Тёплый компресс для гармонизации', steps: ['Смочите полотенце тёплой водой', 'Лягте на спину', 'Положите на правое подреберье', 'Сверху — грелку или бутылку', 'Укройтесь и расслабьтесь', 'Побудьте 20-30 минут'], duration: 35, bg: '#FFE8E0', states: ['heavy', 'low_energy'] },
            
            // АКВАРЕЛЬ
            { id: 'watercolor_sunrise', category: 'watercolor', title: 'Рассвет', short: 'От тьмы к свету', steps: ['Подготовьте акварельные краски и кисти', 'Смочите бумагу чистой водой', 'Нанесите фиолетовый внизу листа', 'Добавьте красный и оранжевый выше', 'Завершите жёлтым наверху', 'Дайте цветам плавно перетечь друг в друга', 'Наблюдайте за рождением рассвета'], duration: 20, bg: '#FFE4C9', states: ['heavy', 'low_energy', 'hopeful'] },
            { id: 'watercolor_emotion', category: 'watercolor', title: 'Поток эмоций', short: 'Свободное выражение в цвете', steps: ['Разложите акварельные краски — все цвета', 'Смочите бумагу водой', 'Прислушайтесь к своему состоянию', 'Выберите цвет интуитивно, не думая', 'Рисуйте свободно — линии, пятна, потоки', 'Добавляйте цвета по ощущениям', 'Акварель сама создаст красивые переходы'], duration: 15, bg: '#E8DCFF', states: ['heavy', 'anxious', 'neutral'] },
            { id: 'watercolor_warmth', category: 'watercolor', title: 'Тёплые цвета', short: 'Согревающая практика акварелью', steps: ['Подготовьте акварельные краски тёплых тонов', 'Вам понадобятся: красный, оранжевый, жёлтый, охра', 'Смочите бумагу тёплой водой', 'Начните с жёлтого в центре листа', 'Добавляйте оранжевый вокруг', 'Красный — на краях', 'Дайте цветам свободно перетекать', 'Наблюдайте за теплом на бумаге', 'Почувствуйте тепло внутри себя'], duration: 25, bg: '#FFE4C9', states: ['heavy', 'low_energy'] },
            { id: 'watercolor_calm', category: 'watercolor', title: 'Спокойное море', short: 'Успокаивающая акварельная медитация', steps: ['Подготовьте акварельные краски холодных тонов', 'Синий, голубой, бирюзовый, фиолетовый', 'Смочите бумагу — это будет море', 'Нанесите светло-голубой вверху — небо', 'Добавьте глубокий синий внизу — вода', 'Позвольте цветам встретиться на горизонте', 'Добавьте белые блики — волны', 'Дышите медленно, как волны'], duration: 20, bg: '#E0F2FE', states: ['anxious', 'neutral'] },
            { id: 'watercolor_tree', category: 'watercolor', title: 'Дерево жизни', short: 'Рисуем свои корни и кроны', steps: ['Возьмите акварельные краски: коричневый, зелёный, жёлтый', 'Смочите лист бумаги', 'Нарисуйте ствол коричневым — это ваша жизнь', 'Корни уходят вниз — ваши опоры', 'Ветви тянутся вверх — ваши стремления', 'Добавьте зелёные и жёлтые листья', 'Каждый лист — что-то хорошее в жизни', 'Пусть краски свободно текут и смешиваются'], duration: 30, bg: '#D1FAE5', states: ['hopeful', 'neutral', 'heavy'] },
            
            // ПРОГУЛКИ
            { id: 'walk_sunrise', category: 'walk', title: 'На рассвете', short: 'Встреча нового дня', steps: ['Встаньте до рассвета', 'Выйдите на место с видом на восток', 'Наблюдайте, как меняется небо', 'Встретьте первые лучи', 'Поблагодарите за новый день'], duration: 30, bg: '#FFE4C9', states: ['heavy', 'low_energy'] },
            { id: 'walk_sunset', category: 'walk', title: 'На закате', short: 'Завершение дня', steps: ['Выйдите за час до заката', 'Идите медленно', 'Наблюдайте игру красок', 'Отпустите заботы дня', 'Вернитесь в сумерках'], duration: 40, bg: '#F4A4A4', states: ['anxious', 'neutral'] },
            { id: 'walk_forest', category: 'walk', title: 'Лесная', short: 'Погружение в лес', steps: ['Войдите в лес медленно', 'Прислушайтесь', 'Вдохните запах леса', 'Прикоснитесь к дереву', 'Просто побудьте'], duration: 45, bg: '#DCF5DC', states: ['anxious', 'hopeful'] },
            { id: 'walk_observe', category: 'walk', title: 'Наблюдение', short: 'Осознанная прогулка', steps: ['Выйдите без цели', 'Идите медленнее обычного', 'Замечайте детали вокруг', 'Посмотрите на небо', 'Почувствуйте воздух'], duration: 25, bg: '#FAF6EE', states: ['neutral', 'hopeful', 'grateful'] },
            { id: 'walk_beauty', category: 'walk', title: 'Поиск красоты', short: 'Найти 5 красивых вещей', steps: ['Поставьте задачу: найти 5 красивых вещей', 'Выйдите с открытым взглядом', 'Ищите красоту везде', 'Остановитесь у каждой находки', 'Вернитесь наполненными'], duration: 30, bg: '#FEE8D6', states: ['neutral', 'hopeful', 'grateful'] },
            
            // ДЫХАНИЕ
            { id: 'breathing', category: 'breathing', title: 'Якорное дыхание', short: 'Возвращение к настоящему', steps: ['Сядьте удобно', 'Найдите, где чувствуете дыхание', 'Направьте внимание туда', 'Просто наблюдайте', 'Когда ум уходит — вернитесь'], duration: 10, bg: '#E8F4F8', states: ['anxious', 'heavy', 'neutral'] },
            
            // ТЕЛО
            { id: 'mbct_bodyscan', category: 'body', title: 'Сканирование тела', short: 'Телесное осознавание', steps: ['Лягте удобно', 'Направьте внимание на пальцы ног', 'Медленно поднимайтесь вверх', 'Замечайте ощущения', 'Дойдите до макушки'], duration: 20, bg: '#E8EEF4', states: ['anxious', 'low_energy'] },
            
            // ПРИСУТСТВИЕ
            { id: 'nondual_presence', category: 'nondual', title: 'Чистое присутствие', short: 'Осознавание, которое есть', steps: ['Сядьте удобно', 'Заметьте звуки вокруг', 'Кто их осознаёт?', 'Заметьте ощущения', 'Отдохните в открытости'], duration: 15, bg: '#F5F0FF', states: ['neutral', 'hopeful', 'grateful'] },
            
            // БЛАГОДАРНОСТЬ
            { id: 'gratitude', category: 'gratitude', title: 'Вечерняя благодарность', short: 'Три момента благодарности', steps: ['Устройтесь перед сном', 'Вспомните день', 'Найдите три момента благодарности', 'Почувствуйте благодарность телом', 'Засыпайте с этим'], duration: 5, bg: '#FFF8E8', states: ['heavy', 'neutral', 'hopeful', 'grateful'] },
            
            // ДНЕВНИК
            { id: 'journal_deep', category: 'journal', title: 'Глубокое письмо', short: 'Письменное исследование', steps: ['Возьмите бумагу и ручку', 'Напишите: «Что сейчас во мне?»', 'Пишите без остановки 10 минут', 'Не редактируйте', 'Прочитайте написанное'], duration: 15, bg: '#FAF6EE', states: ['neutral', 'hopeful'] },
            
            // БАНЯ И СПА
            { id: 'sauna', category: 'spa', title: 'Посещение бани', short: 'Глубокое прогревание тела и души', steps: ['Подготовьте эфирные масла по дню недели', 'Вс/☀️ Свет: апельсин, ладан — радость', 'Пн/💧 Вода: лаванда, эвкалипт — покой', 'Вт/🔥 Огонь: розмарин, имбирь — сила', 'Ср/🌬️ Воздух: мята, лимон — ясность', 'Чт/🌳 Дерево: пихта, кедр — рост', 'Пт/🌸 Цветение: роза, герань — гармония', 'Сб/🪨 Земля: кипарис, сосна — глубина', 'Добавьте 5-7 капель в ковш с водой', 'Первый заход 5-7 минут — привыкание', 'Отдых 10-15 минут, пейте воду или чай', 'Второй заход 10-15 минут с веником', 'Массаж веником — от ног к голове', 'Снова отдых и питьё', 'Третий заход — созерцание и благодарность', 'После бани — тёплый травяной чай', 'Отдых минимум 30 минут'], duration: 120, bg: '#FFE8E0', states: ['heavy', 'low_energy', 'anxious', 'neutral'] },
            
            { id: 'bath_full', category: 'spa', title: 'Тёплая ванна', short: 'Целительное погружение с маслами', steps: ['Наполните ванну тёплой водой (37-38°C)', 'Выберите масла по состоянию:', 'При тяжести: апельсин + бергамот', 'При тревоге: лаванда + ромашка', 'При упадке: розмарин + грейпфрут', 'Для баланса: герань + ладан', 'Смешайте 8-10 капель с эмульгатором', 'Эмульгатор: соль, сливки или мёд', 'Добавьте смесь в воду', 'Погрузитесь по плечи', 'Дышите глубоко, вдыхая аромат', 'Представьте, как тепло растворяет тяжесть', 'Побудьте 20-30 минут', 'После — укутайтесь и отдохните'], duration: 40, bg: '#FFE8E0', states: ['heavy', 'low_energy', 'anxious'] },
            
            { id: 'massage_self', category: 'spa', title: 'Самомассаж с маслами', short: 'Заботливое прикосновение к себе', steps: ['Подготовьте базовое масло (миндальное, кунжутное)', 'Добавьте эфирные масла (2-3 капли на ст.л.):', 'Для расслабления: лаванда, ромашка', 'Для энергии: розмарин, апельсин', 'Для заземления: кедр, ветивер', 'Согрейте масло в ладонях', 'Начните со стоп — круговые движения', 'Поднимайтесь по голеням, бёдрам', 'Мягко массируйте живот по часовой стрелке', 'Разомните плечи и шею', 'Помассируйте руки от кистей к плечам', 'Завершите массажем лица и головы', 'Оставьте масло впитаться 15-20 минут', 'Примите тёплый душ или оставьте до утра'], duration: 30, bg: '#FEE8D6', states: ['heavy', 'low_energy', 'anxious', 'neutral'] },
            
            { id: 'massage_feet_evening', category: 'spa', title: 'Вечерний массаж стоп', short: 'Расслабление через стопы с маслами', steps: ['Приготовьте масло по дню/состоянию', 'Вечерние масла: лаванда, ладан, кедр', 'Смешайте 3-4 капли с базовым маслом', 'Сядьте удобно, согните одну ногу', 'Нанесите масло и разогрейте стопу', 'Разомните подошву большими пальцами', 'Пройдите каждый палец, потяните', 'Помассируйте свод стопы', 'Разотрите пятку круговыми движениями', 'Погладьте от пальцев к щиколотке', 'Повторите с другой стопой', 'Наденьте хлопковые носки', 'Полежите с приподнятыми ногами'], duration: 20, bg: '#FFE8E0', states: ['anxious', 'neutral', 'low_energy'] },
            
            // ЛЮБЯЩАЯ ДОБРОТА
            { id: 'loving_kindness', category: 'nondual', title: 'Любящая доброта', short: 'Метта-медитация для сердца', steps: ['Сядьте удобно, закройте глаза', 'Положите руку на сердце', 'Направьте любовь к себе:', '«Пусть я буду счастлив(а)»', '«Пусть я буду здоров(а)»', '«Пусть я буду в безопасности»', '«Пусть я буду свободен(на) от страданий»', 'Вспомните близкого человека', 'Направьте ему те же пожелания', 'Расширьте на всех знакомых', 'Расширьте на всех существ', '«Пусть все существа будут счастливы»', 'Побудьте в этом состоянии'], duration: 15, bg: '#FFE4E4', states: ['heavy', 'anxious', 'neutral', 'hopeful', 'grateful'] },
            
            // ПРОЩЕНИЕ
            { id: 'forgiveness', category: 'nondual', title: 'Практика прощения', short: 'Освобождение от груза прошлого', steps: ['Сядьте спокойно, закройте глаза', 'Вспомните ситуацию, которая тяготит', 'Признайте боль, которую она причинила', 'Скажите: «Я признаю эту боль»', 'Подумайте о человеке (или себе)', 'Он/она тоже страдает/страдал(а)', 'Скажите: «Я прощаю тебя»', 'Или: «Я прощаю себя»', 'Не обязательно забывать — только отпустить', 'Представьте, как груз уходит', 'Почувствуйте лёгкость в груди', 'Поблагодарите себя за этот шаг'], duration: 20, bg: '#F5F0FF', states: ['heavy', 'neutral'] },
            
            // КТО НАБЛЮДАЕТ
            { id: 'who_observes', category: 'nondual', title: 'Кто наблюдает?', short: 'Самоисследование по адвайте', steps: ['Сядьте в тишине', 'Заметьте звуки вокруг', 'Спросите: «Кто слышит эти звуки?»', 'Заметьте ощущения в теле', 'Спросите: «Кто чувствует это тело?»', 'Заметьте мысли', 'Спросите: «Кто наблюдает мысли?»', 'Не ищите ответ умом', 'Просто будьте с вопросом', 'Заметьте: наблюдатель не может быть объектом', 'То, что вы есть — это само осознавание', 'Отдохните как это осознавание'], duration: 15, bg: '#F5F0FF', states: ['neutral', 'hopeful', 'grateful', 'light'] },
            
            // ЧУДО ДНЯ
            { id: 'wonder_of_day', category: 'gratitude', title: 'Чудо дня', short: 'Вечерняя рефлексия', steps: ['Вечером, перед сном', 'Вспомните прошедший день', 'Пройдите его в обратном порядке', 'От вечера к утру, кадр за кадром', 'Найдите момент удивления или красоты', 'Это и есть «чудо дня»', 'Задержитесь на нём', 'Позвольте чувству благодарности наполнить вас', 'Отпустите день с миром', 'Засыпайте с образом чуда'], duration: 10, bg: '#FFF8E8', states: ['neutral', 'hopeful', 'grateful'] },
            
            // ПСИХООБРАЗОВАНИЕ
            { id: 'psychoeducation', category: 'journal', title: 'Понимание депрессии', short: 'Знание — первый шаг к исцелению', steps: ['Депрессия — это не слабость характера', 'Это состояние, затрагивающее тело и душу', 'Симптомы: упадок сил, потеря интереса', 'Тяжесть, нарушения сна и аппетита', 'Негативные мысли — симптом, не правда', 'Мысли — это не факты о вас', 'Депрессия искажает восприятие', 'Важно: это временное состояние', 'Оно поддаётся работе и лечению', 'Практики, движение, свет — помогают', 'При тяжёлых симптомах — к специалисту', 'Вы не одиноки в этом'], duration: 10, bg: '#E8F4F8', states: ['heavy', 'low_energy', 'anxious', 'neutral'] }
        ];
        
        // Горячие линии помощи
        // ═══════════════════════════════════════════════════════════════
        // МОДУЛЬ ПИТАНИЯ (ПАЛЕО)
        // ═══════════════════════════════════════════════════════════════
        
        const NUTRITION_PLAN = {
            morning: {
                title: 'Завтрак (до 10:00)',
                principle: 'Белково-жировой рацион + сложные углеводы',
                icon: '🌅',
                description: 'Утром организм нуждается в стабильной энергии. Белки и жиры дают насыщение на 4-5 часов без скачков сахара.',
                foods: [
                    { name: 'Яйца', details: '2-3 шт. (вареные, омлет, глазунья)', icon: '🥚' },
                    { name: 'Топлёное масло', details: 'Гхи — 1-2 ст.л. к любым блюдам', icon: '🧈' },
                    { name: 'Рыба', details: 'Лосось, сельдь, скумбрия', icon: '🐟' },
                    { name: 'Орехи', details: 'Горсть миндаля или грецких', icon: '🥜' },
                    { name: 'Каша', details: 'Гречка, овсянка (без сахара)', icon: '🥣' },
                    { name: 'Овощи', details: 'Помидоры, огурцы, зелень', icon: '🥗' },
                    { name: 'Сыр', details: 'Твёрдый, выдержанный', icon: '🧀' }
                ],
                avoid: ['Сладкие каши', 'Мюсли с сахаром', 'Соки', 'Хлеб белый', 'Выпечка']
            },
            lunch: {
                title: 'Обед (12:00 - 14:00)',
                principle: 'Пик пищеварения — любая пища',
                icon: '☀️',
                description: 'В это время пищеварительная система работает на максимуме. Можно есть всё, включая мясо и сложные блюда.',
                foods: [
                    { name: 'Мясо', details: 'Индейка, курица, утка', icon: '🍗' },
                    { name: 'Рыба', details: 'Любая, особенно жирная', icon: '🐟' },
                    { name: 'Овощи', details: 'Салаты, гарниры', icon: '🥬' },
                    { name: 'Супы', details: 'Костный бульон, щи, борщ', icon: '🍲' },
                    { name: 'Крупы', details: 'Рис, гречка, киноа', icon: '🍚' },
                    { name: 'Бобовые', details: 'Чечевица, нут (умеренно)', icon: '🫘' }
                ],
                avoid: ['Десерты сразу после еды', 'Сладкие напитки']
            },
            dinner: {
                title: 'Ужин (18:00 - 19:00)',
                principle: 'Лёгкая пища — овощи и молочное',
                icon: '🌙',
                description: 'Вечером пищеварение замедляется. Лёгкая пища обеспечит спокойный сон и восстановление.',
                foods: [
                    { name: 'Тушёные овощи', details: 'Кабачки, морковь, тыква', icon: '🥕' },
                    { name: 'Творог', details: '5-9% жирности', icon: '🧈' },
                    { name: 'Простокваша', details: 'Кефир, ряженка, йогурт', icon: '🥛' },
                    { name: 'Мягкий сыр', details: 'Адыгейский, моцарелла, рикотта', icon: '🧀' },
                    { name: 'Овощной суп', details: 'Без мяса, лёгкий', icon: '🍵' },
                    { name: 'Салат', details: 'Со сметаной или топлёным маслом', icon: '🥗' }
                ],
                avoid: ['Мясо (долго переваривается)', 'Фрукты (брожение)', 'Сладкое']
            },
            excluded: {
                title: '⛔ Исключить полностью',
                items: [
                    { name: 'Сахар', details: 'Белый, коричневый, сиропы', icon: '🍬' },
                    { name: 'Мучное', details: 'Хлеб, макароны, выпечка', icon: '🍞' },
                    { name: 'Растит. масла', details: 'Подсолнечное, оливковое, рапсовое', icon: '🫒' },
                    { name: 'Соки', details: 'Даже свежевыжатые (много сахара)', icon: '🧃' },
                    { name: 'Газировка', details: 'Любые сладкие напитки', icon: '🥤' },
                    { name: 'Фастфуд', details: 'Трансжиры, добавки', icon: '🍟' },
                    { name: 'Полуфабрикаты', details: 'Колбасы, сосиски', icon: '🌭' }
                ]
            },
            recommended_fats: {
                title: '✅ Полезные жиры',
                items: [
                    { name: 'Топлёное масло', details: 'Гхи — идеально для жарки', icon: '🧈' },
                    { name: 'Сало', details: 'Солёное, копчёное, для жарки', icon: '🥓' },
                    { name: 'Сливочное масло', details: 'Натуральное, 82%+ жирности', icon: '🧈' },
                    { name: 'Животный жир', details: 'Утиный, гусиный, куриный', icon: '🍖' },
                    { name: 'Сметана', details: 'Для заправки салатов', icon: '🥛' }
                ]
            }
        };
        
        const TEMPERAMENT_NUTRITION = {
            sanguine: {
                title: 'Сангвиник',
                icon: '🌞',
                element: 'Воздух',
                tendency: 'Быстрый метаболизм, склонность перекусывать',
                recommendations: [
                    'Регулярные приёмы пищи — не пропускайте завтрак',
                    'Больше белка для стабильной энергии',
                    'Избегайте кофе — и без того много энергии',
                    'Тёплые супы и каши для заземления',
                    'Орехи вместо сладких перекусов'
                ],
                superfoods: ['Гречка', 'Яйца', 'Грецкие орехи', 'Тыква'],
                avoid: ['Много кофеина', 'Сладкие снеки', 'Еда на бегу']
            },
            choleric: {
                title: 'Холерик',
                icon: '🔥',
                element: 'Огонь',
                tendency: 'Сильное пищеварение, риск переедания',
                recommendations: [
                    'Охлаждающие продукты — огурцы, кабачки',
                    'Меньше острого и жареного',
                    'Больше сырых овощей и салатов',
                    'Достаточно воды — огонь требует влаги',
                    'Медленные приёмы пищи — не торопитесь'
                ],
                superfoods: ['Огурцы', 'Кабачки', 'Рыба', 'Йогурт'],
                avoid: ['Острое', 'Алкоголь', 'Красное мясо в избытке']
            },
            melancholic: {
                title: 'Меланхолик',
                icon: '🌙',
                element: 'Земля',
                tendency: 'Слабое пищеварение, чувствительность',
                recommendations: [
                    'Согревающие специи — имбирь, куркума',
                    'Тёплая приготовленная пища (не сырая)',
                    'Костные бульоны для питания',
                    'Регулярные приёмы — без голодания',
                    'Ферментированные продукты для микробиома'
                ],
                superfoods: ['Костный бульон', 'Тушёные овощи', 'Имбирь', 'Квашеная капуста'],
                avoid: ['Холодная сырая пища', 'Молоко (может плохо усваиваться)', 'Сухая еда']
            },
            phlegmatic: {
                title: 'Флегматик',
                icon: '💧',
                element: 'Вода',
                tendency: 'Медленный метаболизм, задержка жидкости',
                recommendations: [
                    'Острые специи для ускорения метаболизма',
                    'Лёгкая пища — избегайте тяжёлого',
                    'Меньше молочных продуктов',
                    'Больше движения после еды',
                    'Имбирный чай вместо обычного'
                ],
                superfoods: ['Имбирь', 'Перец', 'Лёгкие овощи', 'Горькие травы'],
                avoid: ['Много молочного', 'Сладкое', 'Большие порции']
            }
        };
        
        const WEEK_TRANSITION = [
            {
                day: 1,
                title: 'День 1: Знакомство',
                focus: 'Убираем сахар из напитков',
                tasks: [
                    'Пейте чай и кофе без сахара',
                    'Замените соки на воду с лимоном',
                    'Завтрак: добавьте 2 яйца к обычному рациону'
                ],
                tip: 'Это самый простой шаг. Сахар в напитках — пустые калории.',
                motivation: 'Первый день — уже победа! Тело начинает адаптироваться.'
            },
            {
                day: 2,
                title: 'День 2: Завтрак',
                focus: 'Белковый завтрак',
                tasks: [
                    'Завтрак: яйца на сале или топлёном масле + сыр',
                    'Без хлеба и сладкого утром',
                    'Добавьте горсть орехов'
                ],
                tip: 'Белок утром = стабильная энергия до обеда без перекусов.',
                motivation: 'Уже второй день! Заметьте, как меньше хочется сладкого к обеду.'
            },
            {
                day: 3,
                title: 'День 3: Обед',
                focus: 'Полноценный обед 12-14',
                tasks: [
                    'Обед строго в 12:00-14:00',
                    'Мясо/рыба + овощи + крупа',
                    'Без десерта сразу после еды'
                ],
                tip: 'В это время пищеварительные ферменты на пике активности.',
                motivation: 'Три дня! Тело уже начинает благодарить вас.'
            },
            {
                day: 4,
                title: 'День 4: Ужин',
                focus: 'Лёгкий ужин до 19:00',
                tasks: [
                    'Ужин: тушёные овощи + творог/простокваша',
                    'Без мяса вечером',
                    'Ужин за 3 часа до сна'
                ],
                tip: 'Лёгкий ужин = качественный сон = восстановление.',
                motivation: 'Четыре дня нового питания! Сон должен стать глубже.'
            },
            {
                day: 5,
                title: 'День 5: Убираем мучное',
                focus: 'День без хлеба и макарон',
                tasks: [
                    'Замените хлеб на овощи',
                    'Вместо макарон — гречка или рис',
                    'Если очень хочется — цельнозерновой хлебец'
                ],
                tip: 'Современная пшеница — не та, что ели наши предки. Организм её плохо переваривает.',
                motivation: 'Пять дней! Вы уже на полпути к новому образу жизни.'
            },
            {
                day: 6,
                title: 'День 6: Интеграция',
                focus: 'Собираем всё вместе',
                tasks: [
                    'Утро: белок + жиры + сложные углеводы',
                    'Обед 12-14: полноценный приём пищи',
                    'Ужин: овощи + молочное'
                ],
                tip: 'Сегодня практикуем весь цикл. Прислушивайтесь к телу.',
                motivation: 'Шесть дней! Тело уже перестраивается на новый режим.'
            },
            {
                day: 7,
                title: 'День 7: Закрепление',
                focus: 'Новая норма',
                tasks: [
                    'Повторите вчерашний день',
                    'Запишите свои ощущения',
                    'Отметьте изменения в энергии и настроении'
                ],
                tip: 'Неделя — это начало. Для устойчивых изменений нужен 21 день.',
                motivation: '🎉 Неделя позади! Вы заложили фундамент здорового питания.'
            }
        ];
        
        const NUTRITION_ACHIEVEMENTS = [
            { id: 'first_day', name: 'Первый шаг', icon: '🌱', description: 'Начать программу питания', condition: (d) => d >= 1 },
            { id: 'three_days', name: 'Три дня силы', icon: '💪', description: '3 дня нового питания', condition: (d) => d >= 3 },
            { id: 'week_complete', name: 'Неделя здоровья', icon: '🏆', description: 'Завершить 7-дневную программу', condition: (d) => d >= 7 },
            { id: 'two_weeks', name: 'Две недели', icon: '⭐', description: '14 дней правильного питания', condition: (d) => d >= 14 },
            { id: 'habit_formed', name: 'Привычка', icon: '🎯', description: '21 день — привычка сформирована', condition: (d) => d >= 21 }
        ];
        
        const NUTRITION_EXAMPLES = {
            success: [
                'Анна, 34 года: «После недели без сахара головные боли прошли, энергии стало больше»',
                'Михаил, 42 года: «Белковый завтрак — это открытие. До обеда не думаю о еде»',
                'Елена, 28 лет: «Тушёные овощи на ужин — сплю как младенец»',
                'Дмитрий, 45 лет: «За месяц минус 5 кг без диет, просто правильный режим»',
                'Ольга, 38 лет: «Депрессия отступила, когда наладила питание. Связь очевидна»'
            ],
            motivation: [
                'Еда — это информация для тела. Какую информацию вы отправляете?',
                'Вы не то, что вы едите. Вы то, что вы усваиваете.',
                'Каждый приём пищи — это выбор. Выбирайте жизнь.',
                'Тело — ваш дом. Из чего вы его строите?',
                'Правильное питание — не ограничение, а забота о себе.'
            ]
        };
        
        // Рецепты по умолчанию
        const DEFAULT_RECIPES = [
            {
                id: 'soup_chicken_cabbage',
                isDefault: true,
                title: '🍲 Суп из домашней птицы с капустой',
                category: 'soup',
                cookTime: '6-7 часов',
                servings: '6-8 порций',
                description: 'Наваристый целебный суп на костном бульоне с квашеной капустой и зеленью',
                ingredients: [
                    '🍗 Домашняя курица или индейка (голень, плечо, шея) — на кости',
                    '🥬 Квашеная капуста с клюквой или свежая капуста',
                    '🥕 Морковь — 2-3 шт.',
                    '🧅 Лук репчатый — 2 шт.',
                    '🫑 Болгарский перец — 1-2 шт.',
                    '🍅 Помидор — 1-2 шт.',
                    '🥒 Солёные огурцы — 2-3 шт.',
                    '🌿 Зелень свежая (укроп, петрушка)',
                    '🌿 Сныть сушёная — 1 ст.л.',
                    '🍋 Яблочный уксус натуральный или лимон',
                    '🌿 Лавровый лист — 2-3 шт.',
                    '⚫ Чёрный перец горошком — 5-7 шт.',
                    '🧂 Соль по вкусу'
                ],
                steps: [
                    {
                        title: 'Варим бульон',
                        text: 'Домашнюю курицу или индейку (на кости — голень, плечо и шея) отвариваем 5-6 часов на медленном огне. Это даёт насыщенный костный бульон, богатый коллагеном.',
                        time: '5-6 часов'
                    },
                    {
                        title: 'Подготовка мяса',
                        text: 'Вынимаем мясо из бульона и остужаем. Отделяем от костей и нарезаем порционными кусочками.',
                        time: '15 мин'
                    },
                    {
                        title: 'Добавляем овощи',
                        text: 'В кипящий бульон добавляем: квашеную капусту с клюквой (или нашинкованную свежую), морковь на крупной тёрке, нарезанный лук, болгарский перец и помидор.',
                        time: '5 мин'
                    },
                    {
                        title: 'Специи',
                        text: 'Добавляем лавровый лист и чёрный перец горошком.',
                        time: '1 мин'
                    },
                    {
                        title: 'Варим овощи',
                        text: 'Варим на среднем огне около 30 минут до мягкости овощей.',
                        time: '30 мин'
                    },
                    {
                        title: 'Финальные штрихи',
                        text: 'В конце добавляем порубленную свежую зелень, сушёную сныть и нарезанные солёные огурцы.',
                        time: '2 мин'
                    },
                    {
                        title: 'Мясо и кислинка',
                        text: 'Возвращаем порезанное мясо в суп. Добавляем натуральный яблочный уксус или сок лимона по вкусу для приятной кислинки.',
                        time: '2 мин'
                    }
                ],
                tips: [
                    '💡 Костный бульон — источник коллагена, полезен для суставов и кожи',
                    '💡 Квашеная капуста — пробиотик, поддерживает микробиом',
                    '💡 Сныть — русский суперфуд, богат витаминами',
                    '💡 Суп ещё вкуснее на второй день!'
                ],
                temperaments: ['melancholic', 'phlegmatic', 'sanguine', 'choleric']
            }
        ];

        const CRISIS_LINES = [
            { name: 'Телефон доверия', phone: '8-800-2000-122', note: 'Бесплатно, круглосуточно' },
            { name: 'Центр экстренной психологической помощи МЧС', phone: '8-499-216-50-50', note: 'Круглосуточно' },
            { name: 'Психологическая помощь (Москва)', phone: '051', note: 'Бесплатно с мобильного' },
            { name: 'Помощь при суицидальных мыслях', phone: '8-800-2000-122', note: 'Анонимно, бесплатно' }
        ];
        
        // PHQ-9 опросник
        const PHQ9_QUESTIONS = [
            'Мало интереса или удовольствия от дел',
            'Подавленность, тоска, безнадёжность',
            'Проблемы со сном (бессонница или сонливость)',
            'Усталость, упадок сил',
            'Плохой аппетит или переедание',
            'Плохое мнение о себе, чувство неудачника',
            'Трудности сосредоточиться (читать, смотреть ТВ)',
            'Замедленность или беспокойство в движениях',
            'Мысли о том, что лучше бы умереть'
        ];
        
        const PHQ9_OPTIONS = [
            { label: 'Совсем нет', value: 0 },
            { label: 'Несколько дней', value: 1 },
            { label: 'Больше половины дней', value: 2 },
            { label: 'Почти каждый день', value: 3 }
        ];

        const QUOTES = [
            { text: 'Свет — это жизнь, и жизнь — это свет', author: 'Олаф Кооб' },
            { text: 'Тепло размягчает затвердевшее', author: 'Олаф Кооб' },
            { text: 'Жёлтый — ближайший к свету цвет', author: 'И.В. Гёте' },
            { text: 'Самая тёмная ночь — перед рассветом', author: 'Народная мудрость' },
            { text: 'Природа — великий целитель', author: 'Гиппократ' },
            // Нисаргадатта Махарадж
            { text: 'Когда всё теряет смысл — ты близок к истине. Смысл — это конструкция ума', author: 'Нисаргадатта Махарадж' },
            { text: 'Страдание — это призыв к вниманию. Оно показывает, что ты на ложном пути', author: 'Нисаргадатта Махарадж' },
            { text: 'Депрессия — это когда ты устал быть тем, кем не являешься', author: 'Нисаргадатта Махарадж' },
            { text: 'Мудрость приходит через страдание. Без него мы остаёмся поверхностными', author: 'Нисаргадатта Махарадж' },
            { text: 'Отчаяние разрушает ложные надежды. Это благословение', author: 'Нисаргадатта Махарадж' },
            // Карл Рентц
            { text: 'Депрессия — это честность. Ты больше не можешь притворяться счастливым', author: 'Карл Рентц' },
            { text: 'Тьма — это просто свет, которого ты ещё не увидел', author: 'Карл Рентц' },
            { text: 'Когда иллюзии рушатся — больно. Но это боль исцеления', author: 'Карл Рентц' },
            { text: 'Ты не можешь найти себя. Ты можешь только потерять всё, что не ты', author: 'Карл Рентц' },
            { text: 'Депрессия — приглашение прекратить бегство от себя', author: 'Карл Рентц' },
            // Ошо
            { text: 'Депрессия означает, что ты подавлял что-то. Позволь этому проявиться', author: 'Ошо' },
            { text: 'Тьма — это не враг света. Тьма — это отсутствие света. Стань светом', author: 'Ошо' },
            { text: 'Печаль имеет глубину, которой нет у счастья. Через печаль ты растёшь', author: 'Ошо' },
            { text: 'Страдание — это сигнал тревоги. Что-то в жизни нужно изменить', author: 'Ошо' },
            { text: 'В депрессии ты ближе к себе, чем когда ты «счастлив» по чужим правилам', author: 'Ошо' },
            // Экхарт Толле
            { text: 'Депрессия — непринятие того, что есть. Прими момент — и страдание ослабнет', author: 'Экхарт Толле' },
            { text: 'Боль неизбежна. Страдание — выбор. Выбери присутствие', author: 'Экхарт Толле' },
            { text: 'Самое тёмное время — перед пробуждением. Тьма выталкивает тебя к свету', author: 'Экхарт Толле' },
            // Руми
            { text: 'Рана — это место, куда входит свет', author: 'Руми' },
            { text: 'Печаль вспахивает твоё сердце. Так оно становится способным вместить больше радости', author: 'Руми' },
            { text: 'Не отворачивайся от тьмы. Повернись к ней — и она станет светом', author: 'Руми' },
            // Пема Чодрон
            { text: 'Ощущение безнадёжности — хорошее место для начала. Отсюда возможно всё', author: 'Пема Чодрон' },
            { text: 'Боль указывает на места, где сердце ещё закрыто', author: 'Пема Чодрон' },
            // Рамана Махарши
            { text: 'Страдание заставляет искать. Без страдания не было бы поиска истины', author: 'Рамана Махарши' },
            { text: 'Тьма внутри — это непознанный свет', author: 'Рамана Махарши' },
            // Карл Юнг
            { text: 'Депрессия подобна даме в чёрном. Не гони её — пригласи за стол, выслушай', author: 'Карл Юнг' },
            { text: 'Нет пробуждения сознания без боли', author: 'Карл Юнг' },
            // Виктор Франкл
            { text: 'Страдание перестаёт быть страданием, когда обретает смысл', author: 'Виктор Франкл' },
            // Тит Нат Хан
            { text: 'Нет грязи — нет лотоса. Из страдания рождается мудрость', author: 'Тит Нат Хан' },
            // Адьяшанти
            { text: 'Депрессия — это сопротивление жизни. Прекрати сопротивляться — и жизнь потечёт', author: 'Адьяшанти' },
            { text: 'Иногда нужно полностью упасть, чтобы обнаружить, что падать некуда', author: 'Адьяшанти' }
        ];

        const LOCAL_RESPONSES = [
            'Я слышу тебя. Расскажи подробнее 🌤️',
            'Спасибо, что делишься. Это важно.',
            'Иногда просто побыть рядом — уже много.',
            'Даже в тёмной ночи звёзды светят.',
            'Тепло приходит постепенно, как весна.',
            'Ты не один в этом.'
        ];

        // ═══════════════════════════════════════════════════════════════
        // КОМПОНЕНТЫ
        // ═══════════════════════════════════════════════════════════════

        function BottomNav({ page, setPage }) {
            const items = [
                { id: 'home', icon: '🏠', label: 'Главная' },
                { id: 'nutrition', icon: '🥗', label: 'Питание' },
                { id: 'walks', icon: '🚶', label: 'Прогулки' },
                { id: 'practices', icon: '📖', label: 'Практики' },
                { id: 'profile', icon: '👤', label: 'Профиль' }
            ];
            return (
                <nav className="bottom-nav">
                    {items.map(item => (
                        <div key={item.id} className={`nav-item ${page === item.id ? 'active' : ''}`} onClick={() => setPage(item.id)}>
                            <span className="nav-icon">{item.icon}</span>
                            <span>{item.label}</span>
                        </div>
                    ))}
                </nav>
            );
        }

        function HomePage({ setPage, setPractice }) {
            const [state, setState] = useState('neutral');
            const [quote] = useState(QUOTES[Math.floor(Math.random() * QUOTES.length)]);
            const [showPracticeIntro, setShowPracticeIntro] = useState(null);
            const profile = DB.getProfile();
            const stateHistory = DB.getStateHistory();
            const practiceHistory = DB.get('practice_history', []);
            const hour = new Date().getHours();
            const naturalDay = NATURAL_WISDOM.getNaturalDay();
            const rhythm = NATURAL_WISDOM.getCurrentRhythm();
            const soulStatesRef = useRef(null);
            
            // Статистика использования
            const firstUseDate = DB.get('first_use_date', null);
            const daysSinceFirstUse = firstUseDate 
                ? Math.floor((Date.now() - new Date(firstUseDate).getTime()) / (1000 * 60 * 60 * 24)) + 1
                : 1;
            
            // Сохраняем дату первого использования
            useEffect(() => {
                if (!firstUseDate) {
                    DB.set('first_use_date', new Date().toISOString());
                }
            }, []);
            
            const usageStats = { daysSinceFirstUse };
            
            // Получаем адаптивное приветствие
            const adaptiveData = getAdaptiveGreeting(profile, stateHistory, usageStats);
            const greeting = adaptiveData.greeting;
            
            // Проверка заполненности профиля
            const isProfileComplete = profile.name && profile.temperament;
            
            // Биографические данные
            const currentSeptennial = profile.birthDate ? BIOGRAPHY_WORK.getCurrentSeptennial(profile.birthDate) : null;
            const upcomingTransitions = profile.birthDate ? BIOGRAPHY_WORK.getUpcomingTransitions(profile.birthDate) : [];
            const hasBiographyData = profile.birthDate && currentSeptennial;
            
            // Распорядок дня
            const schedule = DB.get('daily_schedule', null);
            const nextEvent = schedule ? DAILY_SCHEDULE.getNextEvent(schedule) : null;
            const currentEvent = schedule ? DAILY_SCHEDULE.getCurrentEvent(schedule) : null;
            const notificationsEnabled = DB.get('notifications_enabled', false);
            
            // Применение темной темы при загрузке
            useEffect(() => {
                const darkTheme = DB.get('dark_theme', false);
                if (darkTheme) {
                    document.documentElement.classList.add('dark-theme');
                }
            }, []);
            
            useEffect(() => { DB.addState(state); }, [state]);
            
            // Скролл к "Спокойно" при загрузке
            useEffect(() => {
                if (soulStatesRef.current) {
                    const neutralIndex = SOUL_STATES.findIndex(s => s.id === 'neutral');
                    const chipWidth = 85; // примерная ширина чипа
                    const containerWidth = soulStatesRef.current.offsetWidth;
                    const scrollPos = (neutralIndex * chipWidth) - (containerWidth / 2) + (chipWidth / 2);
                    soulStatesRef.current.scrollLeft = Math.max(0, scrollPos);
                }
            }, []);
            
            // Рекомендованная практика
            const stateRecs = {
                heavy: ['light_morning', 'warmth_heart', 'warmth_footbath'],
                low_energy: ['warmth_tea', 'walk_sunrise', 'warmth_footbath'],
                anxious: ['breathing', 'warmth_blanket', 'walk_forest'],
                neutral: ['nondual_presence', 'journal_deep', 'walk_observe'],
                hopeful: ['watercolor_sunrise', 'gratitude', 'walk_beauty'],
                grateful: ['gratitude', 'walk_beauty'],
                light: ['watercolor_emotion', 'walk_observe']
            };
            const recPracticeId = stateRecs[state]?.[0] || 'breathing';
            const recPractice = PRACTICES.find(p => p.id === recPracticeId);
            
            return (
                <div className="fade-in">
                    <h1 className="greeting">{greeting} ✨</h1>
                    <p className="greeting-sub">{rhythm.name} — {rhythm.quality}</p>
                    
                    {/* Адаптивное сообщение поддержки */}
                    {adaptiveData.encouragement && (
                        <div className="card" style={{ 
                            background: adaptiveData.trajectory?.isRollback 
                                ? 'linear-gradient(135deg, #FEE2E2, #FECACA)' 
                                : adaptiveData.trajectory?.heavyStreak >= 3 
                                    ? 'linear-gradient(135deg, #FEF3C7, #FDE68A)'
                                    : '#F0FDF4',
                            marginBottom: '0.75rem',
                            borderLeft: adaptiveData.trajectory?.isRollback 
                                ? '4px solid #EF4444' 
                                : adaptiveData.trajectory?.heavyStreak >= 3 
                                    ? '4px solid #F59E0B'
                                    : '4px solid var(--harmony-green)'
                        }}>
                            <p style={{ fontSize: '0.95rem', lineHeight: '1.5' }}>{adaptiveData.encouragement}</p>
                        </div>
                    )}
                    
                    {/* Подсказка для периода адаптации */}
                    {adaptiveData.guidance && daysSinceFirstUse <= 14 && (
                        <div className="card" style={{ 
                            background: '#EFF6FF',
                            marginBottom: '0.75rem',
                            fontSize: '0.85rem'
                        }}>
                            <div style={{ display: 'flex', alignItems: 'flex-start', gap: '0.5rem' }}>
                                <span>💡</span>
                                <div>
                                    <strong style={{ fontSize: '0.8rem', color: 'var(--twilight-blue)' }}>
                                        День {daysSinceFirstUse} из 14
                                    </strong>
                                    <p style={{ marginTop: '0.25rem', color: 'var(--text-secondary)' }}>
                                        {adaptiveData.guidance}
                                    </p>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Биографический инсайт */}
                    {hasBiographyData && upcomingTransitions.some(t => t.isImminent) && (
                        <div 
                            className="card card-clickable" 
                            style={{ 
                                background: 'linear-gradient(135deg, #F5F0FF, #EDE9FE)',
                                marginBottom: '0.75rem',
                                border: '2px solid var(--violet-soft)'
                            }}
                            onClick={() => setPage('profile')}
                        >
                            <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
                                <span style={{ fontSize: '1.5rem' }}>🌙</span>
                                <div style={{ flex: 1 }}>
                                    <strong style={{ color: 'var(--violet)' }}>
                                        {upcomingTransitions[0].name}
                                    </strong>
                                    <p style={{ fontSize: '0.8rem', color: 'var(--text-secondary)', marginTop: '0.25rem' }}>
                                        {upcomingTransitions[0].description || upcomingTransitions[0].meaning}
                                    </p>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Текущее семилетие - компактный вид */}
                    {hasBiographyData && !upcomingTransitions.some(t => t.isImminent) && (
                        <div 
                            className="card card-clickable" 
                            style={{ 
                                background: currentSeptennial.color,
                                marginBottom: '0.75rem'
                            }}
                            onClick={() => setPage('profile')}
                        >
                            <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                <span style={{ fontSize: '1.25rem' }}>{currentSeptennial.icon}</span>
                                <div style={{ flex: 1 }}>
                                    <strong style={{ fontSize: '0.85rem' }}>{currentSeptennial.name}</strong>
                                    <p style={{ fontSize: '0.75rem', color: 'var(--text-secondary)' }}>
                                        {currentSeptennial.theme}
                                    </p>
                                </div>
                                <span style={{ fontSize: '0.8rem', color: 'var(--text-tertiary)' }}>📖</span>
                            </div>
                        </div>
                    )}
                    
                    {/* Распорядок дня - активное/следующее событие */}
                    {schedule && (currentEvent || nextEvent) && (
                        <div 
                            className="card card-clickable" 
                            style={{ 
                                background: currentEvent 
                                    ? 'linear-gradient(135deg, #D1FAE5, #A7F3D0)' 
                                    : 'linear-gradient(135deg, #E0E7FF, #C7D2FE)',
                                marginBottom: '0.75rem',
                                border: currentEvent ? '2px solid #10B981' : 'none'
                            }}
                            onClick={() => setPage('profile')}
                        >
                            {currentEvent ? (
                                <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                    <span style={{ fontSize: '1.5rem' }}>{currentEvent.icon}</span>
                                    <div style={{ flex: 1 }}>
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '0.25rem' }}>
                                            <span style={{ 
                                                width: '8px', 
                                                height: '8px', 
                                                background: '#10B981', 
                                                borderRadius: '50%',
                                                animation: 'pulse 1.5s infinite'
                                            }}></span>
                                            <strong style={{ fontSize: '0.9rem' }}>Сейчас: {currentEvent.title}</strong>
                                        </div>
                                        <p style={{ fontSize: '0.75rem', color: 'var(--text-secondary)' }}>
                                            {currentEvent.minutesPassed} мин • осталось {currentEvent.duration - currentEvent.minutesPassed} мин
                                        </p>
                                    </div>
                                </div>
                            ) : nextEvent && (
                                <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                    <span style={{ fontSize: '1.25rem' }}>{nextEvent.icon}</span>
                                    <div style={{ flex: 1 }}>
                                        <strong style={{ fontSize: '0.85rem' }}>
                                            {nextEvent.time} — {nextEvent.title}
                                        </strong>
                                        <p style={{ fontSize: '0.75rem', color: 'var(--text-secondary)' }}>
                                            Через {nextEvent.minutesUntil < 60 
                                                ? `${nextEvent.minutesUntil} мин`
                                                : `${Math.floor(nextEvent.minutesUntil / 60)}ч ${nextEvent.minutesUntil % 60}мин`
                                            }
                                            {nextEvent.isTomorrow && ' (завтра)'}
                                        </p>
                                    </div>
                                    <span style={{ fontSize: '0.8rem' }}>📅</span>
                                </div>
                            )}
                        </div>
                    )}
                    
                    {/* Предложение заполнить профиль */}
                    {!isProfileComplete && (
                        <div 
                            className="card card-clickable" 
                            style={{ 
                                background: 'linear-gradient(135deg, #FEF3C7, #FDE68A)', 
                                marginBottom: '1rem',
                                border: '2px solid var(--amber)'
                            }}
                            onClick={() => setPage('profile')}
                        >
                            <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
                                <span style={{ fontSize: '2rem' }}>👤</span>
                                <div style={{ flex: 1 }}>
                                    <strong>Заполните профиль</strong>
                                    <p style={{ fontSize: '0.8rem', color: 'var(--text-secondary)', marginTop: '0.25rem' }}>
                                        {!profile.name && !profile.temperament 
                                            ? 'Укажите имя и пройдите тест на темперамент для персональных рекомендаций'
                                            : !profile.name 
                                                ? 'Укажите ваше имя'
                                                : 'Пройдите тест на темперамент для персональных рекомендаций'
                                        }
                                    </p>
                                </div>
                                <span style={{ fontSize: '1.25rem' }}>→</span>
                            </div>
                        </div>
                    )}
                    
                    <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '1rem' }}>
                        <span className="nature-badge" style={{ background: naturalDay.color + '20', color: naturalDay.color }}>
                            {naturalDay.icon} {naturalDay.name}
                        </span>
                    </div>

                    <h3>Как на душе?</h3>
                    <div className="soul-states" ref={soulStatesRef}>
                        {SOUL_STATES.map(s => (
                            <div key={s.id} className={`soul-chip ${state === s.id ? 'active' : ''}`} onClick={() => setState(s.id)}>
                                <span className="soul-emoji">{s.emoji}</span>
                                <span className="soul-label">{s.label}</span>
                            </div>
                        ))}
                    </div>

                    {recPractice && (
                        <div className="recommendation-card" onClick={() => {
                            const isFirstUse = isFirstPracticeUse(recPractice.id, practiceHistory);
                            const description = getPracticeDescription(recPractice.id);
                            if (isFirstUse && description) {
                                setShowPracticeIntro({ practice: recPractice, description });
                            } else {
                                setPractice(recPractice); 
                                setPage('practice');
                            }
                        }}>
                            <div className="recommendation-title">💡 Рекомендуем</div>
                            <h3>{recPractice.title}</h3>
                            <p className="recommendation-reason">{recPractice.short}</p>
                            {isFirstPracticeUse(recPractice.id, practiceHistory) && (
                                <span style={{ fontSize: '0.75rem', color: 'var(--twilight-blue)', display: 'block', marginBottom: '0.5rem' }}>
                                    🆕 Первый раз? Узнаете о практике!
                                </span>
                            )}
                            <button className="btn btn-primary btn-small">Начать</button>
                        </div>
                    )}

                    <div className="grid-2">
                        <div className="card card-clickable" onClick={() => setPage('day')}>
                            <div style={{ 
                                width: '40px', 
                                height: '40px', 
                                background: 'linear-gradient(180deg, #DC2626 0%, #DC2626 30%, white 30%)',
                                borderRadius: '6px',
                                display: 'flex',
                                flexDirection: 'column',
                                alignItems: 'center',
                                justifyContent: 'flex-end',
                                marginBottom: '0.25rem',
                                border: '1px solid #e0e0e0',
                                boxShadow: '0 1px 2px rgba(0,0,0,0.1)'
                            }}>
                                <span style={{ 
                                    fontSize: '1.1rem', 
                                    fontWeight: 'bold', 
                                    color: '#1a1a1a',
                                    lineHeight: 1,
                                    marginBottom: '2px'
                                }}>{new Date().getDate()}</span>
                                <span style={{ 
                                    fontSize: '0.55rem', 
                                    color: '#666',
                                    textTransform: 'uppercase',
                                    marginBottom: '3px'
                                }}>{['янв','фев','мар','апр','май','июн','июл','авг','сен','окт','ноя','дек'][new Date().getMonth()]}</span>
                            </div>
                            <strong>Мой день</strong>
                            <p style={{ fontSize: '0.75rem', color: 'var(--text-tertiary)' }}>План на сегодня</p>
                        </div>
                        <div className="card card-clickable" onClick={() => setPage('journal')}>
                            <div style={{ fontSize: '1.25rem', marginBottom: '0.25rem' }}>📝</div>
                            <strong>Дневник</strong>
                            <p style={{ fontSize: '0.75rem', color: 'var(--text-tertiary)' }}>Записать мысли</p>
                        </div>
                    </div>

                    {/* Вечерняя ванночка */}
                    {hour >= 19 && hour <= 22 && (
                        <div className="card" style={{ background: '#F0FDF4', marginTop: '0.5rem' }} onClick={() => { const p = PRACTICES.find(pr => pr.id === 'warmth_footbath'); if(p) { setPractice(p); setPage('practice'); } }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                <span style={{ fontSize: '1.5rem' }}>🛁</span>
                                <div>
                                    <strong>Вечерняя ванночка</strong>
                                    <p style={{ fontSize: '0.75rem', color: 'var(--text-secondary)' }}>
                                        Масла дня: {naturalDay.oils.join(', ')}
                                    </p>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* СПА на выходных */}
                    {(new Date().getDay() === 0 || new Date().getDay() === 6) && (
                        <div className="card" style={{ background: '#FEF3C7', marginTop: '0.5rem' }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', marginBottom: '0.5rem' }}>
                                <span style={{ fontSize: '1.25rem' }}>♨️</span>
                                <strong>Выходной — время для СПА</strong>
                            </div>
                            <div style={{ display: 'flex', gap: '0.4rem', flexWrap: 'wrap' }}>
                                <button className="btn btn-small btn-secondary" onClick={() => { const p = PRACTICES.find(pr => pr.id === 'sauna'); if(p) { setPractice(p); setPage('practice'); } }}>
                                    🧖 Баня
                                </button>
                                <button className="btn btn-small btn-secondary" onClick={() => { const p = PRACTICES.find(pr => pr.id === 'bath_full'); if(p) { setPractice(p); setPage('practice'); } }}>
                                    🛁 Ванна
                                </button>
                                <button className="btn btn-small btn-secondary" onClick={() => { const p = PRACTICES.find(pr => pr.id === 'massage_self'); if(p) { setPractice(p); setPage('practice'); } }}>
                                    💆 Массаж
                                </button>
                            </div>
                        </div>
                    )}
                    
                    {/* Напоминание о бане в запланированный день */}
                    {(() => {
                        const saunaDay = DB.getSaunaDay();
                        const today = new Date().getDay();
                        const dayNames = ['воскресенье', 'понедельник', 'вторник', 'среду', 'четверг', 'пятницу', 'субботу'];
                        const dayOils = naturalDay.oils;
                        
                        if (saunaDay !== null && saunaDay === today) {
                            return (
                                <div className="card" style={{ background: 'linear-gradient(135deg, #FEE8D6, #FFE4C9)', marginTop: '0.5rem' }}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', marginBottom: '0.5rem' }}>
                                        <span style={{ fontSize: '1.5rem' }}>🧖</span>
                                        <div>
                                            <strong>Сегодня — день бани!</strong>
                                            <p style={{ fontSize: '0.75rem', color: 'var(--text-secondary)' }}>
                                                Масла дня: {dayOils.join(', ')} — {naturalDay.oilEffect.toLowerCase()}
                                            </p>
                                        </div>
                                    </div>
                                    <button 
                                        className="btn btn-primary btn-small" 
                                        onClick={() => { const p = PRACTICES.find(pr => pr.id === 'sauna'); if(p) { setPractice(p); setPage('practice'); } }}
                                    >
                                        Открыть практику
                                    </button>
                                </div>
                            );
                        }
                        return null;
                    })()}
                    
                    {/* Чудо дня вечером */}
                    {hour >= 21 && (
                        <div className="card card-clickable" style={{ background: '#F5F0FF', marginTop: '0.5rem' }} onClick={() => { const p = PRACTICES.find(pr => pr.id === 'wonder_of_day'); if(p) { setPractice(p); setPage('practice'); } }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                <span style={{ fontSize: '1.25rem' }}>✨</span>
                                <div>
                                    <strong>Чудо дня</strong>
                                    <p style={{ fontSize: '0.75rem', color: 'var(--text-secondary)' }}>Вечерняя рефлексия</p>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="quote-card" style={{ marginTop: '0.75rem' }}>
                        <p className="quote-text">«{quote.text}»</p>
                        <p className="quote-author">— {quote.author}</p>
                    </div>
                    
                    {/* Модальное окно описания практики при первом использовании */}
                    {showPracticeIntro && (
                        <div className="modal-overlay" onClick={() => setShowPracticeIntro(null)}>
                            <div className="modal" onClick={e => e.stopPropagation()} style={{ maxHeight: '85vh', overflow: 'auto' }}>
                                <h2 style={{ marginBottom: '0.5rem', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                    <span style={{ fontSize: '1.5rem' }}>🌱</span>
                                    {showPracticeIntro.description.title}
                                </h2>
                                
                                <div style={{ background: '#F0FDF4', padding: '1rem', borderRadius: '12px', marginBottom: '1rem' }}>
                                    <h4 style={{ fontSize: '0.9rem', color: 'var(--harmony-green)', marginBottom: '0.5rem' }}>
                                        ✨ Суть практики
                                    </h4>
                                    <p style={{ fontSize: '0.9rem', lineHeight: '1.6' }}>
                                        {showPracticeIntro.description.essence}
                                    </p>
                                </div>
                                
                                <div style={{ background: '#EFF6FF', padding: '1rem', borderRadius: '12px', marginBottom: '1rem' }}>
                                    <h4 style={{ fontSize: '0.9rem', color: 'var(--twilight-blue)', marginBottom: '0.5rem' }}>
                                        🔬 Научное обоснование
                                    </h4>
                                    <p style={{ fontSize: '0.85rem', lineHeight: '1.5', color: 'var(--text-secondary)' }}>
                                        {showPracticeIntro.description.science}
                                    </p>
                                </div>
                                
                                <div style={{ background: '#FEF3C7', padding: '1rem', borderRadius: '12px', marginBottom: '1.5rem' }}>
                                    <h4 style={{ fontSize: '0.9rem', color: '#92400E', marginBottom: '0.5rem' }}>
                                        💫 Чего ожидать
                                    </h4>
                                    <p style={{ fontSize: '0.85rem', lineHeight: '1.5', color: 'var(--text-secondary)' }}>
                                        {showPracticeIntro.description.whatToExpect}
                                    </p>
                                </div>
                                
                                <div style={{ display: 'flex', gap: '0.5rem' }}>
                                    <button 
                                        className="btn btn-secondary" 
                                        style={{ flex: 1 }}
                                        onClick={() => setShowPracticeIntro(null)}
                                    >
                                        Позже
                                    </button>
                                    <button 
                                        className="btn btn-primary" 
                                        style={{ flex: 2 }}
                                        onClick={() => {
                                            setPractice(showPracticeIntro.practice);
                                            setShowPracticeIntro(null);
                                            setPage('practice');
                                        }}
                                    >
                                        Начать практику
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function DayPage({ setPage, setPractice }) {
            const hour = new Date().getHours();
            const naturalDay = NATURAL_WISDOM.getNaturalDay();
            const profile = DB.getProfile();
            const temperament = profile.temperament || 'melancholic';
            const tempInfo = TEMPERAMENT_NUTRITION[temperament];
            
            // План питания по темпераменту
            const getMealRecommendation = (mealType) => {
                // Полный рацион по темпераментам (Палео)
                const mealsByTemperament = {
                    sanguine: {
                        breakfast: {
                            foods: ['🥚 Яйца 3шт на сале', '🧈 Топлёное масло', '🌿 Зелень', '🧀 Твёрдый сыр'],
                            tip: 'Много белка и животных жиров для стабильной энергии'
                        },
                        snack1: {
                            foods: ['🥜 Грецкие орехи', '🍎 Яблоко', '🥕 Морковь'],
                            tip: 'Полезные жиры вместо быстрых перекусов'
                        },
                        lunch: {
                            foods: ['🍗 Курица гриль', '🥗 Салат со сметаной', '🌿 Укроп/петрушка', '🥒 Овощи'],
                            tip: 'Полноценный обед — не пропускайте!'
                        },
                        snack2: {
                            foods: ['🧀 Творог 9%', '🫐 Ягоды', '🥜 Кешью'],
                            tip: 'Белок поддержит до ужина'
                        },
                        dinner: {
                            foods: ['🐟 Рыба на топлёном масле', '🥦 Брокколи', '🥬 Шпинат', '🌿 Укроп'],
                            tip: 'Лёгкий белок + овощи, без круп'
                        }
                    },
                    choleric: {
                        breakfast: {
                            foods: ['🥚 Яйца 2шт', '🥒 Огурец', '🥬 Листья салата', '🧈 Топлёное масло'],
                            tip: 'Охлаждающие продукты для баланса огня'
                        },
                        snack1: {
                            foods: ['🥒 Огурец', '🍅 Помидор', '🌿 Руккола', '🧀 Моцарелла'],
                            tip: 'Свежие овощи охлаждают'
                        },
                        lunch: {
                            foods: ['🐟 Рыба на пару', '🥗 Салат со сметаной', '🌿 Укроп', '🥒 Кабачки'],
                            tip: 'Меньше мяса, больше рыбы и овощей'
                        },
                        snack2: {
                            foods: ['🥛 Кефир', '🥒 Сельдерей', '🌿 Петрушка', '🥜 Тыкв. семечки'],
                            tip: 'Охлаждающий полдник'
                        },
                        dinner: {
                            foods: ['🥗 Салат со сметаной', '🥬 Листья салата', '🧀 Адыгейский сыр', '🥒 Огурцы'],
                            tip: 'Максимально лёгкий, без острого'
                        }
                    },
                    melancholic: {
                        breakfast: {
                            foods: ['🥣 Каша на топлёном масле', '🥚 Яйца на сале', '🌿 Зелень', '🌰 Орехи'],
                            tip: 'Только тёплая пища для согревания'
                        },
                        snack1: {
                            foods: ['🍵 Имбирный чай', '🥜 Миндаль', '🍯 Мёд'],
                            tip: 'Согревающий перекус'
                        },
                        lunch: {
                            foods: ['🍲 Костный бульон', '🦃 Индейка на сале', '🥕 Морковь', '🌿 Зелень'],
                            tip: 'Наваристый суп и тёплое мясо'
                        },
                        snack2: {
                            foods: ['🍵 Травяной чай', '🧀 Творог со сметаной', '🍯 С корицей'],
                            tip: 'Тёплый творог с пряностями'
                        },
                        dinner: {
                            foods: ['🥕 Овощи на топлёном масле', '🌿 Укроп/петрушка', '🧅 Лук', '🥛 Ряженка'],
                            tip: 'Приготовленная пища, не сырая!'
                        }
                    },
                    phlegmatic: {
                        breakfast: {
                            foods: ['🥚 Яйца на сале с перцем', '🌿 Руккола', '🌶️ Куркума', '🍵 Зелёный чай'],
                            tip: 'Острые специи разгоняют метаболизм'
                        },
                        snack1: {
                            foods: ['🥕 Морковные палочки', '🌿 Сельдерей', '🥬 Листья салата', '🍋 Лимонная вода'],
                            tip: 'Лёгкий и острый'
                        },
                        lunch: {
                            foods: ['🍗 Курица на топлёном масле', '🥗 Руккола', '🧄 Чеснок', '🌶️ Карри'],
                            tip: 'Умеренная порция с пряностями'
                        },
                        snack2: {
                            foods: ['🍵 Имбирный чай', '🌿 Зелень', '🥜 Немного орехов', '🥒 Овощи'],
                            tip: 'Минимум молочного'
                        },
                        dinner: {
                            foods: ['🥗 Лёгкий салат', '🐟 Рыба на топлёном масле', '🌿 Зелень'],
                            tip: 'Маленькая порция, больше зелени'
                        }
                    }
                };
                
                const meals = mealsByTemperament[temperament] || mealsByTemperament.melancholic;
                const meal = meals[mealType];
                
                // Общие советы по темпераменту
                const tempTips = {
                    sanguine: '🌞 Регулярность важнее всего!',
                    choleric: '🔥 Охлаждайте внутренний огонь',
                    melancholic: '🌙 Согревайте тело и душу',
                    phlegmatic: '💧 Разгоняйте метаболизм'
                };
                
                return {
                    ...meal,
                    tempTip: tempTips[temperament]
                };
            };
            
            const dayPlan = [
                { time: '6-7', name: 'Пробуждение', icon: '🌅', practices: ['light_morning', 'breathing'], active: hour >= 6 && hour < 7 },
                { time: '7-9', name: 'Завтрак', icon: '🍳', meal: 'breakfast', active: hour >= 7 && hour < 9 },
                { time: '9-11', name: 'Утренняя активность', icon: '💭', practices: ['journal_deep', 'psychoeducation'], active: hour >= 9 && hour < 11 },
                { time: '10:30-11', name: 'Перекус', icon: '🥜', meal: 'snack1', active: hour >= 10 && hour < 11 },
                { time: '12-14', name: 'Обед', icon: '🍽️', meal: 'lunch', active: hour >= 12 && hour < 14 },
                { time: '14-16', name: 'День', icon: '⚡', practices: ['walk_observe', 'warmth_heart'], active: hour >= 14 && hour < 16 },
                { time: '15:30-16:30', name: 'Полдник', icon: '🧀', meal: 'snack2', active: hour >= 15 && hour < 17 },
                { time: '17-18', name: 'Вечерняя прогулка', icon: '🚶', practices: ['walk_sunset', 'gratitude'], active: hour >= 17 && hour < 18 },
                { time: '18-19', name: 'Ужин', icon: '🥗', meal: 'dinner', active: hour >= 18 && hour < 19 },
                { time: '20-22', name: 'СПА-время', icon: '🛁', practices: ['warmth_footbath', 'bath_full', 'massage_self'], oils: naturalDay.oils, active: hour >= 20 && hour < 22 },
                { time: '22-23', name: 'Перед сном', icon: '🌙', practices: ['wonder_of_day', 'gratitude'], active: hour >= 22 && hour < 23 }
            ];
            
            return (
                <div className="fade-in">
                    <h1>Мой день</h1>
                    <p style={{ color: 'var(--text-secondary)', fontSize: '0.9rem', marginBottom: '0.5rem' }}>
                        {naturalDay.icon} {naturalDay.theme} — {naturalDay.oilEffect}
                    </p>
                    
                    {/* Темперамент и питание */}
                    <div className="card" style={{ marginBottom: '1rem', padding: '0.75rem' }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', marginBottom: '0.25rem' }}>
                            <span style={{ fontSize: '1.25rem' }}>{tempInfo?.icon || '🌙'}</span>
                            <strong>{tempInfo?.title || 'Меланхолик'}</strong>
                        </div>
                        <p style={{ fontSize: '0.75rem', color: 'var(--text-secondary)' }}>
                            {tempInfo?.tendency}
                        </p>
                    </div>
                    
                    {dayPlan.map((period, idx) => {
                        const mealData = period.meal ? getMealRecommendation(period.meal) : null;
                        
                        return (
                            <div key={idx} className={`day-period ${period.active ? 'active' : ''}`}>
                                <div className="day-period-header">
                                    <span className="day-period-icon">{period.icon}</span>
                                    <strong>{period.name}</strong>
                                    <span className="day-period-time">{period.time}</span>
                                </div>
                                
                                {/* Блок питания */}
                                {mealData && (
                                    <div style={{ marginTop: '0.5rem' }}>
                                        <p style={{ fontSize: '0.8rem', color: 'var(--text-secondary)', marginBottom: '0.4rem' }}>
                                            💡 {mealData.tip}
                                        </p>
                                        <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.3rem', marginBottom: '0.4rem' }}>
                                            {mealData.foods.map((food, i) => (
                                                <span key={i} style={{ 
                                                    background: 'var(--sand, #F5EDE0)', 
                                                    padding: '0.2rem 0.5rem', 
                                                    borderRadius: '10px',
                                                    fontSize: '0.7rem'
                                                }}>{food}</span>
                                            ))}
                                        </div>
                                        {mealData.tempTip && period.active && (
                                            <p style={{ 
                                                fontSize: '0.75rem', 
                                                color: 'var(--amber)', 
                                                fontStyle: 'italic',
                                                marginTop: '0.25rem'
                                            }}>
                                                {tempInfo?.icon} {mealData.tempTip}
                                            </p>
                                        )}
                                    </div>
                                )}
                                
                                {period.oils && (
                                    <p style={{ fontSize: '0.75rem', color: 'var(--text-secondary)', marginBottom: '0.5rem' }}>
                                        🌿 Масла: {period.oils.join(', ')}
                                    </p>
                                )}
                                {period.active && period.practices && (
                                    <div style={{ display: 'flex', gap: '0.4rem', flexWrap: 'wrap', marginTop: '0.5rem' }}>
                                        {period.practices.map(pId => {
                                            const p = PRACTICES.find(pr => pr.id === pId);
                                            if (!p) return null;
                                            return (
                                                <button key={pId} className="btn btn-primary btn-small" onClick={() => { setPractice(p); setPage('practice'); }}>
                                                    {p.title}
                                                </button>
                                            );
                                        })}
                                    </div>
                                )}
                            </div>
                        );
                    })}
                    
                    {/* Кнопка перехода к питанию */}
                    <div 
                        className="card card-clickable" 
                        style={{ marginTop: '1rem', textAlign: 'center' }}
                        onClick={() => setPage('nutrition')}
                    >
                        <span style={{ fontSize: '1.5rem' }}>🥗</span>
                        <p style={{ fontWeight: 'bold', marginTop: '0.25rem' }}>Подробнее о питании</p>
                        <p style={{ fontSize: '0.75rem', color: 'var(--text-secondary)' }}>7-дневная программа</p>
                    </div>
                </div>
            );
        }

        function PracticesPage({ setPage, setPractice }) {
            const [cat, setCat] = useState(null);
            const filtered = cat ? PRACTICES.filter(p => p.category === cat) : PRACTICES;
            
            return (
                <div className="fade-in">
                    <h1>Практики</h1>
                    <div className="category-pills">
                        <span className={`category-pill ${!cat ? 'active' : ''}`} onClick={() => setCat(null)}>Все</span>
                        {CATEGORIES.map(c => (
                            <span key={c.id} className={`category-pill ${cat === c.id ? 'active' : ''}`} onClick={() => setCat(c.id)}>
                                {c.icon} {c.name}
                            </span>
                        ))}
                    </div>
                    
                    {filtered.map(p => (
                        <div key={p.id} className="card card-clickable" style={{ background: p.bg }} onClick={() => { setPractice(p); setPage('practice'); }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '0.5rem' }}>
                                <span>{CATEGORIES.find(c => c.id === p.category)?.icon}</span>
                                <strong>{p.title}</strong>
                            </div>
                            <p style={{ fontSize: '0.85rem' }}>{p.short}</p>
                            <div className="practice-meta">
                                <span>⏱️ {p.duration} мин</span>
                            </div>
                        </div>
                    ))}
                </div>
            );
        }

        // ═══════════════════════════════════════════════════════════════
        // ТРЕКЕР ПРОГУЛОК
        // ═══════════════════════════════════════════════════════════════
        
        function WalkTrackerPage({ setPage, setPractice }) {
            const [stats, setStats] = useState(DB.getWalkStats());
            const [showAddWalk, setShowAddWalk] = useState(false);
            const [showHistory, setShowHistory] = useState(false);
            const [showAnalytics, setShowAnalytics] = useState(false);
            const [showHealthInfo, setShowHealthInfo] = useState(false);
            const [walkDuration, setWalkDuration] = useState(30);
            const [walkType, setWalkType] = useState('city');
            const [walkMood, setWalkMood] = useState('neutral');
            const [walkNotes, setWalkNotes] = useState('');
            const [motivation, setMotivation] = useState('');
            const [activeWalk, setActiveWalk] = useState(null);
            const [walkTimer, setWalkTimer] = useState(0);
            const [healthInsight, setHealthInsight] = useState(HEALTH_INSIGHTS[Math.floor(Math.random() * HEALTH_INSIGHTS.length)]);
            const [autoDetectEnabled, setAutoDetectEnabled] = useState(DB.get('walk_auto_detect', true));
            const [showTypeSelector, setShowTypeSelector] = useState(false);
            const [stepCount, setStepCount] = useState(0);
            const [isMoving, setIsMoving] = useState(false);
            const [noMovementTime, setNoMovementTime] = useState(0);
            const [showStopWarning, setShowStopWarning] = useState(false);
            const lastMovementRef = useRef(Date.now());
            
            const goal = DB.getWalkGoal();
            const stateHistory = DB.getStateHistory();
            const walks = DB.getWalks();
            const currentState = stateHistory.length > 0 ? stateHistory[stateHistory.length - 1].state : 'neutral';
            const recommendation = WALK_RECOMMENDATIONS[currentState] || WALK_RECOMMENDATIONS.neutral;
            const correlation = analyzeWalkMoodCorrelation(walks, stateHistory);
            
            // Типы прогулок с иконками
            const WALK_TYPES = [
                { id: 'city', icon: '🏙️', label: 'Город', desc: 'Движение по городу' },
                { id: 'observe', icon: '👁️', label: 'Наблюдение', desc: 'Осознанная прогулка' },
                { id: 'forest', icon: '🌳', label: 'Лес/Парк', desc: 'На природе' },
                { id: 'active', icon: '🏃', label: 'Активная', desc: 'Быстрая ходьба' },
                { id: 'beauty', icon: '✨', label: 'Красота', desc: 'Поиск прекрасного' }
            ];
            
            // Вибрация
            const vibrate = (pattern) => {
                if ('vibrate' in navigator) {
                    navigator.vibrate(pattern);
                }
            };
            
            // Автоопределение движения через акселерометр
            useEffect(() => {
                if (!autoDetectEnabled || activeWalk) return;
                
                let lastAccel = { x: 0, y: 0, z: 0 };
                let movementCount = 0;
                let checkInterval;
                let motionHandler;
                
                const startAutoDetection = () => {
                    if ('DeviceMotionEvent' in window) {
                        // Запрос разрешения для iOS 13+
                        if (typeof DeviceMotionEvent.requestPermission === 'function') {
                            DeviceMotionEvent.requestPermission()
                                .then(response => {
                                    if (response === 'granted') {
                                        setupMotionListener();
                                    }
                                })
                                .catch(console.error);
                        } else {
                            setupMotionListener();
                        }
                    }
                };
                
                const setupMotionListener = () => {
                    motionHandler = (event) => {
                        const accel = event.accelerationIncludingGravity;
                        if (!accel) return;
                        
                        const deltaX = Math.abs(accel.x - lastAccel.x);
                        const deltaY = Math.abs(accel.y - lastAccel.y);
                        const deltaZ = Math.abs(accel.z - lastAccel.z);
                        const totalDelta = deltaX + deltaY + deltaZ;
                        
                        lastAccel = { x: accel.x, y: accel.y, z: accel.z };
                        
                        // Порог для определения шага (настраиваемый)
                        if (totalDelta > 3 && totalDelta < 20) {
                            movementCount++;
                        }
                    };
                    
                    window.addEventListener('devicemotion', motionHandler);
                    
                    // Проверяем накопленные движения каждые 5 секунд
                    checkInterval = setInterval(() => {
                        if (movementCount >= 8 && !activeWalk && !showTypeSelector) {
                            // Обнаружено движение!
                            console.log('Движение обнаружено! Вибрация...');
                            setIsMoving(true);
                            vibrate([300, 150, 300]); // Усиленная двойная вибрация при обнаружении
                            setShowTypeSelector(true);
                            
                            // Автостарт через 10 секунд если не выбран тип
                            setTimeout(() => {
                                setShowTypeSelector(prev => {
                                    if (prev && !activeWalk) {
                                        // Запускаем с типом по умолчанию "город"
                                        console.log('Автостарт прогулки! Вибрация...');
                                        setWalkType('city');
                                        startWalkAuto('city');
                                    }
                                    return false;
                                });
                            }, 10000);
                        }
                        movementCount = 0;
                    }, 5000);
                };
                
                startAutoDetection();
                
                return () => {
                    if (motionHandler) {
                        window.removeEventListener('devicemotion', motionHandler);
                    }
                    if (checkInterval) {
                        clearInterval(checkInterval);
                    }
                };
            }, [autoDetectEnabled, activeWalk, showTypeSelector]);
            
            // Отслеживание движения во время активной прогулки
            useEffect(() => {
                if (!activeWalk || !autoDetectEnabled) return;
                
                lastMovementRef.current = Date.now();
                let movementCount = 0;
                let checkInterval;
                let motionHandler;
                
                const setupActiveWalkMotionListener = () => {
                    if ('DeviceMotionEvent' in window) {
                        motionHandler = (event) => {
                            const accel = event.accelerationIncludingGravity;
                            if (!accel) return;
                            
                            const totalDelta = Math.abs(accel.x) + Math.abs(accel.y) + Math.abs(accel.z);
                            
                            // Порог для определения движения
                            if (totalDelta > 12) {
                                movementCount++;
                                if (movementCount >= 3) {
                                    lastMovementRef.current = Date.now();
                                    movementCount = 0;
                                    setNoMovementTime(0);
                                    setShowStopWarning(false);
                                }
                            }
                        };
                        
                        window.addEventListener('devicemotion', motionHandler);
                        
                        // Проверяем каждую секунду
                        checkInterval = setInterval(() => {
                            const timeSinceMovement = Math.floor((Date.now() - lastMovementRef.current) / 1000);
                            setNoMovementTime(timeSinceMovement);
                            
                            // Показать предупреждение после 7 секунд
                            if (timeSinceMovement >= 7 && timeSinceMovement < 10) {
                                setShowStopWarning(true);
                                if (timeSinceMovement === 7) {
                                    vibrate([100, 50, 100]); // Предупреждающая вибрация
                                }
                            }
                            
                            // Автостоп после 10 секунд без движения
                            if (timeSinceMovement >= 10) {
                                vibrate([200, 100, 200, 100, 300]); // Финальная вибрация
                                finishWalkAuto();
                            }
                        }, 1000);
                    }
                };
                
                setupActiveWalkMotionListener();
                
                return () => {
                    if (motionHandler) {
                        window.removeEventListener('devicemotion', motionHandler);
                    }
                    if (checkInterval) {
                        clearInterval(checkInterval);
                    }
                };
            }, [activeWalk, autoDetectEnabled]);
            
            // Автозавершение прогулки
            const finishWalkAuto = () => {
                const duration = Math.round(walkTimer / 60);
                if (duration > 0) {
                    const hour = new Date().getHours();
                    let timeOfDay = 'day';
                    if (hour >= 5 && hour < 8) timeOfDay = 'sunrise';
                    else if (hour >= 17 && hour < 20) timeOfDay = 'sunset';
                    else if (hour >= 20 || hour < 5) timeOfDay = 'night';
                    
                    DB.addWalk({
                        duration,
                        type: walkType,
                        mood: walkMood,
                        notes: walkNotes + (walkNotes ? '\n' : '') + '(авто-стоп)',
                        timeOfDay
                    });
                    setStats(DB.getWalkStats());
                    setMotivation('⏹️ Прогулка завершена автоматически');
                }
                setActiveWalk(null);
                setWalkTimer(0);
                setWalkNotes('');
                setIsMoving(false);
                setNoMovementTime(0);
                setShowStopWarning(false);
            };
            
            // Получить случайную мотивацию
            const getMotivation = (type, currentWalkType = null) => {
                // Если это активная прогулка и есть фразы для конкретного типа
                if (type === 'during' && currentWalkType && WALK_MOTIVATIONS[currentWalkType]) {
                    const typeMessages = WALK_MOTIVATIONS[currentWalkType];
                    return typeMessages[Math.floor(Math.random() * typeMessages.length)];
                }
                const messages = WALK_MOTIVATIONS[type];
                return messages ? messages[Math.floor(Math.random() * messages.length)] : '';
            };
            
            // Проверка достижений
            const checkAchievements = () => {
                const earnedAchievements = WALK_ACHIEVEMENTS.filter(a => a.condition(stats));
                return earnedAchievements;
            };
            
            // Таймер для активной прогулки
            useEffect(() => {
                let interval;
                if (activeWalk) {
                    interval = setInterval(() => {
                        setWalkTimer(Math.floor((Date.now() - activeWalk) / 1000));
                    }, 1000);
                }
                return () => clearInterval(interval);
            }, [activeWalk]);
            
            // Смена фраз каждые 30 секунд во время прогулки
            useEffect(() => {
                let phraseInterval;
                if (activeWalk && walkType) {
                    phraseInterval = setInterval(() => {
                        setMotivation(getMotivation('during', walkType));
                    }, 30000); // Каждые 30 секунд
                }
                return () => clearInterval(phraseInterval);
            }, [activeWalk, walkType]);
            
            // Начать прогулку (ручной запуск)
            const startWalk = () => {
                setActiveWalk(Date.now());
                setMotivation(getMotivation('start'));
                vibrate(100);
            };
            
            // Начать прогулку (автозапуск)
            const startWalkAuto = (type) => {
                setWalkType(type || 'city');
                setActiveWalk(Date.now());
                setMotivation('🚶 Прогулка началась автоматически!');
                setShowTypeSelector(false);
                vibrate([200, 100, 200, 100, 300]); // Длинная вибрация для подтверждения старта
            };
            
            // Выбор типа при автоопределении
            const selectTypeAndStart = (type) => {
                setWalkType(type);
                setShowTypeSelector(false);
                startWalkAuto(type);
            };
            
            // Завершить прогулку
            const finishWalk = () => {
                const duration = Math.round(walkTimer / 60);
                if (duration > 0) {
                    const hour = new Date().getHours();
                    let timeOfDay = 'day';
                    if (hour >= 5 && hour < 8) timeOfDay = 'sunrise';
                    else if (hour >= 17 && hour < 20) timeOfDay = 'sunset';
                    else if (hour >= 20 || hour < 5) timeOfDay = 'night';
                    
                    DB.addWalk({
                        duration,
                        type: walkType,
                        mood: walkMood,
                        notes: walkNotes,
                        timeOfDay
                    });
                    setStats(DB.getWalkStats());
                    setMotivation(getMotivation('complete'));
                    vibrate([100, 100, 300]); // Финальная вибрация
                }
                setActiveWalk(null);
                setWalkTimer(0);
                setWalkNotes('');
                setIsMoving(false);
            };
            
            // Добавить прогулку вручную
            const addManualWalk = () => {
                const hour = new Date().getHours();
                let timeOfDay = 'day';
                if (hour >= 5 && hour < 8) timeOfDay = 'sunrise';
                else if (hour >= 17 && hour < 20) timeOfDay = 'sunset';
                
                DB.addWalk({
                    duration: walkDuration,
                    type: walkType,
                    mood: walkMood,
                    notes: walkNotes,
                    timeOfDay
                });
                setStats(DB.getWalkStats());
                setShowAddWalk(false);
                setWalkNotes('');
                setMotivation(getMotivation('complete'));
            };
            
            // Переключение автоопределения
            const toggleAutoDetect = () => {
                const newValue = !autoDetectEnabled;
                setAutoDetectEnabled(newValue);
                DB.set('walk_auto_detect', newValue);
                if (newValue) {
                    vibrate(50);
                }
            };
            
            const formatTime = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            };
            
            const achievements = checkAchievements();
            const weekProgress = Math.min(100, (stats.weekMinutes / goal.weeklyMinutes) * 100);
            
            // Модальное окно выбора типа прогулки
            if (showTypeSelector) {
                return (
                    <div className="fade-in" style={{ padding: '1rem' }}>
                        <div style={{ textAlign: 'center', marginBottom: '1.5rem' }}>
                            <div style={{ fontSize: '3rem', marginBottom: '0.5rem' }}>🚶</div>
                            <h2>Обнаружено движение!</h2>
                            <p style={{ color: 'var(--text-secondary)', fontSize: '0.9rem' }}>Выберите тип прогулки</p>
                        </div>
                        
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                            {WALK_TYPES.map(t => (
                                <div 
                                    key={t.id}
                                    className="card card-clickable"
                                    style={{ 
                                        display: 'flex', 
                                        alignItems: 'center', 
                                        gap: '1rem',
                                        background: t.id === 'city' ? '#FEF3C7' : 'white'
                                    }}
                                    onClick={() => selectTypeAndStart(t.id)}
                                >
                                    <span style={{ fontSize: '2rem' }}>{t.icon}</span>
                                    <div>
                                        <strong>{t.label}</strong>
                                        <p style={{ fontSize: '0.8rem', color: 'var(--text-secondary)' }}>{t.desc}</p>
                                    </div>
                                </div>
                            ))}
                        </div>
                        
                        <div style={{ textAlign: 'center', marginTop: '1rem' }}>
                            <p style={{ fontSize: '0.75rem', color: 'var(--text-tertiary)' }}>
                                Автостарт «Город» через 10 сек...
                            </p>
                            <button 
                                className="btn btn-secondary btn-small" 
                                style={{ marginTop: '0.5rem' }}
                                onClick={() => { setShowTypeSelector(false); setIsMoving(false); }}
                            >
                                Отмена
                            </button>
                        </div>
                    </div>
                );
            }
            
            // Экран аналитики здоровья
            if (showAnalytics) {
                const dayNames = ['Вс', 'Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб'];
                const maxMinutes = correlation?.last14Days ? Math.max(...correlation.last14Days.map(d => d.walkMinutes), 60) : 60;
                
                return (
                    <div className="fade-in">
                        <div style={{ display: 'flex', alignItems: 'center', marginBottom: '1rem' }}>
                            <button className="btn btn-secondary btn-small" onClick={() => setShowAnalytics(false)}>← Назад</button>
                            <h2 style={{ marginLeft: '0.75rem' }}>📊 Аналитика</h2>
                        </div>
                        
                        {/* Корреляция настроение-прогулки */}
                        {correlation?.moodImprovement && (
                            <div className="card" style={{ background: '#F0FDF4', marginBottom: '0.75rem' }}>
                                <h3 style={{ marginBottom: '0.5rem' }}>🧠 Влияние на настроение</h3>
                                <div style={{ fontSize: '2rem', fontWeight: 'bold', color: 'var(--harmony-green)', textAlign: 'center' }}>
                                    +{correlation.moodImprovement}%
                                </div>
                                <p style={{ fontSize: '0.85rem', textAlign: 'center', color: 'var(--text-secondary)' }}>
                                    улучшение настроения в дни с прогулками
                                </p>
                            </div>
                        )}
                        
                        {/* График за 14 дней */}
                        {correlation?.last14Days && (
                            <div className="card" style={{ marginBottom: '0.75rem' }}>
                                <h3 style={{ marginBottom: '0.75rem' }}>📈 Последние 14 дней</h3>
                                <div style={{ display: 'flex', alignItems: 'flex-end', gap: '4px', height: '100px' }}>
                                    {correlation.last14Days.map((d, idx) => {
                                        const height = d.walkMinutes > 0 ? Math.max(10, (d.walkMinutes / maxMinutes) * 100) : 5;
                                        const date = new Date(d.date);
                                        const isToday = date.toDateString() === new Date().toDateString();
                                        return (
                                            <div key={idx} style={{ flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center' }}>
                                                <div style={{ 
                                                    width: '100%', 
                                                    height: `${height}%`,
                                                    background: d.walkMinutes > 0 
                                                        ? `linear-gradient(to top, var(--amber), var(--golden-light))` 
                                                        : 'var(--earth-light)',
                                                    borderRadius: '4px 4px 0 0',
                                                    border: isToday ? '2px solid var(--amber)' : 'none'
                                                }} />
                                                <span style={{ fontSize: '0.55rem', color: 'var(--text-tertiary)', marginTop: '2px' }}>
                                                    {date.getDate()}
                                                </span>
                                            </div>
                                        );
                                    })}
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', marginTop: '0.5rem', fontSize: '0.7rem', color: 'var(--text-tertiary)' }}>
                                    <span>14 дней назад</span>
                                    <span>Сегодня</span>
                                </div>
                            </div>
                        )}
                        
                        {/* Лучший день */}
                        {correlation?.bestDay && (
                            <div className="card" style={{ marginBottom: '0.75rem' }}>
                                <h3 style={{ marginBottom: '0.5rem' }}>🏆 Лучший день для прогулок</h3>
                                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '1rem' }}>
                                    <span style={{ fontSize: '2rem', fontWeight: 'bold', color: 'var(--amber)' }}>{correlation.bestDay}</span>
                                    <div style={{ fontSize: '0.85rem', color: 'var(--text-secondary)' }}>
                                        в среднем {correlation.bestDayMinutes} мин
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        {/* Статистика по типам */}
                        <div className="card" style={{ marginBottom: '0.75rem' }}>
                            <h3 style={{ marginBottom: '0.5rem' }}>🌿 Типы прогулок</h3>
                            <div style={{ display: 'flex', justifyContent: 'space-around', fontSize: '0.85rem' }}>
                                <div style={{ textAlign: 'center' }}>
                                    <div style={{ fontSize: '1.5rem' }}>🏙️</div>
                                    <div style={{ fontWeight: 'bold' }}>{stats.cityWalks || 0}</div>
                                    <div style={{ fontSize: '0.7rem', color: 'var(--text-tertiary)' }}>в городе</div>
                                </div>
                                <div style={{ textAlign: 'center' }}>
                                    <div style={{ fontSize: '1.5rem' }}>🌳</div>
                                    <div style={{ fontWeight: 'bold' }}>{stats.natureWalks}</div>
                                    <div style={{ fontSize: '0.7rem', color: 'var(--text-tertiary)' }}>в природе</div>
                                </div>
                                <div style={{ textAlign: 'center' }}>
                                    <div style={{ fontSize: '1.5rem' }}>🌅</div>
                                    <div style={{ fontWeight: 'bold' }}>{stats.sunriseWalks}</div>
                                    <div style={{ fontSize: '0.7rem', color: 'var(--text-tertiary)' }}>на рассвете</div>
                                </div>
                                <div style={{ textAlign: 'center' }}>
                                    <div style={{ fontSize: '1.5rem' }}>🌇</div>
                                    <div style={{ fontWeight: 'bold' }}>{stats.sunsetWalks}</div>
                                    <div style={{ fontSize: '0.7rem', color: 'var(--text-tertiary)' }}>на закате</div>
                                </div>
                            </div>
                        </div>
                        
                        {/* Сравнение с нормой ВОЗ */}
                        <div className="card" style={{ background: '#EFF6FF' }}>
                            <h3 style={{ marginBottom: '0.5rem' }}>📋 Сравнение с нормой ВОЗ</h3>
                            <p style={{ fontSize: '0.85rem', marginBottom: '0.5rem' }}>
                                ВОЗ рекомендует 150 минут умеренной активности в неделю.
                            </p>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                <div style={{ flex: 1 }}>
                                    <div className="progress-bar" style={{ height: '10px' }}>
                                        <div className="progress-fill" style={{ width: `${Math.min(100, stats.weekMinutes / 150 * 100)}%` }}></div>
                                    </div>
                                </div>
                                <span style={{ fontSize: '0.85rem', fontWeight: 'bold' }}>{Math.round(stats.weekMinutes / 150 * 100)}%</span>
                            </div>
                            <p style={{ fontSize: '0.75rem', color: 'var(--text-tertiary)', marginTop: '0.5rem' }}>
                                {stats.weekMinutes >= 150 
                                    ? '✅ Вы выполняете норму!' 
                                    : `Осталось ${150 - stats.weekMinutes} минут до нормы`}
                            </p>
                        </div>
                    </div>
                );
            }
            
            // Экран информации о здоровье
            if (showHealthInfo) {
                return (
                    <div className="fade-in">
                        <div style={{ display: 'flex', alignItems: 'center', marginBottom: '1rem' }}>
                            <button className="btn btn-secondary btn-small" onClick={() => setShowHealthInfo(false)}>← Назад</button>
                            <h2 style={{ marginLeft: '0.75rem' }}>❤️ Польза прогулок</h2>
                        </div>
                        
                        {HEALTH_INSIGHTS.map((insight, idx) => (
                            <div key={idx} className="card" style={{ marginBottom: '0.5rem' }}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
                                    <span style={{ fontSize: '2rem' }}>{insight.icon}</span>
                                    <div>
                                        <strong>{insight.title}</strong>
                                        <p style={{ fontSize: '0.85rem', color: 'var(--text-secondary)', margin: '0.25rem 0' }}>{insight.fact}</p>
                                        <p style={{ fontSize: '0.8rem', color: 'var(--harmony-green)' }}>→ {insight.benefit}</p>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                );
            }
            
            // История прогулок
            if (showHistory) {
                return (
                    <div className="fade-in">
                        <div style={{ display: 'flex', alignItems: 'center', marginBottom: '1rem' }}>
                            <button className="btn btn-secondary btn-small" onClick={() => setShowHistory(false)}>← Назад</button>
                            <h2 style={{ marginLeft: '0.75rem' }}>История прогулок</h2>
                        </div>
                        
                        {walks.length === 0 ? (
                            <div style={{ textAlign: 'center', padding: '2rem' }}>
                                <div style={{ fontSize: '2.5rem', marginBottom: '0.5rem' }}>🚶</div>
                                <p style={{ color: 'var(--text-secondary)' }}>Прогулок пока нет</p>
                            </div>
                        ) : (
                            walks.slice().reverse().slice(0, 20).map((w, idx) => {
                                const date = new Date(w.date);
                                const typeIcons = { sunrise: '🌅', sunset: '🌇', forest: '🌳', observe: '👁️', beauty: '✨', active: '🏃', night: '🌙', day: '☀️', city: '🏙️' };
                                return (
                                    <div key={idx} className="card" style={{ marginBottom: '0.5rem' }}>
                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                            <div>
                                                <span style={{ fontSize: '1.25rem', marginRight: '0.5rem' }}>{typeIcons[w.timeOfDay] || '🚶'}</span>
                                                <strong>{w.duration} мин</strong>
                                            </div>
                                            <span style={{ fontSize: '0.75rem', color: 'var(--text-tertiary)' }}>
                                                {date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' })}
                                            </span>
                                        </div>
                                        {w.notes && <p style={{ fontSize: '0.8rem', color: 'var(--text-secondary)', marginTop: '0.25rem' }}>{w.notes}</p>}
                                    </div>
                                );
                            })
                        )}
                    </div>
                );
            }
            
            // Добавление прогулки вручную
            if (showAddWalk) {
                return (
                    <div className="fade-in">
                        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '1rem' }}>
                            <button className="btn btn-secondary btn-small" onClick={() => setShowAddWalk(false)}>Отмена</button>
                            <button className="btn btn-primary btn-small" onClick={addManualWalk}>Сохранить</button>
                        </div>
                        
                        <h2>Записать прогулку</h2>
                        
                        <div className="card" style={{ marginTop: '1rem' }}>
                            <h3 style={{ marginBottom: '0.5rem' }}>Длительность: {walkDuration} мин</h3>
                            <input 
                                type="range" 
                                min="5" 
                                max="120" 
                                step="5" 
                                value={walkDuration} 
                                onChange={e => setWalkDuration(parseInt(e.target.value))}
                                style={{ width: '100%' }}
                            />
                            <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '0.7rem', color: 'var(--text-tertiary)' }}>
                                <span>5 мин</span>
                                <span>1 час</span>
                                <span>2 часа</span>
                            </div>
                        </div>
                        
                        <div className="card" style={{ marginTop: '0.75rem' }}>
                            <h3 style={{ marginBottom: '0.5rem' }}>Тип прогулки</h3>
                            <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.4rem' }}>
                                {[
                                    { id: 'city', icon: '🏙️', label: 'Город' },
                                    { id: 'observe', icon: '👁️', label: 'Наблюдение' },
                                    { id: 'forest', icon: '🌳', label: 'Лес/Парк' },
                                    { id: 'active', icon: '🏃', label: 'Активная' },
                                    { id: 'beauty', icon: '✨', label: 'Красота' }
                                ].map(t => (
                                    <button 
                                        key={t.id}
                                        className={`btn btn-small ${walkType === t.id ? 'btn-primary' : 'btn-secondary'}`}
                                        onClick={() => setWalkType(t.id)}
                                    >
                                        {t.icon} {t.label}
                                    </button>
                                ))}
                            </div>
                        </div>
                        
                        <div className="card" style={{ marginTop: '0.75rem' }}>
                            <h3 style={{ marginBottom: '0.5rem' }}>Заметки</h3>
                            <textarea 
                                className="journal-textarea" 
                                style={{ minHeight: '80px' }}
                                placeholder="Что заметили? Как себя чувствуете?"
                                value={walkNotes}
                                onChange={e => setWalkNotes(e.target.value)}
                            />
                        </div>
                    </div>
                );
            }
            
            // Активная прогулка
            if (activeWalk) {
                const currentType = WALK_TYPES.find(t => t.id === walkType) || WALK_TYPES[0];
                return (
                    <div className="fade-in" style={{ textAlign: 'center', padding: '1rem' }}>
                        <h1>🚶 Прогулка</h1>
                        
                        {/* Предупреждение об остановке */}
                        {showStopWarning && (
                            <div className="alert" style={{ 
                                background: '#FEF2F2', 
                                border: '2px solid #EF4444',
                                marginBottom: '1rem',
                                animation: 'pulse 1s infinite'
                            }}>
                                <span style={{ fontSize: '1.5rem' }}>⚠️</span>
                                <div style={{ flex: 1 }}>
                                    <strong>Нет движения!</strong>
                                    <p style={{ fontSize: '0.8rem' }}>Остановка через {10 - noMovementTime} сек...</p>
                                </div>
                                <button 
                                    className="btn btn-small btn-primary"
                                    onClick={() => { lastMovementRef.current = Date.now(); setNoMovementTime(0); setShowStopWarning(false); vibrate(50); }}
                                >
                                    Продолжить
                                </button>
                            </div>
                        )}
                        
                        {/* Текущий тип */}
                        <div style={{ 
                            display: 'inline-flex', 
                            alignItems: 'center', 
                            gap: '0.5rem', 
                            padding: '0.5rem 1rem',
                            background: 'var(--cream-warm)',
                            borderRadius: '20px',
                            marginBottom: '1rem'
                        }}>
                            <span style={{ fontSize: '1.25rem' }}>{currentType.icon}</span>
                            <span style={{ fontWeight: '600' }}>{currentType.label}</span>
                        </div>
                        
                        <div style={{ 
                            fontSize: '3.5rem', 
                            fontWeight: 'bold', 
                            color: 'var(--amber)', 
                            margin: '1.5rem 0',
                            fontFamily: 'monospace'
                        }}>
                            {formatTime(walkTimer)}
                        </div>
                        
                        <div className="card" style={{ background: '#F0FDF4', textAlign: 'left', marginBottom: '1rem' }}>
                            <p style={{ fontSize: '1rem' }}>{motivation || getMotivation('during', walkType)}</p>
                        </div>
                        
                        {/* Health insight во время прогулки */}
                        <div className="card" style={{ background: '#EFF6FF', textAlign: 'left', marginBottom: '1rem' }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', marginBottom: '0.25rem' }}>
                                <span style={{ fontSize: '1.25rem' }}>{healthInsight.icon}</span>
                                <strong style={{ fontSize: '0.9rem' }}>{healthInsight.title}</strong>
                            </div>
                            <p style={{ fontSize: '0.8rem', color: 'var(--text-secondary)' }}>{healthInsight.fact}</p>
                        </div>
                        
                        {/* Смена типа прогулки */}
                        <div className="card" style={{ marginBottom: '1rem' }}>
                            <h4 style={{ marginBottom: '0.5rem', fontSize: '0.85rem' }}>Изменить тип</h4>
                            <div style={{ display: 'flex', gap: '0.3rem', flexWrap: 'wrap', justifyContent: 'center' }}>
                                {WALK_TYPES.map(t => (
                                    <button 
                                        key={t.id}
                                        className={`btn btn-small ${walkType === t.id ? 'btn-primary' : 'btn-secondary'}`}
                                        onClick={() => setWalkType(t.id)}
                                        style={{ padding: '0.4rem 0.6rem' }}
                                    >
                                        {t.icon}
                                    </button>
                                ))}
                            </div>
                        </div>
                        
                        {walkTimer > 60 && walkTimer % 300 < 5 && (
                            <div className="alert alert-info" style={{ textAlign: 'left' }}>
                                <span>💡</span>
                                <div>{getMotivation('during', walkType)}</div>
                            </div>
                        )}
                        
                        <div className="card" style={{ marginTop: '1rem' }}>
                            <h3 style={{ marginBottom: '0.5rem' }}>Заметки</h3>
                            <textarea 
                                className="journal-textarea" 
                                style={{ minHeight: '60px' }}
                                placeholder="Что замечаете вокруг?"
                                value={walkNotes}
                                onChange={e => setWalkNotes(e.target.value)}
                            />
                        </div>
                        
                        <button 
                            className="btn btn-primary btn-full" 
                            style={{ marginTop: '1rem' }}
                            onClick={finishWalk}
                        >
                            ✓ Завершить прогулку
                        </button>
                    </div>
                );
            }
            
            // Главный экран трекера
            return (
                <div className="fade-in">
                    <h1>🚶 Трекер прогулок</h1>
                    
                    {/* Автоопределение движения */}
                    <div 
                        className="card" 
                        style={{ 
                            marginTop: '0.75rem', 
                            display: 'flex', 
                            justifyContent: 'space-between', 
                            alignItems: 'center',
                            background: autoDetectEnabled ? '#F0FDF4' : 'var(--cream-light)'
                        }}
                    >
                        <div>
                            <strong style={{ fontSize: '0.9rem' }}>📱 Автотрекинг</strong>
                            <p style={{ fontSize: '0.75rem', color: 'var(--text-secondary)' }}>
                                {autoDetectEnabled ? 'Вкл — определяю движение' : 'Выкл'}
                            </p>
                        </div>
                        <div 
                            onClick={toggleAutoDetect}
                            style={{ 
                                width: '50px', 
                                height: '28px', 
                                borderRadius: '14px', 
                                background: autoDetectEnabled ? 'var(--harmony-green)' : '#ccc',
                                position: 'relative',
                                cursor: 'pointer',
                                transition: 'background 0.3s'
                            }}
                        >
                            <div style={{
                                width: '24px',
                                height: '24px',
                                borderRadius: '12px',
                                background: 'white',
                                position: 'absolute',
                                top: '2px',
                                left: autoDetectEnabled ? '24px' : '2px',
                                transition: 'left 0.3s',
                                boxShadow: '0 1px 3px rgba(0,0,0,0.2)'
                            }} />
                        </div>
                    </div>
                    
                    {isMoving && !activeWalk && (
                        <div className="alert alert-info" style={{ marginTop: '0.5rem' }}>
                            <span>🚶</span>
                            <div>Обнаружено движение...</div>
                        </div>
                    )}
                    
                    {/* Мотивация */}
                    {motivation && (
                        <div className="card" style={{ background: '#F0FDF4', marginTop: '0.75rem' }}>
                            <p style={{ fontSize: '1rem', textAlign: 'center' }}>{motivation}</p>
                        </div>
                    )}
                    
                    {/* Напоминание если сегодня не гуляли */}
                    {!stats.todayWalked && !motivation && (
                        <div className="card" style={{ background: '#FEF3C7', marginTop: '0.75rem' }}>
                            <p style={{ fontSize: '0.9rem' }}>{getMotivation('reminder')}</p>
                        </div>
                    )}
                    
                    {/* Статистика */}
                    <div className="grid-2" style={{ marginTop: '1rem' }}>
                        <div className="stat-card">
                            <div className="stat-value">{stats.currentStreak}</div>
                            <div className="stat-label">дней подряд 🔥</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-value">{stats.weekMinutes}</div>
                            <div className="stat-label">минут за неделю</div>
                        </div>
                    </div>
                    
                    {/* Прогресс недели */}
                    <div className="card" style={{ marginTop: '0.75rem' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '0.85rem', marginBottom: '0.5rem' }}>
                            <span>Цель недели</span>
                            <span>{stats.weekMinutes} / {goal.weeklyMinutes} мин</span>
                        </div>
                        <div className="progress-bar" style={{ height: '8px' }}>
                            <div className="progress-fill" style={{ width: `${weekProgress}%` }}></div>
                        </div>
                        {weekProgress >= 100 && (
                            <p style={{ fontSize: '0.8rem', color: 'var(--harmony-green)', marginTop: '0.5rem', textAlign: 'center' }}>
                                🎉 Цель достигнута!
                            </p>
                        )}
                    </div>
                    
                    {/* Health Insight */}
                    <div className="card card-clickable" style={{ background: '#EFF6FF', marginTop: '0.75rem' }} onClick={() => setShowHealthInfo(true)}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                            <span style={{ fontSize: '1.5rem' }}>{healthInsight.icon}</span>
                            <div style={{ flex: 1 }}>
                                <strong style={{ fontSize: '0.9rem' }}>{healthInsight.title}</strong>
                                <p style={{ fontSize: '0.8rem', color: 'var(--text-secondary)' }}>{healthInsight.benefit}</p>
                            </div>
                            <span style={{ color: 'var(--text-tertiary)' }}>→</span>
                        </div>
                    </div>
                    
                    {/* Корреляция с настроением */}
                    {correlation?.moodImprovement && parseInt(correlation.moodImprovement) > 0 && (
                        <div className="card card-clickable" style={{ background: '#F0FDF4', marginTop: '0.75rem' }} onClick={() => setShowAnalytics(true)}>
                            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
                                <div>
                                    <strong>🧠 Прогулки улучшают настроение</strong>
                                    <p style={{ fontSize: '0.8rem', color: 'var(--text-secondary)' }}>
                                        на +{correlation.moodImprovement}% в дни с прогулками
                                    </p>
                                </div>
                                <span style={{ color: 'var(--text-tertiary)' }}>→</span>
                            </div>
                        </div>
                    )}
                    
                    {/* Рекомендация */}
                    <div className="recommendation-card" style={{ marginTop: '0.75rem' }}>
                        <div className="recommendation-title">💡 Рекомендация</div>
                        <p style={{ fontSize: '0.85rem', marginBottom: '0.5rem' }}>{recommendation.tip}</p>
                        <p style={{ fontSize: '0.8rem', color: 'var(--text-secondary)' }}>
                            Рекомендуемая длительность: {recommendation.duration} мин
                        </p>
                    </div>
                    
                    {/* Кнопки действий */}
                    <div style={{ display: 'flex', gap: '0.5rem', marginTop: '1rem' }}>
                        <button className="btn btn-primary" style={{ flex: 1 }} onClick={startWalk}>
                            ▶️ Начать прогулку
                        </button>
                        <button className="btn btn-secondary" onClick={() => setShowAddWalk(true)}>
                            ✏️
                        </button>
                    </div>
                    
                    {/* Быстрые действия */}
                    <div style={{ display: 'flex', gap: '0.5rem', marginTop: '0.75rem' }}>
                        <button className="btn btn-secondary btn-small" style={{ flex: 1 }} onClick={() => setShowAnalytics(true)}>
                            📊 Аналитика
                        </button>
                        <button className="btn btn-secondary btn-small" style={{ flex: 1 }} onClick={() => setShowHistory(true)}>
                            📋 История
                        </button>
                    </div>
                    
                    {/* Достижения */}
                    {achievements.length > 0 && (
                        <>
                            <h3 style={{ marginTop: '1.5rem', marginBottom: '0.5rem' }}>🏆 Достижения ({achievements.length}/{WALK_ACHIEVEMENTS.length})</h3>
                            <div style={{ display: 'flex', gap: '0.5rem', flexWrap: 'wrap' }}>
                                {achievements.map(a => (
                                    <div 
                                        key={a.id} 
                                        style={{ 
                                            padding: '0.5rem', 
                                            borderRadius: '12px', 
                                            background: 'var(--cream-warm)',
                                            textAlign: 'center',
                                            minWidth: '70px'
                                        }}
                                    >
                                        <div style={{ fontSize: '1.5rem' }}>{a.icon}</div>
                                        <div style={{ fontSize: '0.65rem' }}>{a.name}</div>
                                    </div>
                                ))}
                            </div>
                        </>
                    )}
                    
                    {/* Общая статистика */}
                    <div className="card" style={{ marginTop: '1rem' }}>
                        <h3 style={{ marginBottom: '0.5rem' }}>📈 Всего</h3>
                        <div style={{ display: 'flex', justifyContent: 'space-around', fontSize: '0.85rem' }}>
                            <div style={{ textAlign: 'center' }}>
                                <div style={{ fontWeight: 'bold', color: 'var(--amber)' }}>{stats.totalWalks}</div>
                                <div style={{ fontSize: '0.7rem', color: 'var(--text-tertiary)' }}>прогулок</div>
                            </div>
                            <div style={{ textAlign: 'center' }}>
                                <div style={{ fontWeight: 'bold', color: 'var(--amber)' }}>{Math.round(stats.totalMinutes / 60)}ч</div>
                                <div style={{ fontSize: '0.7rem', color: 'var(--text-tertiary)' }}>на воздухе</div>
                            </div>
                            <div style={{ textAlign: 'center' }}>
                                <div style={{ fontWeight: 'bold', color: 'var(--amber)' }}>{stats.averageDuration}</div>
                                <div style={{ fontSize: '0.7rem', color: 'var(--text-tertiary)' }}>мин средняя</div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function PracticePage({ practice, setPage }) {
            const [step, setStep] = useState(-1);
            if (!practice) return null;
            
            const completePractice = () => {
                DB.addPractice(practice.id, practice.duration);
                setStep(-2);
            };
            
            if (step === -1) {
                return (
                    <div className="fade-in">
                        <button className="btn btn-secondary btn-small" onClick={() => setPage('practices')} style={{ marginBottom: '1rem' }}>← Назад</button>
                        <div style={{ textAlign: 'center', padding: '1.5rem', borderRadius: '16px', background: practice.bg, marginBottom: '1rem' }}>
                            <div style={{ fontSize: '2.5rem', marginBottom: '0.5rem' }}>{CATEGORIES.find(c => c.id === practice.category)?.icon}</div>
                            <h1>{practice.title}</h1>
                            <p style={{ marginTop: '0.25rem', opacity: 0.8 }}>⏱️ {practice.duration} мин</p>
                        </div>
                        <div className="card">
                            <p>{practice.short}</p>
                        </div>
                        <button className="btn btn-primary btn-full" style={{ marginTop: '1rem' }} onClick={() => setStep(0)}>
                            ▶️ Начать
                        </button>
                    </div>
                );
            }
            
            if (step === -2) {
                return (
                    <div style={{ textAlign: 'center', padding: '3rem 1rem' }} className="fade-in">
                        <div style={{ fontSize: '3rem', marginBottom: '1rem' }}>✨</div>
                        <h1>Завершено</h1>
                        <p style={{ marginTop: '0.5rem', marginBottom: '1.5rem' }}>Благодарю за время с собой</p>
                        <button className="btn btn-primary" onClick={() => setPage('home')}>Готово</button>
                    </div>
                );
            }
            
            return (
                <div className="fade-in">
                    <div style={{ display: 'flex', alignItems: 'center', marginBottom: '0.75rem' }}>
                        <button className="btn btn-secondary btn-small" onClick={() => setPage('practices')}>←</button>
                        <span style={{ marginLeft: 'auto', color: 'var(--text-tertiary)', fontSize: '0.85rem' }}>
                            {step + 1} / {practice.steps.length}
                        </span>
                    </div>
                    <div className="progress-bar" style={{ marginBottom: '1rem' }}>
                        <div className="progress-fill" style={{ width: `${((step + 1) / practice.steps.length) * 100}%` }}></div>
                    </div>
                    <div className="card" style={{ background: practice.bg }}>
                        <div className="step-card">
                            <div className="step-num">{step + 1}</div>
                            <p className="step-text">{practice.steps[step]}</p>
                        </div>
                    </div>
                    <div style={{ display: 'flex', justifyContent: 'space-between', marginTop: '1rem' }}>
                        {step > 0 && <button className="btn btn-secondary" onClick={() => setStep(step - 1)}>← Назад</button>}
                        <div style={{ flex: 1 }} />
                        <button className="btn btn-primary" onClick={() => step < practice.steps.length - 1 ? setStep(step + 1) : completePractice()}>
                            {step < practice.steps.length - 1 ? 'Далее →' : 'Завершить ✓'}
                        </button>
                    </div>
                </div>
            );
        }

        function ChatPage() {
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState('');
            
            const send = () => {
                if (!input.trim()) return;
                setMessages([...messages, { role: 'user', text: input }]);
                setInput('');
                setTimeout(() => {
                    setMessages(m => [...m, { role: 'ai', text: LOCAL_RESPONSES[Math.floor(Math.random() * LOCAL_RESPONSES.length)] }]);
                }, 800);
            };
            
            return (
                <div className="chat-container fade-in">
                    <div className="chat-messages">
                        {messages.length === 0 && (
                            <div style={{ textAlign: 'center', padding: '2rem 1rem' }}>
                                <div style={{ fontSize: '2.5rem', marginBottom: '0.5rem' }}>🌤️</div>
                                <h2>Привет!</h2>
                                <p style={{ color: 'var(--text-secondary)', marginTop: '0.25rem' }}>Как ты себя чувствуешь?</p>
                                <div style={{ marginTop: '1rem', display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                                    {['Мне сегодня непросто...', 'Хочу поделиться', 'Расскажи о практиках'].map(t => (
                                        <button key={t} className="btn btn-secondary btn-small" onClick={() => setInput(t)}>{t}</button>
                                    ))}
                                </div>
                            </div>
                        )}
                        {messages.map((m, i) => (
                            <div key={i} className={`chat-msg ${m.role}`}>
                                <div className={`chat-avatar ${m.role}`}>{m.role === 'user' ? '👤' : '☀️'}</div>
                                <div className="chat-bubble">{m.text}</div>
                            </div>
                        ))}
                    </div>
                    <div className="chat-input-container">
                        <input className="chat-input" placeholder="Напиши..." value={input} onChange={e => setInput(e.target.value)} onKeyPress={e => e.key === 'Enter' && send()} />
                        <button className="btn btn-primary btn-small" onClick={send}>📤</button>
                    </div>
                </div>
            );
        }

        // ═══════════════════════════════════════════════════════════════
        // ЧИСТАЯ АРХИТЕКТУРА: PRESENTATION LAYER - Новые компоненты
        // ═══════════════════════════════════════════════════════════════

        // Компонент дерева души
        function TreeWidget({ compact = false }) {
            const [tree, setTree] = useState(DB.getTreeState());
            
            const stageEmoji = {
                seed: '🌱',
                sprout: '🌿',
                sapling: '🌳',
                tree: '🌲',
                flowering: '🌸',
                garden: '🏡'
            };
            
            const stageNames = {
                seed: 'Семя',
                sprout: 'Росток',
                sapling: 'Деревце',
                tree: 'Дерево',
                flowering: 'Цветение',
                garden: 'Сад'
            };
            
            if (compact) {
                return (
                    <div style={{ 
                        display: 'flex', 
                        alignItems: 'center', 
                        gap: '0.5rem',
                        padding: '0.5rem',
                        background: 'linear-gradient(135deg, #F0FDF4, #DCFCE7)',
                        borderRadius: '12px'
                    }}>
                        <span style={{ fontSize: '2rem' }}>{stageEmoji[tree.stage]}</span>
                        <div>
                            <div style={{ fontWeight: 'bold', fontSize: '0.9rem' }}>{stageNames[tree.stage]}</div>
                            <div style={{ fontSize: '0.75rem', color: 'var(--text-secondary)' }}>
                                Уровень {tree.level} • {tree.growth} очков
                            </div>
                        </div>
                    </div>
                );
            }
            
            const nextLevel = [0, 100, 300, 600, 1000, 1500, 2000][tree.level] || 2500;
            const prevLevel = [0, 100, 300, 600, 1000, 1500, 2000][tree.level - 1] || 0;
            const progress = ((tree.growth - prevLevel) / (nextLevel - prevLevel)) * 100;
            
            return (
                <div className="card" style={{ 
                    background: 'linear-gradient(135deg, #F0FDF4, #DCFCE7)',
                    textAlign: 'center'
                }}>
                    <div style={{ fontSize: '4rem', marginBottom: '0.5rem' }}>
                        {stageEmoji[tree.stage]}
                    </div>
                    <h3>{stageNames[tree.stage]}</h3>
                    <p style={{ color: 'var(--text-secondary)', fontSize: '0.85rem' }}>
                        Уровень {tree.level} • {tree.growth} очков роста
                    </p>
                    
                    <div className="progress-bar" style={{ height: '8px', margin: '1rem 0' }}>
                        <div className="progress-fill" style={{ 
                            width: `${Math.min(progress, 100)}%`,
                            background: 'linear-gradient(90deg, #22C55E, #16A34A)'
                        }}></div>
                    </div>
                    
                    <div style={{ display: 'flex', justifyContent: 'space-around', fontSize: '0.8rem' }}>
                        <div>🧘 {tree.totalPractices} практик</div>
                        <div>🚶 {tree.totalWalks} прогулок</div>
                        <div>📝 {tree.totalJournals} записей</div>
                    </div>
                    
                    {tree.fruits.length > 0 && (
                        <div style={{ marginTop: '1rem' }}>
                            <div style={{ fontSize: '0.8rem', color: 'var(--text-secondary)' }}>Плоды:</div>
                            <div style={{ display: 'flex', justifyContent: 'center', gap: '0.5rem', marginTop: '0.25rem' }}>
                                {tree.fruits.map(f => <span key={f}>🍎</span>)}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Страница ритуалов
        function RitualsPage({ setPage }) {
            const [rituals, setRituals] = useState(DB.getRituals());
            const [activeRitual, setActiveRitual] = useState(null);
            const [currentStep, setCurrentStep] = useState(0);
            const [completedSteps, setCompletedSteps] = useState([]);
            
            const hour = new Date().getHours();
            const suggestedRitual = hour < 12 ? 'morning' : hour > 18 ? 'evening' : null;
            
            const completeRitual = (type) => {
                DB.completeRitual(type);
                setActiveRitual(null);
                setCurrentStep(0);
                setCompletedSteps([]);
            };
            
            if (activeRitual) {
                const ritual = RITUALS[activeRitual];
                const step = ritual.steps[currentStep];
                const isLastStep = currentStep === ritual.steps.length - 1;
                
                return (
                    <div className="fade-in">
                        <button className="btn btn-secondary btn-small" onClick={() => setActiveRitual(null)}>
                            ← Выход
                        </button>
                        
                        <div style={{ textAlign: 'center', margin: '1.5rem 0' }}>
                            <span style={{ fontSize: '3rem' }}>{ritual.icon}</span>
                            <h2>{ritual.title}</h2>
                            <p style={{ color: 'var(--text-secondary)' }}>
                                Шаг {currentStep + 1} из {ritual.steps.length}
                            </p>
                        </div>
                        
                        <div className="progress-bar" style={{ height: '6px', marginBottom: '1.5rem' }}>
                            <div className="progress-fill" style={{ 
                                width: `${((currentStep + 1) / ritual.steps.length) * 100}%` 
                            }}></div>
                        </div>
                        
                        <div className="card" style={{ 
                            background: activeRitual === 'morning' ? '#FEF3C7' : '#E0E7FF',
                            textAlign: 'center',
                            padding: '2rem'
                        }}>
                            <h3 style={{ marginBottom: '0.5rem' }}>{step.title}</h3>
                            <p style={{ color: 'var(--text-secondary)', marginBottom: '1rem' }}>
                                {step.description}
                            </p>
                            <div style={{ 
                                fontSize: '0.85rem', 
                                background: 'white', 
                                padding: '0.5rem 1rem',
                                borderRadius: '20px',
                                display: 'inline-block'
                            }}>
                                ⏱️ ~{step.duration} мин
                            </div>
                        </div>
                        
                        <div style={{ display: 'flex', gap: '0.75rem', marginTop: '1.5rem' }}>
                            {currentStep > 0 && (
                                <button 
                                    className="btn btn-secondary"
                                    style={{ flex: 1 }}
                                    onClick={() => setCurrentStep(currentStep - 1)}
                                >
                                    ← Назад
                                </button>
                            )}
                            
                            {isLastStep ? (
                                <button 
                                    className="btn btn-primary"
                                    style={{ flex: 2 }}
                                    onClick={() => completeRitual(activeRitual)}
                                >
                                    ✅ Завершить ритуал
                                </button>
                            ) : (
                                <button 
                                    className="btn btn-primary"
                                    style={{ flex: 2 }}
                                    onClick={() => setCurrentStep(currentStep + 1)}
                                >
                                    Далее →
                                </button>
                            )}
                        </div>
                    </div>
                );
            }
            
            return (
                <div className="fade-in">
                    <h1>🌅 Ритуалы дня</h1>
                    <p style={{ color: 'var(--text-secondary)', marginBottom: '1rem' }}>
                        Осознанное начало и завершение дня
                    </p>
                    
                    {suggestedRitual && (
                        <div className="card" style={{ 
                            background: suggestedRitual === 'morning' ? '#FEF3C7' : '#E0E7FF',
                            marginBottom: '1rem'
                        }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
                                <span style={{ fontSize: '2rem' }}>
                                    {suggestedRitual === 'morning' ? '☀️' : '🌙'}
                                </span>
                                <div style={{ flex: 1 }}>
                                    <strong>Сейчас хорошее время для</strong>
                                    <p style={{ margin: 0, fontSize: '0.9rem' }}>
                                        {suggestedRitual === 'morning' ? 'Утреннего ритуала' : 'Вечернего ритуала'}
                                    </p>
                                </div>
                                <button 
                                    className="btn btn-primary btn-small"
                                    onClick={() => setActiveRitual(suggestedRitual)}
                                >
                                    Начать
                                </button>
                            </div>
                        </div>
                    )}
                    
                    {Object.values(RITUALS).map(ritual => (
                        <div 
                            key={ritual.id}
                            className="card card-clickable"
                            style={{ marginBottom: '0.75rem' }}
                            onClick={() => setActiveRitual(ritual.id)}
                        >
                            <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>
                                <span style={{ fontSize: '2.5rem' }}>{ritual.icon}</span>
                                <div style={{ flex: 1 }}>
                                    <h3 style={{ marginBottom: '0.25rem' }}>{ritual.title}</h3>
                                    <p style={{ fontSize: '0.85rem', color: 'var(--text-secondary)', margin: 0 }}>
                                        {ritual.description}
                                    </p>
                                    <p style={{ fontSize: '0.8rem', color: 'var(--text-secondary)', margin: 0 }}>
                                        ⏱️ {ritual.duration} • {ritual.steps.length} шагов
                                    </p>
                                </div>
                                <span>→</span>
                            </div>
                        </div>
                    ))}
                    
                    <div className="card" style={{ marginTop: '1rem', background: '#F0FDF4' }}>
                        <h3>💡 Зачем ритуалы?</h3>
                        <ul style={{ fontSize: '0.85rem', paddingLeft: '1.25rem', margin: '0.5rem 0 0' }}>
                            <li>Создают предсказуемую структуру дня</li>
                            <li>Снижают утреннюю тревогу решений</li>
                            <li>Улучшают качество сна</li>
                            <li>Формируют полезные привычки</li>
                        </ul>
                    </div>
                </div>
            );
        }

        // Страница программ
        function ProgramsPage({ setPage, setPractice }) {
            const [programs, setPrograms] = useState(DB.getPrograms());
            const [selectedProgram, setSelectedProgram] = useState(null);
            const [currentDayView, setCurrentDayView] = useState(null);
            const profile = DB.getProfile();
            
            const startProgram = (programId) => {
                const updated = DB.startProgram(programId);
                setPrograms({...programs, [programId]: updated});
            };
            
            const completeDay = (programId, day) => {
                DB.completeProgramDay(programId, day);
                DB.updateTree('practice');
                setPrograms(DB.getPrograms());
            };
            
            // Просмотр дня программы
            if (currentDayView) {
                const program = PROGRAMS[currentDayView.programId];
                const dayData = program.days[currentDayView.day - 1];
                const userProgress = programs[currentDayView.programId];
                const isCompleted = userProgress?.completedDays?.includes(currentDayView.day);
                
                return (
                    <div className="fade-in">
                        <button className="btn btn-secondary btn-small" onClick={() => setCurrentDayView(null)}>
                            ← К программе
                        </button>
                        
                        <div style={{ textAlign: 'center', margin: '1rem 0' }}>
                            <span style={{ fontSize: '2.5rem' }}>{program.icon}</span>
                            <h2>День {dayData.day}: {dayData.title}</h2>
                        </div>
                        
                        <div className="progress-bar" style={{ height: '6px', marginBottom: '1rem' }}>
                            <div className="progress-fill" style={{ 
                                width: `${(dayData.day / program.duration) * 100}%` 
                            }}></div>
                        </div>
                        
                        <div className="card" style={{ background: '#FEF3C7', marginBottom: '0.75rem' }}>
                            <strong>🎯 Фокус дня:</strong>
                            <p style={{ margin: '0.5rem 0 0' }}>{dayData.focus}</p>
                        </div>
                        
                        <div className="card" style={{ marginBottom: '0.75rem' }}>
                            <h3 style={{ marginBottom: '0.75rem' }}>📋 Практики дня</h3>
                            {dayData.practices.map((practiceId, idx) => {
                                const practice = PRACTICES.find(p => p.id === practiceId);
                                // Словарь перевода для практик программ
                                const practiceTranslations = {
                                    'breathing_calm': 'Спокойное дыхание',
                                    'warm_feet': 'Прогрев ног',
                                    'warm_shower': 'Тёплый душ',
                                    'tea_ritual': 'Ритуал чаепития',
                                    'breathing_energy': 'Энергетическое дыхание',
                                    'walk_simple': 'Простая прогулка',
                                    'stretching': 'Растяжка',
                                    'sleep_prep': 'Подготовка ко сну',
                                    'journaling': 'Ведение дневника',
                                    'walk_nature': 'Прогулка на природе',
                                    'grounding': 'Заземление',
                                    'contrast_shower': 'Контрастный душ',
                                    'hydration': 'Гидратация',
                                    'mindful_eating': 'Осознанное питание',
                                    'meal_prep': 'Подготовка еды',
                                    'morning_ritual': 'Утренний ритуал',
                                    'evening_ritual': 'Вечерний ритуал',
                                    'pleasure_list': 'Список удовольствий',
                                    'reach_out': 'Связь с близкими',
                                    'forgiveness': 'Практика прощения',
                                    'breathing_release': 'Освобождающее дыхание',
                                    'values_reflection': 'Размышление о ценностях',
                                    'strength_recall': 'Воспоминание о силе',
                                    'affirmations': 'Аффирмации',
                                    'vision_board': 'Доска желаний',
                                    'action_plan': 'План действий',
                                    'commitment': 'Обязательство себе',
                                    'celebration': 'Празднование',
                                    'intention': 'Намерение',
                                    'anxiety_education': 'Изучение тревоги',
                                    'breathing_478': 'Дыхание 4-7-8',
                                    'breathing_box': 'Квадратное дыхание',
                                    'body_scan': 'Сканирование тела',
                                    'tension_release': 'Снятие напряжения',
                                    'grounding_senses': 'Заземление 5-4-3-2-1',
                                    'cold_water': 'Холодная вода',
                                    'thought_defusion': 'Отстранение от мыслей',
                                    'acceptance': 'Принятие',
                                    'self_compassion': 'Самосострадание',
                                    'reflection': 'Рефлексия',
                                    'toolkit': 'Набор инструментов',
                                    'trigger_mapping': 'Карта триггеров',
                                    'boundary_setting': 'Установка границ',
                                    'saying_no': 'Практика "нет"',
                                    'walk_brisk': 'Быстрая прогулка',
                                    'shake_it': 'Встряска',
                                    'forest_bathing': 'Лесное купание',
                                    'nature_sounds': 'Звуки природы',
                                    'sleep_hygiene': 'Гигиена сна',
                                    'coping_plan': 'План совладания',
                                    'emergency_kit': 'Экстренный набор',
                                    'maintenance': 'Поддержание практики',
                                    'warm_breakfast': 'Тёплый завтрак',
                                    'walk_slow': 'Медленная прогулка',
                                    'breathing_fire': 'Огненное дыхание',
                                    'warm_meal': 'Тёплая еда',
                                    'spices': 'Специи',
                                    'sauna': 'Баня/сауна',
                                    'tea_after': 'Чай после бани',
                                    'warm_routine': 'Тёплый распорядок',
                                    'watercolor_warm': 'Тёплые цвета акварели',
                                    'color_therapy': 'Цветотерапия',
                                    'oil_massage': 'Масляный массаж',
                                    'aromatherapy': 'Ароматерапия',
                                    'warm_connection': 'Тёплое общение',
                                    'hug_practice': 'Практика объятий',
                                    'creative_fire': 'Творческий огонь',
                                    'sun_gazing': 'Созерцание солнца',
                                    'earthing': 'Заземление на земле',
                                    'personal_ritual': 'Личный ритуал',
                                    'fire_meditation': 'Медитация на огонь',
                                    'inner_fire': 'Внутренний огонь',
                                    'sleep_audit': 'Аудит сна',
                                    'screen_off': 'Отключение экранов',
                                    'warm_bath': 'Тёплая ванна',
                                    'thought_release': 'Отпускание мыслей',
                                    'room_optimization': 'Оптимизация спальни',
                                    'darkness': 'Темнота',
                                    'light_schedule': 'Расписание света',
                                    'consistent_time': 'Постоянное время',
                                    'sleep_formula': 'Формула сна'
                                };
                                const title = practice ? practice.title : (practiceTranslations[practiceId] || practiceId.replace(/_/g, ' '));
                                return (
                                    <div 
                                        key={idx}
                                        className="card card-clickable"
                                        style={{ marginBottom: '0.5rem', padding: '0.75rem' }}
                                        onClick={() => {
                                            if (practice) {
                                                setPractice(practice);
                                                setPage('practice');
                                            }
                                        }}
                                    >
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                            <span>{isCompleted ? '✅' : '⬜'}</span>
                                            <span>{title}</span>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                        
                        <div className="card" style={{ background: '#F0FDF4' }}>
                            <strong>💡 Совет:</strong>
                            <p style={{ margin: '0.5rem 0 0' }}>{dayData.tip}</p>
                        </div>
                        
                        {!isCompleted && (
                            <button 
                                className="btn btn-primary"
                                style={{ width: '100%', marginTop: '1rem' }}
                                onClick={() => completeDay(currentDayView.programId, currentDayView.day)}
                            >
                                ✅ Отметить день выполненным
                            </button>
                        )}
                    </div>
                );
            }
            
            // Просмотр программы
            if (selectedProgram) {
                const program = PROGRAMS[selectedProgram];
                const userProgress = programs[selectedProgram];
                const isStarted = !!userProgress;
                const completedDays = userProgress?.completedDays?.length || 0;
                
                return (
                    <div className="fade-in">
                        <button className="btn btn-secondary btn-small" onClick={() => setSelectedProgram(null)}>
                            ← Все программы
                        </button>
                        
                        <div style={{ textAlign: 'center', margin: '1.5rem 0' }}>
                            <span style={{ fontSize: '4rem' }}>{program.icon}</span>
                            <h1>{program.title}</h1>
                            <p style={{ color: 'var(--text-secondary)' }}>{program.subtitle}</p>
                        </div>
                        
                        {isStarted && (
                            <div className="progress-bar" style={{ height: '8px', marginBottom: '1rem' }}>
                                <div className="progress-fill" style={{ 
                                    width: `${(completedDays / program.duration) * 100}%` 
                                }}></div>
                            </div>
                        )}
                        
                        <div className="card" style={{ marginBottom: '1rem' }}>
                            <p>{program.description}</p>
                            <div style={{ 
                                display: 'flex', 
                                gap: '1rem', 
                                marginTop: '0.75rem',
                                fontSize: '0.85rem',
                                color: 'var(--text-secondary)'
                            }}>
                                <span>📅 {program.duration} дней</span>
                                {isStarted && <span>✅ {completedDays} выполнено</span>}
                            </div>
                        </div>
                        
                        {!isStarted ? (
                            <button 
                                className="btn btn-primary"
                                style={{ width: '100%', marginBottom: '1rem' }}
                                onClick={() => startProgram(selectedProgram)}
                            >
                                🚀 Начать программу
                            </button>
                        ) : (
                            <button 
                                className="btn btn-primary"
                                style={{ width: '100%', marginBottom: '1rem' }}
                                onClick={() => setCurrentDayView({ 
                                    programId: selectedProgram, 
                                    day: userProgress.currentDay 
                                })}
                            >
                                ▶️ Продолжить (День {userProgress.currentDay})
                            </button>
                        )}
                        
                        <h3 style={{ marginBottom: '0.75rem' }}>Обзор программы</h3>
                        <div style={{ maxHeight: '300px', overflowY: 'auto' }}>
                            {program.days.map((day, idx) => {
                                const isDone = userProgress?.completedDays?.includes(day.day);
                                const isCurrent = userProgress?.currentDay === day.day;
                                
                                return (
                                    <div 
                                        key={idx}
                                        className="card card-clickable"
                                        style={{ 
                                            marginBottom: '0.5rem',
                                            padding: '0.75rem',
                                            opacity: !isStarted || day.day > (userProgress?.currentDay || 1) ? 0.6 : 1,
                                            border: isCurrent ? '2px solid var(--amber)' : 'none'
                                        }}
                                        onClick={() => {
                                            if (isStarted && day.day <= userProgress.currentDay) {
                                                setCurrentDayView({ programId: selectedProgram, day: day.day });
                                            }
                                        }}
                                    >
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
                                            <span style={{ 
                                                width: '30px', 
                                                height: '30px', 
                                                borderRadius: '50%',
                                                background: isDone ? '#22C55E' : isCurrent ? 'var(--amber)' : '#E5E7EB',
                                                color: isDone || isCurrent ? 'white' : '#6B7280',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                fontSize: '0.8rem',
                                                fontWeight: 'bold'
                                            }}>
                                                {isDone ? '✓' : day.day}
                                            </span>
                                            <div style={{ flex: 1 }}>
                                                <strong style={{ fontSize: '0.9rem' }}>{day.title}</strong>
                                                <p style={{ margin: 0, fontSize: '0.8rem', color: 'var(--text-secondary)' }}>
                                                    {day.focus}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                );
            }
            
            // Список программ
            return (
                <div className="fade-in">
                    <h1>📚 Программы</h1>
                    <p style={{ color: 'var(--text-secondary)', marginBottom: '1rem' }}>
                        Структурированные курсы для трансформации
                    </p>
                    
                    {Object.values(PROGRAMS).map(program => {
                        const userProgress = programs[program.id];
                        const isStarted = !!userProgress;
                        const completedDays = userProgress?.completedDays?.length || 0;
                        const isRecommended = program.forTemperament === profile.temperament ||
                            program.forStates?.some(s => true); // можно добавить логику
                        
                        return (
                            <div 
                                key={program.id}
                                className="card card-clickable"
                                style={{ marginBottom: '0.75rem' }}
                                onClick={() => setSelectedProgram(program.id)}
                            >
                                <div style={{ display: 'flex', alignItems: 'flex-start', gap: '1rem' }}>
                                    <span style={{ fontSize: '2.5rem' }}>{program.icon}</span>
                                    <div style={{ flex: 1 }}>
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                            <h3 style={{ margin: 0 }}>{program.title}</h3>
                                            {isRecommended && (
                                                <span style={{ 
                                                    fontSize: '0.7rem', 
                                                    background: '#FEF3C7',
                                                    padding: '0.15rem 0.4rem',
                                                    borderRadius: '10px'
                                                }}>
                                                    ⭐ Для вас
                                                </span>
                                            )}
                                        </div>
                                        <p style={{ 
                                            fontSize: '0.85rem', 
                                            color: 'var(--text-secondary)', 
                                            margin: '0.25rem 0' 
                                        }}>
                                            {program.subtitle}
                                        </p>
                                        <div style={{ fontSize: '0.8rem', color: 'var(--text-secondary)' }}>
                                            📅 {program.duration} дней
                                            {isStarted && ` • ✅ ${completedDays}/${program.duration}`}
                                        </div>
                                        {isStarted && (
                                            <div className="progress-bar" style={{ height: '4px', marginTop: '0.5rem' }}>
                                                <div className="progress-fill" style={{ 
                                                    width: `${(completedDays / program.duration) * 100}%` 
                                                }}></div>
                                            </div>
                                        )}
                                    </div>
                                    <span>→</span>
                                </div>
                            </div>
                        );
                    })}
                </div>
            );
        }

        // Страница аналитики
        function AnalyticsPage({ setPage }) {
            const [analytics, setAnalytics] = useState(DB.getAnalytics());
            
            const stateLabels = {
                heavy: { label: 'Тяжело', color: '#6B7280', emoji: '😔' },
                low_energy: { label: 'Мало сил', color: '#9CA3AF', emoji: '😴' },
                anxious: { label: 'Тревога', color: '#F59E0B', emoji: '😰' },
                neutral: { label: 'Нормально', color: '#3B82F6', emoji: '😐' },
                hopeful: { label: 'Надежда', color: '#10B981', emoji: '🌱' },
                light: { label: 'Легко', color: '#22C55E', emoji: '😊' }
            };
            
            return (
                <div className="fade-in">
                    <h1>📊 Аналитика</h1>
                    <p style={{ color: 'var(--text-secondary)', marginBottom: '1rem' }}>
                        Ваш прогресс и инсайты
                    </p>
                    
                    {/* Дерево души */}
                    <TreeWidget />
                    
                    {/* Предупреждение если есть */}
                    {analytics.prediction && (
                        <div className="card" style={{ 
                            background: '#FEF2F2', 
                            borderLeft: '4px solid #EF4444',
                            marginTop: '1rem'
                        }}>
                            <div style={{ display: 'flex', alignItems: 'flex-start', gap: '0.75rem' }}>
                                <span style={{ fontSize: '1.5rem' }}>⚠️</span>
                                <div>
                                    <strong>Внимание</strong>
                                    <p style={{ fontSize: '0.9rem', margin: '0.25rem 0' }}>
                                        {analytics.prediction.message}
                                    </p>
                                    <div style={{ fontSize: '0.85rem', marginTop: '0.5rem' }}>
                                        <strong>Что может помочь:</strong>
                                        <ul style={{ margin: '0.25rem 0', paddingLeft: '1.25rem' }}>
                                            {analytics.prediction.recommendations.map((r, i) => (
                                                <li key={i}>{r}</li>
                                            ))}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Статистика за неделю */}
                    <div className="card" style={{ marginTop: '1rem' }}>
                        <h3 style={{ marginBottom: '0.75rem' }}>📈 Эта неделя</h3>
                        <div style={{ display: 'flex', justifyContent: 'space-around', textAlign: 'center' }}>
                            <div>
                                <div style={{ fontSize: '1.5rem', fontWeight: 'bold' }}>{analytics.weekPractices}</div>
                                <div style={{ fontSize: '0.75rem', color: 'var(--text-secondary)' }}>практик</div>
                            </div>
                            <div>
                                <div style={{ fontSize: '1.5rem', fontWeight: 'bold' }}>{analytics.weekRituals}</div>
                                <div style={{ fontSize: '0.75rem', color: 'var(--text-secondary)' }}>ритуалов</div>
                            </div>
                            <div>
                                <div style={{ fontSize: '1.5rem', fontWeight: 'bold' }}>{analytics.totalDays}</div>
                                <div style={{ fontSize: '0.75rem', color: 'var(--text-secondary)' }}>дней с нами</div>
                            </div>
                        </div>
                    </div>
                    
                    {/* Распределение состояний */}
                    {Object.keys(analytics.stateDistribution).length > 0 && (
                        <div className="card" style={{ marginTop: '0.75rem' }}>
                            <h3 style={{ marginBottom: '0.75rem' }}>🎭 Состояния за месяц</h3>
                            {Object.entries(analytics.stateDistribution).map(([state, count]) => {
                                const info = stateLabels[state] || { label: state, color: '#6B7280', emoji: '❓' };
                                const total = Object.values(analytics.stateDistribution).reduce((a, b) => a + b, 0);
                                const percent = Math.round((count / total) * 100);
                                
                                return (
                                    <div key={state} style={{ marginBottom: '0.5rem' }}>
                                        <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '0.85rem' }}>
                                            <span>{info.emoji} {info.label}</span>
                                            <span>{percent}%</span>
                                        </div>
                                        <div className="progress-bar" style={{ height: '6px' }}>
                                            <div style={{ 
                                                width: `${percent}%`, 
                                                height: '100%', 
                                                background: info.color,
                                                borderRadius: '3px'
                                            }}></div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}
                    
                    {/* Инсайты */}
                    {analytics.insights.length > 0 && (
                        <div className="card" style={{ marginTop: '0.75rem' }}>
                            <h3 style={{ marginBottom: '0.75rem' }}>💡 Инсайты</h3>
                            {analytics.insights.map((insight, idx) => (
                                <div 
                                    key={idx}
                                    style={{ 
                                        padding: '0.75rem',
                                        background: insight.isWarning ? '#FEF2F2' : '#F0FDF4',
                                        borderRadius: '8px',
                                        marginBottom: '0.5rem',
                                        fontSize: '0.9rem'
                                    }}
                                >
                                    {insight.isWarning ? '⚠️' : '✨'} {insight.message}
                                </div>
                            ))}
                        </div>
                    )}
                    
                    {/* PHQ тренд */}
                    {analytics.phqTrend.length > 1 && (
                        <div className="card" style={{ marginTop: '0.75rem' }}>
                            <h3 style={{ marginBottom: '0.75rem' }}>📉 PHQ-9 Динамика</h3>
                            <div style={{ display: 'flex', justifyContent: 'space-around', alignItems: 'flex-end', height: '80px' }}>
                                {analytics.phqTrend.map((p, idx) => (
                                    <div key={idx} style={{ textAlign: 'center' }}>
                                        <div style={{ 
                                            width: '30px', 
                                            height: `${Math.max(p.score * 3, 10)}px`,
                                            background: p.score < 10 ? '#22C55E' : p.score < 15 ? '#F59E0B' : '#EF4444',
                                            borderRadius: '4px 4px 0 0'
                                        }}></div>
                                        <div style={{ fontSize: '0.7rem', marginTop: '0.25rem' }}>{p.score}</div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                    
                    {/* Топ практики */}
                    {analytics.topPractices.length > 0 && (
                        <div className="card" style={{ marginTop: '0.75rem' }}>
                            <h3 style={{ marginBottom: '0.5rem' }}>🏆 Любимые практики</h3>
                            {analytics.topPractices.slice(0, 3).map(([practiceId, count], idx) => {
                                const practice = PRACTICES.find(p => p.id === practiceId);
                                // Словарь перевода для практик программ
                                const practiceTranslations = {
                                    'breathing_calm': 'Спокойное дыхание',
                                    'warm_feet': 'Прогрев ног',
                                    'warm_shower': 'Тёплый душ',
                                    'tea_ritual': 'Ритуал чаепития',
                                    'breathing_energy': 'Энергетическое дыхание',
                                    'walk_simple': 'Простая прогулка',
                                    'stretching': 'Растяжка',
                                    'sleep_prep': 'Подготовка ко сну',
                                    'journaling': 'Ведение дневника',
                                    'walk_nature': 'Прогулка на природе',
                                    'grounding': 'Заземление',
                                    'contrast_shower': 'Контрастный душ',
                                    'hydration': 'Гидратация',
                                    'mindful_eating': 'Осознанное питание',
                                    'meal_prep': 'Подготовка еды',
                                    'morning_ritual': 'Утренний ритуал',
                                    'evening_ritual': 'Вечерний ритуал',
                                    'pleasure_list': 'Список удовольствий',
                                    'reach_out': 'Связь с близкими',
                                    'forgiveness': 'Практика прощения',
                                    'breathing_release': 'Освобождающее дыхание',
                                    'values_reflection': 'Размышление о ценностях',
                                    'strength_recall': 'Воспоминание о силе',
                                    'affirmations': 'Аффирмации',
                                    'vision_board': 'Доска желаний',
                                    'action_plan': 'План действий',
                                    'commitment': 'Обязательство себе',
                                    'celebration': 'Празднование',
                                    'intention': 'Намерение',
                                    'anxiety_education': 'Изучение тревоги',
                                    'breathing_478': 'Дыхание 4-7-8',
                                    'breathing_box': 'Квадратное дыхание',
                                    'body_scan': 'Сканирование тела',
                                    'tension_release': 'Снятие напряжения',
                                    'grounding_senses': 'Заземление 5-4-3-2-1',
                                    'cold_water': 'Холодная вода',
                                    'thought_defusion': 'Отстранение от мыслей',
                                    'acceptance': 'Принятие',
                                    'self_compassion': 'Самосострадание',
                                    'reflection': 'Рефлексия',
                                    'toolkit': 'Набор инструментов',
                                    'trigger_mapping': 'Карта триггеров',
                                    'boundary_setting': 'Установка границ',
                                    'saying_no': 'Практика "нет"',
                                    'walk_brisk': 'Быстрая прогулка',
                                    'shake_it': 'Встряска',
                                    'forest_bathing': 'Лесное купание',
                                    'nature_sounds': 'Звуки природы',
                                    'sleep_hygiene': 'Гигиена сна',
                                    'coping_plan': 'План совладания',
                                    'emergency_kit': 'Экстренный набор',
                                    'maintenance': 'Поддержание практики',
                                    'warm_breakfast': 'Тёплый завтрак',
                                    'walk_slow': 'Медленная прогулка',
                                    'breathing_fire': 'Огненное дыхание',
                                    'warm_meal': 'Тёплая еда',
                                    'spices': 'Специи',
                                    'sauna': 'Баня/сауна',
                                    'tea_after': 'Чай после бани',
                                    'warm_routine': 'Тёплый распорядок',
                                    'watercolor_warm': 'Тёплые цвета акварели',
                                    'color_therapy': 'Цветотерапия',
                                    'oil_massage': 'Масляный массаж',
                                    'aromatherapy': 'Ароматерапия',
                                    'warm_connection': 'Тёплое общение',
                                    'hug_practice': 'Практика объятий',
                                    'creative_fire': 'Творческий огонь',
                                    'sun_gazing': 'Созерцание солнца',
                                    'earthing': 'Заземление на земле',
                                    'personal_ritual': 'Личный ритуал',
                                    'fire_meditation': 'Медитация на огонь',
                                    'inner_fire': 'Внутренний огонь',
                                    'sleep_audit': 'Аудит сна',
                                    'screen_off': 'Отключение экранов',
                                    'warm_bath': 'Тёплая ванна',
                                    'thought_release': 'Отпускание мыслей',
                                    'room_optimization': 'Оптимизация спальни',
                                    'darkness': 'Темнота',
                                    'light_schedule': 'Расписание света',
                                    'consistent_time': 'Постоянное время',
                                    'sleep_formula': 'Формула сна'
                                };
                                const title = practice ? practice.title : (practiceTranslations[practiceId] || practiceId.replace(/_/g, ' '));
                                return (
                                    <div key={practiceId} style={{ 
                                        display: 'flex', 
                                        justifyContent: 'space-between',
                                        padding: '0.5rem 0',
                                        borderBottom: idx < 2 ? '1px solid #E5E7EB' : 'none'
                                    }}>
                                        <span>{['🥇', '🥈', '🥉'][idx]} {title}</span>
                                        <span style={{ color: 'var(--text-secondary)' }}>{count}×</span>
                                    </div>
                                );
                            })}
                        </div>
                    )}
                </div>
            );
        }

        // Страница кризисного плана
        function CrisisPage({ setPage }) {
            const [plan, setPlan] = useState(DB.getCrisisPlan());
            const [editing, setEditing] = useState(false);
            
            if (editing) {
                return (
                    <div className="fade-in">
                        <button className="btn btn-secondary btn-small" onClick={() => setEditing(false)}>
                            ← Назад
                        </button>
                        
                        <h1>🛡️ Мой план безопасности</h1>
                        
                        <div className="card" style={{ marginTop: '1rem' }}>
                            <h3>👥 Контакты поддержки</h3>
                            <p style={{ fontSize: '0.85rem', color: 'var(--text-secondary)' }}>
                                Люди, которым я могу позвонить
                            </p>
                            <textarea
                                value={plan.contacts.join('\n')}
                                onChange={(e) => setPlan({...plan, contacts: e.target.value.split('\n').filter(c => c)})}
                                placeholder="Имя — телефон&#10;Мама — +7...&#10;Друг — +7..."
                                rows={4}
                                style={{ width: '100%', padding: '0.75rem', borderRadius: '8px', border: '1px solid #ddd', marginTop: '0.5rem' }}
                            />
                        </div>
                        
                        <div className="card" style={{ marginTop: '0.75rem' }}>
                            <h3>⚡ Мои триггеры</h3>
                            <p style={{ fontSize: '0.85rem', color: 'var(--text-secondary)' }}>
                                Что может вызвать ухудшение
                            </p>
                            <textarea
                                value={plan.triggers.join('\n')}
                                onChange={(e) => setPlan({...plan, triggers: e.target.value.split('\n').filter(t => t)})}
                                placeholder="Недосып&#10;Конфликты&#10;Одиночество"
                                rows={3}
                                style={{ width: '100%', padding: '0.75rem', borderRadius: '8px', border: '1px solid #ddd', marginTop: '0.5rem' }}
                            />
                        </div>
                        
                        <div className="card" style={{ marginTop: '0.75rem' }}>
                            <h3>🛠️ Что мне помогает</h3>
                            <textarea
                                value={plan.copingStrategies.join('\n')}
                                onChange={(e) => setPlan({...plan, copingStrategies: e.target.value.split('\n').filter(s => s)})}
                                placeholder="Прогулка&#10;Тёплый душ&#10;Звонок другу&#10;Дыхательная практика"
                                rows={4}
                                style={{ width: '100%', padding: '0.75rem', borderRadius: '8px', border: '1px solid #ddd', marginTop: '0.5rem' }}
                            />
                        </div>
                        
                        <div className="card" style={{ marginTop: '0.75rem' }}>
                            <h3>🏠 Моё безопасное место</h3>
                            <input
                                type="text"
                                value={plan.safePlace}
                                onChange={(e) => setPlan({...plan, safePlace: e.target.value})}
                                placeholder="Моя комната, парк рядом с домом..."
                                style={{ width: '100%', padding: '0.75rem', borderRadius: '8px', border: '1px solid #ddd', marginTop: '0.5rem' }}
                            />
                        </div>
                        
                        <button 
                            className="btn btn-primary"
                            style={{ width: '100%', marginTop: '1rem' }}
                            onClick={() => {
                                DB.setCrisisPlan(plan);
                                setEditing(false);
                            }}
                        >
                            ✅ Сохранить план
                        </button>
                    </div>
                );
            }
            
            return (
                <div className="fade-in">
                    <h1>🛡️ План безопасности</h1>
                    <p style={{ color: 'var(--text-secondary)', marginBottom: '1rem' }}>
                        Ваш персональный план на случай кризиса
                    </p>
                    
                    {/* Экстренные номера */}
                    <div className="card" style={{ background: '#FEE2E2', marginBottom: '1rem' }}>
                        <h3 style={{ marginBottom: '0.5rem' }}>🆘 Экстренная помощь</h3>
                        {plan.emergencyNumbers.map((num, idx) => (
                            <a 
                                key={idx}
                                href={`tel:${num.number}`}
                                style={{ 
                                    display: 'block',
                                    padding: '0.75rem',
                                    background: 'white',
                                    borderRadius: '8px',
                                    marginBottom: '0.5rem',
                                    textDecoration: 'none',
                                    color: 'inherit'
                                }}
                            >
                                <strong>{num.name}</strong>
                                <div style={{ color: '#DC2626', fontSize: '1.1rem' }}>{num.number}</div>
                            </a>
                        ))}
                    </div>
                    
                    {/* Мои контакты */}
                    {plan.contacts.length > 0 && (
                        <div className="card" style={{ marginBottom: '0.75rem' }}>
                            <h3>👥 Мои люди</h3>
                            {plan.contacts.map((contact, idx) => (
                                <p key={idx} style={{ margin: '0.5rem 0' }}>{contact}</p>
                            ))}
                        </div>
                    )}
                    
                    {/* Что помогает */}
                    {plan.copingStrategies.length > 0 && (
                        <div className="card" style={{ marginBottom: '0.75rem', background: '#F0FDF4' }}>
                            <h3>🛠️ Что мне помогает</h3>
                            <ul style={{ margin: '0.5rem 0', paddingLeft: '1.25rem' }}>
                                {plan.copingStrategies.map((s, idx) => (
                                    <li key={idx}>{s}</li>
                                ))}
                            </ul>
                        </div>
                    )}
                    
                    {/* Безопасное место */}
                    {plan.safePlace && (
                        <div className="card" style={{ marginBottom: '0.75rem' }}>
                            <h3>🏠 Безопасное место</h3>
                            <p>{plan.safePlace}</p>
                        </div>
                    )}
                    
                    <button 
                        className="btn btn-secondary"
                        style={{ width: '100%', marginTop: '0.5rem' }}
                        onClick={() => setEditing(true)}
                    >
                        ✏️ Редактировать план
                    </button>
                    
                    {/* Быстрые практики */}
                    <div className="card" style={{ marginTop: '1rem', background: '#EFF6FF' }}>
                        <h3>⚡ Быстрая помощь</h3>
                        <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.5rem', marginTop: '0.5rem' }}>
                            <button className="btn btn-primary btn-small" onClick={() => setPage('practices')}>
                                🌬️ Дыхание 4-7-8
                            </button>
                            <button className="btn btn-primary btn-small" onClick={() => setPage('practices')}>
                                🌍 Заземление
                            </button>
                            <button className="btn btn-primary btn-small" onClick={() => setPage('practices')}>
                                🧊 Холодная вода
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function JournalPage() {
            const [entries, setEntries] = useState(DB.getJournal());
            const [writing, setWriting] = useState(false);
            const [text, setText] = useState('');
            const [state, setState] = useState('neutral');
            
            const save = () => {
                if (!text.trim()) return;
                DB.addJournalEntry({ content: text, state });
                setEntries(DB.getJournal());
                setText('');
                setWriting(false);
            };
            
            if (writing) {
                return (
                    <div className="fade-in">
                        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '1rem' }}>
                            <button className="btn btn-secondary btn-small" onClick={() => setWriting(false)}>Отмена</button>
                            <button className="btn btn-primary btn-small" onClick={save} disabled={!text.trim()}>Сохранить</button>
                        </div>
                        <h3>Как на душе?</h3>
                        <div className="soul-states">
                            {SOUL_STATES.map(s => (
                                <div key={s.id} className={`soul-chip ${state === s.id ? 'active' : ''}`} onClick={() => setState(s.id)}>
                                    <span className="soul-emoji">{s.emoji}</span>
                                    <span className="soul-label">{s.label}</span>
                                </div>
                            ))}
                        </div>
                        <textarea className="journal-textarea" placeholder="Напиши свои мысли..." value={text} onChange={e => setText(e.target.value)} autoFocus style={{ marginTop: '1rem' }} />
                    </div>
                );
            }
            
            return (
                <div className="fade-in">
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' }}>
                        <h1>Дневник</h1>
                        <button className="btn btn-primary btn-small" onClick={() => setWriting(true)}>✏️ Новая</button>
                    </div>
                    {entries.length === 0 ? (
                        <div style={{ textAlign: 'center', padding: '2rem' }}>
                            <div style={{ fontSize: '2.5rem', marginBottom: '0.5rem' }}>📝</div>
                            <p style={{ color: 'var(--text-secondary)' }}>Записей пока нет</p>
                        </div>
                    ) : entries.slice(0, 10).map(e => {
                        const s = SOUL_STATES.find(st => st.id === e.state);
                        const date = new Date(e.date);
                        return (
                            <div key={e.id} className="journal-entry">
                                <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '0.25rem' }}>
                                    <span>{s?.emoji}</span>
                                    <span style={{ fontSize: '0.75rem', color: 'var(--text-tertiary)' }}>
                                        {date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' })}
                                    </span>
                                </div>
                                <p style={{ fontSize: '0.85rem', color: 'var(--text-secondary)' }}>{e.content.slice(0, 100)}{e.content.length > 100 ? '...' : ''}</p>
                            </div>
                        );
                    })}
                </div>
            );
        }

        function ProfilePage({ setPage, setPractice }) {
            const [profile, setProfile] = useState(DB.getProfile());
            const [name, setName] = useState(profile.name || '');
            const [birthDate, setBirthDate] = useState(profile.birthDate || '');
            const [showPHQ, setShowPHQ] = useState(false);
            const [showTemperamentTest, setShowTemperamentTest] = useState(false);
            const [showBiography, setShowBiography] = useState(false);
            const [testAnswers, setTestAnswers] = useState(Array(12).fill(null));
            const [testResult, setTestResult] = useState(null);
            const [phqAnswers, setPhqAnswers] = useState(Array(9).fill(null));
            const [phqResult, setPhqResult] = useState(null);
            const [saunaDay, setSaunaDayState] = useState(DB.getSaunaDay());
            const [darkTheme, setDarkTheme] = useState(DB.get('dark_theme', false));
            const practiceHistory = DB.getPracticeHistory();
            const journalEntries = DB.getJournal();
            const saunaHistory = DB.getSaunaHistory();
            const analysis = NATURAL_WISDOM.analyzeStateHistory(DB.getStateHistory());
            
            // Биографические данные
            const biographyInsight = birthDate ? BIOGRAPHY_WORK.getBiographyInsight(birthDate, analysis?.dominantState || 'neutral') : null;
            const currentSeptennial = birthDate ? BIOGRAPHY_WORK.getCurrentSeptennial(birthDate) : null;
            const upcomingTransitions = birthDate ? BIOGRAPHY_WORK.getUpcomingTransitions(birthDate) : [];
            
            // Распорядок дня
            const [showSchedule, setShowSchedule] = useState(false);
            const [schedule, setSchedule] = useState(DB.get('daily_schedule', null));
            const [editingEvent, setEditingEvent] = useState(null);
            const [notificationsEnabled, setNotificationsEnabled] = useState(DB.get('notifications_enabled', false));
            
            // Дни с первого использования (для прогрессивной строгости)
            const firstUseDate = DB.get('first_use_date', null);
            const daysSinceFirstUse = firstUseDate 
                ? Math.floor((Date.now() - new Date(firstUseDate).getTime()) / (1000 * 60 * 60 * 24)) + 1
                : 1;
            const strictnessLevel = DAILY_SCHEDULE.getStrictnessLevel(daysSinceFirstUse);
            const strictnessInfo = DAILY_SCHEDULE.strictnessLevels[strictnessLevel];
            
            // Сохранение расписания
            const saveSchedule = (newSchedule) => {
                DB.set('daily_schedule', newSchedule);
                setSchedule(newSchedule);
                // Отправляем в Android для планирования уведомлений
                if (window.Android && window.Android.scheduleNotifications) {
                    window.Android.scheduleNotifications(JSON.stringify(newSchedule), strictnessLevel);
                }
            };
            
            // Переключение уведомлений
            const toggleNotifications = async () => {
                if (!notificationsEnabled) {
                    // Запрашиваем разрешение
                    if (window.Android && window.Android.requestNotificationPermission) {
                        window.Android.requestNotificationPermission();
                    } else if ('Notification' in window) {
                        const permission = await Notification.requestPermission();
                        if (permission === 'granted') {
                            DB.set('notifications_enabled', true);
                            setNotificationsEnabled(true);
                        }
                    }
                } else {
                    DB.set('notifications_enabled', false);
                    setNotificationsEnabled(false);
                    if (window.Android && window.Android.cancelAllNotifications) {
                        window.Android.cancelAllNotifications();
                    }
                }
            };
            
            // Обработчик разрешения уведомлений от Android
            useEffect(() => {
                window.notificationPermissionGranted = () => {
                    DB.set('notifications_enabled', true);
                    setNotificationsEnabled(true);
                    if (schedule) {
                        saveSchedule(schedule);
                    }
                };
                window.notificationPermissionDenied = () => {
                    setNotificationsEnabled(false);
                };
            }, [schedule]);
            
            // Инициализация расписания по умолчанию
            const initDefaultSchedule = () => {
                const defaultSchedule = DAILY_SCHEDULE.createDefaultSchedule();
                saveSchedule(defaultSchedule);
            };
            
            // Обновление события
            const updateEvent = (eventId, updates) => {
                const newSchedule = schedule.map(e => 
                    e.id === eventId ? { ...e, ...updates } : e
                );
                saveSchedule(newSchedule);
            };
            
            // Удаление события
            const deleteEvent = (eventId) => {
                const newSchedule = schedule.filter(e => e.id !== eventId);
                saveSchedule(newSchedule);
            };
            
            // Добавление события
            const addCustomEvent = () => {
                const newEvent = {
                    id: 'custom_' + Date.now(),
                    templateId: 'custom',
                    icon: '✨',
                    title: 'Новое событие',
                    time: '12:00',
                    category: 'custom',
                    duration: 30,
                    enabled: true,
                    notify: true
                };
                const newSchedule = [...(schedule || []), newEvent];
                saveSchedule(newSchedule);
                setEditingEvent(newEvent.id);
            };
            
            // Применение темной темы
            useEffect(() => {
                if (darkTheme) {
                    document.documentElement.classList.add('dark-theme');
                } else {
                    document.documentElement.classList.remove('dark-theme');
                }
            }, [darkTheme]);
            
            const toggleDarkTheme = () => {
                const newValue = !darkTheme;
                setDarkTheme(newValue);
                DB.set('dark_theme', newValue);
            };
            
            const DAY_NAMES = [
                { id: 0, short: 'Вс', full: 'Воскресенье', icon: '☀️', theme: 'Свет', oils: 'апельсин, ладан' },
                { id: 1, short: 'Пн', full: 'Понедельник', icon: '💧', theme: 'Вода', oils: 'лаванда, ромашка' },
                { id: 2, short: 'Вт', full: 'Вторник', icon: '🔥', theme: 'Огонь', oils: 'розмарин, имбирь' },
                { id: 3, short: 'Ср', full: 'Среда', icon: '🌬️', theme: 'Воздух', oils: 'мята, эвкалипт' },
                { id: 4, short: 'Чт', full: 'Четверг', icon: '🌳', theme: 'Дерево', oils: 'пихта, кедр' },
                { id: 5, short: 'Пт', full: 'Пятница', icon: '🌸', theme: 'Цветение', oils: 'роза, герань' },
                { id: 6, short: 'Сб', full: 'Суббота', icon: '🪨', theme: 'Земля', oils: 'кипарис, можжевельник' }
            ];
            
            const saveProfile = (updates) => {
                const newProfile = { ...profile, ...updates };
                DB.setProfile(newProfile);
                setProfile(newProfile);
            };
            
            const saveSaunaDay = (day) => {
                DB.setSaunaDay(day);
                setSaunaDayState(day);
            };
            
            // Расчёт результата теста темперамента
            const calculateTemperamentResult = () => {
                if (testAnswers.some(a => a === null)) return;
                
                const scores = { sanguine: 0, choleric: 0, melancholic: 0, phlegmatic: 0 };
                testAnswers.forEach(type => { if (type) scores[type]++; });
                
                const total = Object.values(scores).reduce((a, b) => a + b, 0);
                const percentages = {};
                Object.keys(scores).forEach(key => {
                    percentages[key] = total > 0 ? Math.round((scores[key] / total) * 100) : 0;
                });
                
                const sorted = Object.entries(scores).sort((a, b) => b[1] - a[1]);
                const primary = sorted[0][0];
                const secondary = sorted[1][1] > 1 ? sorted[1][0] : null;
                
                setTestResult({ scores, percentages, primary, secondary });
                window.scrollTo(0, 0);
                
                // Сохранить результат в профиль
                saveProfile({ temperament: primary, temperamentSecondary: secondary, temperamentScores: percentages });
            };
            
            const temperaments = Object.values(NATURAL_WISDOM.temperaments);
            
            // Экран распорядка дня
            if (showSchedule) {
                const sortedSchedule = schedule 
                    ? [...schedule].sort((a, b) => DAILY_SCHEDULE.timeToMinutes(a.time) - DAILY_SCHEDULE.timeToMinutes(b.time))
                    : [];
                
                return (
                    <div className="fade-in">
                        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '1rem' }}>
                            <button className="btn btn-secondary btn-small" onClick={() => setShowSchedule(false)}>← Назад</button>
                            <button className="btn btn-primary btn-small" onClick={addCustomEvent}>+ Добавить</button>
                        </div>
                        
                        <h1 style={{ marginBottom: '0.5rem' }}>📅 Распорядок дня</h1>
                        <p style={{ color: 'var(--text-secondary)', fontSize: '0.9rem', marginBottom: '1rem' }}>
                            Уведомления с вибросигналом о начале событий
                        </p>
                        
                        {/* Статус уведомлений */}
                        <div className="card" style={{ 
                            marginBottom: '1rem',
                            background: notificationsEnabled ? '#D1FAE5' : '#FEF3C7'
                        }}>
                            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                    <span style={{ fontSize: '1.5rem' }}>{notificationsEnabled ? '🔔' : '🔕'}</span>
                                    <div>
                                        <strong>Уведомления</strong>
                                        <p style={{ fontSize: '0.8rem', color: 'var(--text-secondary)' }}>
                                            {notificationsEnabled ? 'Включены' : 'Выключены'}
                                        </p>
                                    </div>
                                </div>
                                <button 
                                    className={`btn btn-small ${notificationsEnabled ? 'btn-secondary' : 'btn-primary'}`}
                                    onClick={toggleNotifications}
                                >
                                    {notificationsEnabled ? 'Выкл' : 'Вкл'}
                                </button>
                            </div>
                        </div>
                        
                        {/* Уровень строгости */}
                        <div className="card" style={{ 
                            marginBottom: '1rem',
                            background: strictnessLevel === 'strict' ? '#FEE2E2' : 
                                        strictnessLevel === 'moderate' ? '#FEF3C7' : '#E0E7FF'
                        }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', marginBottom: '0.5rem' }}>
                                <span style={{ fontSize: '1.25rem' }}>
                                    {strictnessLevel === 'strict' ? '🔒' : strictnessLevel === 'moderate' ? '⚡' : '🌿'}
                                </span>
                                <strong>Режим: {strictnessInfo.name}</strong>
                            </div>
                            <p style={{ fontSize: '0.85rem', color: 'var(--text-secondary)' }}>
                                {strictnessInfo.description}
                            </p>
                            <div style={{ 
                                marginTop: '0.5rem', 
                                padding: '0.5rem', 
                                background: 'rgba(255,255,255,0.5)', 
                                borderRadius: '8px',
                                fontSize: '0.8rem'
                            }}>
                                {daysSinceFirstUse < 7 ? (
                                    <span>
                                        📆 День {daysSinceFirstUse} из 7. 
                                        {daysSinceFirstUse < 3 
                                            ? ' Пока уведомления мягкие — привыкай к ритму.'
                                            : ` Через ${7 - daysSinceFirstUse} дн. включится строгий режим.`
                                        }
                                    </span>
                                ) : (
                                    <span>🔒 Строгий режим активен. Уведомления нельзя смахнуть.</span>
                                )}
                            </div>
                        </div>
                        
                        {/* Инициализация расписания */}
                        {!schedule && (
                            <div className="card" style={{ textAlign: 'center', padding: '2rem' }}>
                                <p style={{ marginBottom: '1rem' }}>Расписание ещё не создано</p>
                                <button className="btn btn-primary" onClick={initDefaultSchedule}>
                                    📋 Создать стандартное расписание
                                </button>
                            </div>
                        )}
                        
                        {/* Список событий */}
                        {schedule && sortedSchedule.length > 0 && (
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                                {sortedSchedule.map((event, i) => {
                                    const category = DAILY_SCHEDULE.categories[event.category] || DAILY_SCHEDULE.categories.custom;
                                    const isEditing = editingEvent === event.id;
                                    
                                    return (
                                        <div key={event.id} style={{ 
                                            background: event.enabled ? category.color : '#F3F4F6',
                                            borderRadius: '12px',
                                            padding: '0.75rem',
                                            opacity: event.enabled ? 1 : 0.6
                                        }}>
                                            {isEditing ? (
                                                // Режим редактирования
                                                <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                                                    <div style={{ display: 'flex', gap: '0.5rem' }}>
                                                        <input 
                                                            type="time" 
                                                            value={event.time}
                                                            onChange={e => updateEvent(event.id, { time: e.target.value })}
                                                            style={{ 
                                                                padding: '0.5rem', 
                                                                borderRadius: '8px', 
                                                                border: '1px solid var(--earth-light)',
                                                                width: '100px'
                                                            }}
                                                        />
                                                        <input 
                                                            type="text" 
                                                            value={event.title}
                                                            onChange={e => updateEvent(event.id, { title: e.target.value })}
                                                            style={{ 
                                                                flex: 1,
                                                                padding: '0.5rem', 
                                                                borderRadius: '8px', 
                                                                border: '1px solid var(--earth-light)'
                                                            }}
                                                        />
                                                    </div>
                                                    <div style={{ display: 'flex', gap: '0.5rem', justifyContent: 'space-between' }}>
                                                        <select 
                                                            value={event.category}
                                                            onChange={e => updateEvent(event.id, { category: e.target.value })}
                                                            style={{ 
                                                                padding: '0.5rem', 
                                                                borderRadius: '8px', 
                                                                border: '1px solid var(--earth-light)'
                                                            }}
                                                        >
                                                            {Object.entries(DAILY_SCHEDULE.categories).map(([key, cat]) => (
                                                                <option key={key} value={key}>{cat.icon} {cat.name}</option>
                                                            ))}
                                                        </select>
                                                        <div style={{ display: 'flex', gap: '0.25rem' }}>
                                                            <button 
                                                                className="btn btn-secondary btn-small"
                                                                onClick={() => deleteEvent(event.id)}
                                                                style={{ color: '#DC2626' }}
                                                            >
                                                                🗑️
                                                            </button>
                                                            <button 
                                                                className="btn btn-primary btn-small"
                                                                onClick={() => setEditingEvent(null)}
                                                            >
                                                                ✓
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            ) : (
                                                // Режим просмотра
                                                <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
                                                    <span style={{ fontSize: '1.5rem' }}>{event.icon}</span>
                                                    <div style={{ flex: 1 }}>
                                                        <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                                            <strong style={{ fontSize: '1rem' }}>{event.time}</strong>
                                                            <span style={{ fontSize: '0.9rem' }}>{event.title}</span>
                                                        </div>
                                                        {event.duration > 0 && (
                                                            <span style={{ fontSize: '0.75rem', color: 'var(--text-tertiary)' }}>
                                                                {event.duration} мин
                                                            </span>
                                                        )}
                                                    </div>
                                                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.25rem' }}>
                                                        <button 
                                                            className="btn btn-small"
                                                            style={{ 
                                                                background: 'transparent', 
                                                                padding: '0.25rem 0.5rem',
                                                                fontSize: '1rem'
                                                            }}
                                                            onClick={() => updateEvent(event.id, { notify: !event.notify })}
                                                        >
                                                            {event.notify ? '🔔' : '🔕'}
                                                        </button>
                                                        <button 
                                                            className="btn btn-small"
                                                            style={{ 
                                                                background: 'transparent', 
                                                                padding: '0.25rem 0.5rem',
                                                                fontSize: '1rem'
                                                            }}
                                                            onClick={() => updateEvent(event.id, { enabled: !event.enabled })}
                                                        >
                                                            {event.enabled ? '✅' : '⬜'}
                                                        </button>
                                                        <button 
                                                            className="btn btn-small"
                                                            style={{ 
                                                                background: 'transparent', 
                                                                padding: '0.25rem 0.5rem'
                                                            }}
                                                            onClick={() => setEditingEvent(event.id)}
                                                        >
                                                            ✏️
                                                        </button>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                        
                        {/* Категории событий */}
                        <div className="card" style={{ marginTop: '1rem' }}>
                            <h3 style={{ marginBottom: '0.5rem' }}>📊 Категории</h3>
                            <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.5rem' }}>
                                {Object.entries(DAILY_SCHEDULE.categories).map(([key, cat]) => (
                                    <span key={key} style={{ 
                                        padding: '0.25rem 0.5rem',
                                        background: cat.color,
                                        borderRadius: '8px',
                                        fontSize: '0.8rem'
                                    }}>
                                        {cat.icon} {cat.name}
                                    </span>
                                ))}
                            </div>
                        </div>
                        
                        {/* Информация о режиме */}
                        <div className="card" style={{ marginTop: '1rem', background: '#F8F9FA' }}>
                            <h3 style={{ marginBottom: '0.5rem' }}>ℹ️ Как это работает</h3>
                            <ul style={{ fontSize: '0.85rem', color: 'var(--text-secondary)', paddingLeft: '1.25rem', margin: 0 }}>
                                <li style={{ marginBottom: '0.25rem' }}>Дни 1-3: мягкие уведомления, можно смахнуть</li>
                                <li style={{ marginBottom: '0.25rem' }}>Дни 4-6: умеренные, повтор через 5 минут</li>
                                <li>День 7+: строгий режим — нельзя смахнуть, требует действия</li>
                            </ul>
                        </div>
                    </div>
                );
            }
            
            // Экран биографической работы
            if (showBiography && birthDate) {
                const sept = currentSeptennial;
                const transitions = upcomingTransitions;
                const polarityIndex = Math.floor(Date.now() / (1000 * 60 * 60 * 24)) % BIOGRAPHY_WORK.polarities.length;
                const todayPolarity = BIOGRAPHY_WORK.polarities[polarityIndex];
                const redThreadQuestion = BIOGRAPHY_WORK.redThreadQuestions[Math.floor(Date.now() / (1000 * 60 * 60 * 24 * 7)) % BIOGRAPHY_WORK.redThreadQuestions.length];
                
                return (
                    <div className="fade-in">
                        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '1rem' }}>
                            <button className="btn btn-secondary btn-small" onClick={() => setShowBiography(false)}>← Назад</button>
                        </div>
                        
                        <h1 style={{ marginBottom: '0.5rem' }}>📖 Биографическая работа</h1>
                        <p style={{ color: 'var(--text-secondary)', fontSize: '0.9rem', marginBottom: '1.5rem' }}>
                            Исследование жизни как пути души
                        </p>
                        
                        {/* Текущее семилетие */}
                        {sept && (
                            <div className="card" style={{ background: sept.color, marginBottom: '1rem' }}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem', marginBottom: '0.75rem' }}>
                                    <span style={{ fontSize: '2.5rem' }}>{sept.icon}</span>
                                    <div>
                                        <h2 style={{ margin: 0 }}>{sept.name}</h2>
                                        <p style={{ fontSize: '0.9rem', color: 'var(--text-secondary)', margin: 0 }}>
                                            {sept.range[0]}–{sept.range[1]} лет • Вам {sept.currentAge} лет
                                        </p>
                                    </div>
                                </div>
                                
                                <div style={{ marginBottom: '1rem' }}>
                                    <strong style={{ color: 'var(--twilight-deep)' }}>🎯 Главная тема:</strong>
                                    <p style={{ fontSize: '1.1rem', fontWeight: '600', margin: '0.25rem 0' }}>{sept.theme}</p>
                                </div>
                                
                                <div style={{ marginBottom: '1rem' }}>
                                    <strong style={{ color: 'var(--twilight-deep)' }}>⚡ Элемент:</strong>
                                    <p style={{ fontSize: '0.9rem', color: 'var(--text-secondary)', margin: '0.25rem 0' }}>{sept.element}</p>
                                </div>
                                
                                <div>
                                    <strong style={{ color: 'var(--twilight-deep)' }}>✨ Задачи периода:</strong>
                                    <ul style={{ margin: '0.5rem 0', paddingLeft: '1.25rem' }}>
                                        {sept.tasks.map((task, i) => (
                                            <li key={i} style={{ fontSize: '0.9rem', marginBottom: '0.25rem' }}>{task}</li>
                                        ))}
                                    </ul>
                                </div>
                                
                                <div style={{ 
                                    marginTop: '1rem', 
                                    padding: '0.75rem', 
                                    background: 'rgba(255,255,255,0.5)', 
                                    borderRadius: '10px' 
                                }}>
                                    <p style={{ fontSize: '0.85rem', color: 'var(--text-secondary)' }}>
                                        До конца периода: ~{sept.yearsLeft} {sept.yearsLeft === 1 ? 'год' : sept.yearsLeft < 5 ? 'года' : 'лет'}
                                    </p>
                                </div>
                            </div>
                        )}
                        
                        {/* Ближайшие переходы */}
                        {transitions.length > 0 && (
                            <div className="card" style={{ background: '#FEF3C7', marginBottom: '1rem' }}>
                                <h3 style={{ marginBottom: '0.75rem' }}>⏳ Ближайшие переходы</h3>
                                {transitions.map((t, i) => (
                                    <div key={i} style={{ 
                                        padding: '0.75rem', 
                                        background: t.isImminent ? '#FEE2E2' : 'rgba(255,255,255,0.5)', 
                                        borderRadius: '10px',
                                        marginBottom: i < transitions.length - 1 ? '0.5rem' : 0
                                    }}>
                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                            <strong style={{ fontSize: '0.9rem' }}>
                                                {t.isLunarNode ? '🌙' : '🔄'} {t.name}
                                            </strong>
                                            <span style={{ 
                                                fontSize: '0.8rem', 
                                                color: t.isImminent ? '#DC2626' : 'var(--text-secondary)' 
                                            }}>
                                                ~{Math.round(t.yearsUntil * 12)} мес.
                                            </span>
                                        </div>
                                        <p style={{ fontSize: '0.85rem', color: 'var(--text-secondary)', margin: '0.25rem 0 0' }}>
                                            {t.description || t.meaning}
                                        </p>
                                    </div>
                                ))}
                            </div>
                        )}
                        
                        {/* Вопрос для рефлексии */}
                        {sept && (
                            <div className="card" style={{ background: '#E0E7FF', marginBottom: '1rem' }}>
                                <h3 style={{ marginBottom: '0.5rem' }}>💭 Вопрос дня</h3>
                                <p style={{ fontSize: '1rem', fontStyle: 'italic', lineHeight: '1.5' }}>
                                    «{sept.questions[Math.floor(Date.now() / (1000 * 60 * 60 * 24)) % sept.questions.length]}»
                                </p>
                                <p style={{ fontSize: '0.8rem', color: 'var(--text-tertiary)', marginTop: '0.5rem' }}>
                                    Попробуйте записать ответ в дневник
                                </p>
                            </div>
                        )}
                        
                        {/* Полярности */}
                        <div className="card" style={{ background: '#F0FDF4', marginBottom: '1rem' }}>
                            <h3 style={{ marginBottom: '0.5rem' }}>⚖️ Полярность для размышления</h3>
                            <div style={{ 
                                display: 'flex', 
                                justifyContent: 'space-between', 
                                alignItems: 'center',
                                padding: '0.75rem',
                                background: 'rgba(255,255,255,0.5)',
                                borderRadius: '10px',
                                marginBottom: '0.5rem'
                            }}>
                                <span style={{ fontWeight: '600' }}>{todayPolarity.pair[0]}</span>
                                <span style={{ color: 'var(--text-tertiary)' }}>←→</span>
                                <span style={{ fontWeight: '600' }}>{todayPolarity.pair[1]}</span>
                            </div>
                            <p style={{ fontSize: '0.9rem', color: 'var(--text-secondary)' }}>
                                {todayPolarity.question}
                            </p>
                        </div>
                        
                        {/* Красная нить */}
                        <div className="card" style={{ background: '#FEE8D6', marginBottom: '1rem' }}>
                            <h3 style={{ marginBottom: '0.5rem' }}>🧵 Поиск "красной нити"</h3>
                            <p style={{ fontSize: '0.95rem', fontStyle: 'italic', lineHeight: '1.5' }}>
                                «{redThreadQuestion}»
                            </p>
                            <p style={{ fontSize: '0.8rem', color: 'var(--text-tertiary)', marginTop: '0.5rem' }}>
                                Это один из вопросов для обнаружения главной темы вашей жизни
                            </p>
                        </div>
                        
                        {/* Все семилетия */}
                        <div className="card" style={{ marginBottom: '1rem' }}>
                            <h3 style={{ marginBottom: '0.75rem' }}>🗺️ Карта жизни по семилетиям</h3>
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                                {BIOGRAPHY_WORK.septennials.slice(0, -1).map((s, i) => {
                                    const isCurrent = sept && s.range[0] === sept.range[0];
                                    const isPast = sept && s.range[1] <= sept.currentAge;
                                    return (
                                        <div key={i} style={{ 
                                            display: 'flex', 
                                            alignItems: 'center', 
                                            gap: '0.5rem',
                                            padding: '0.5rem',
                                            background: isCurrent ? s.color : isPast ? '#F3F4F6' : 'transparent',
                                            borderRadius: '8px',
                                            opacity: isPast ? 0.7 : 1
                                        }}>
                                            <span>{s.icon}</span>
                                            <span style={{ fontSize: '0.8rem', color: 'var(--text-tertiary)', width: '45px' }}>
                                                {s.range[0]}–{s.range[1]}
                                            </span>
                                            <span style={{ 
                                                fontSize: '0.85rem', 
                                                fontWeight: isCurrent ? '600' : '400',
                                                flex: 1 
                                            }}>
                                                {s.theme}
                                            </span>
                                            {isCurrent && <span style={{ fontSize: '0.8rem' }}>👈</span>}
                                            {isPast && <span style={{ fontSize: '0.8rem' }}>✓</span>}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                        
                        {/* Узлы Луны */}
                        <div className="card" style={{ background: '#1A2F4A', color: 'white', marginBottom: '1rem' }}>
                            <h3 style={{ marginBottom: '0.75rem', color: '#FCD34D' }}>🌙 Узлы Луны</h3>
                            <p style={{ fontSize: '0.85rem', opacity: 0.8, marginBottom: '0.75rem' }}>
                                Каждые 18.6 лет Луна возвращается в точку вашего рождения. 
                                Это время кармических возможностей.
                            </p>
                            {BIOGRAPHY_WORK.lunarNodes.map((node, i) => {
                                const isPast = sept && node.age < sept.currentAge;
                                const isNear = sept && Math.abs(node.age - sept.currentAge) < 2;
                                return (
                                    <div key={i} style={{ 
                                        padding: '0.5rem',
                                        background: isNear ? 'rgba(252, 211, 77, 0.2)' : 'transparent',
                                        borderRadius: '8px',
                                        marginBottom: '0.25rem',
                                        opacity: isPast ? 0.6 : 1
                                    }}>
                                        <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                                            <strong style={{ fontSize: '0.85rem' }}>{node.name}</strong>
                                            <span style={{ fontSize: '0.8rem', opacity: 0.7 }}>~{Math.round(node.age)} лет</span>
                                        </div>
                                        <p style={{ fontSize: '0.8rem', opacity: 0.7, margin: 0 }}>{node.meaning}</p>
                                    </div>
                                );
                            })}
                        </div>
                        
                        {/* Принципы биографической работы */}
                        <div className="card" style={{ marginBottom: '1rem' }}>
                            <h3 style={{ marginBottom: '0.75rem' }}>🔑 Принципы работы</h3>
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '0.75rem' }}>
                                {BIOGRAPHY_WORK.principles.map((p, i) => (
                                    <div key={i} style={{ 
                                        padding: '0.75rem', 
                                        background: '#F8F9FA', 
                                        borderRadius: '10px',
                                        borderLeft: '3px solid var(--violet)'
                                    }}>
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', marginBottom: '0.25rem' }}>
                                            <span>{p.icon}</span>
                                            <strong style={{ fontSize: '0.9rem' }}>{p.title}</strong>
                                        </div>
                                        <p style={{ fontSize: '0.8rem', color: 'var(--text-secondary)', margin: 0 }}>{p.description}</p>
                                    </div>
                                ))}
                            </div>
                        </div>
                        
                        {/* Триада: тело-душа-дух */}
                        <div className="card" style={{ marginBottom: '1rem', background: 'linear-gradient(135deg, #FEE8D6, #FFE4E4)' }}>
                            <h3 style={{ marginBottom: '0.75rem' }}>🔮 Триада: тело — душа — дух</h3>
                            <p style={{ fontSize: '0.85rem', color: 'var(--text-secondary)', marginBottom: '0.75rem' }}>
                                Биография рассматривается в трёх измерениях. Изменения в одном отражаются в других.
                            </p>
                            {Object.values(BIOGRAPHY_WORK.triadQuestions).map((triad, i) => (
                                <div key={i} style={{ 
                                    background: 'rgba(255,255,255,0.7)', 
                                    padding: '0.75rem', 
                                    borderRadius: '10px',
                                    marginBottom: i < 2 ? '0.5rem' : 0
                                }}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', marginBottom: '0.5rem' }}>
                                        <span>{triad.icon}</span>
                                        <strong style={{ fontSize: '0.9rem' }}>{triad.title}</strong>
                                    </div>
                                    <p style={{ fontSize: '0.8rem', color: 'var(--text-secondary)', fontStyle: 'italic' }}>
                                        «{triad.questions[Math.floor(Date.now() / (1000 * 60 * 60 * 24)) % triad.questions.length]}»
                                    </p>
                                </div>
                            ))}
                        </div>
                        
                        {/* Практические упражнения */}
                        <div className="card" style={{ marginBottom: '1rem' }}>
                            <h3 style={{ marginBottom: '0.75rem' }}>📝 Практические упражнения</h3>
                            <p style={{ fontSize: '0.85rem', color: 'var(--text-secondary)', marginBottom: '0.75rem' }}>
                                Выберите упражнение для самостоятельной работы с биографией
                            </p>
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                                {BIOGRAPHY_WORK.exercises.map((ex, i) => (
                                    <details key={i} style={{ 
                                        background: '#F8F9FA', 
                                        borderRadius: '10px',
                                        overflow: 'hidden'
                                    }}>
                                        <summary style={{ 
                                            padding: '0.75rem', 
                                            cursor: 'pointer',
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '0.5rem',
                                            fontWeight: '500'
                                        }}>
                                            <span>{ex.icon}</span>
                                            <span style={{ flex: 1 }}>{ex.title}</span>
                                            <span style={{ fontSize: '0.75rem', color: 'var(--text-tertiary)' }}>
                                                {ex.duration}
                                            </span>
                                        </summary>
                                        <div style={{ padding: '0 0.75rem 0.75rem' }}>
                                            <p style={{ fontSize: '0.85rem', color: 'var(--text-secondary)', marginBottom: '0.5rem' }}>
                                                {ex.description}
                                            </p>
                                            <div style={{ background: 'white', padding: '0.75rem', borderRadius: '8px' }}>
                                                <strong style={{ fontSize: '0.8rem', display: 'block', marginBottom: '0.5rem' }}>Как делать:</strong>
                                                <ol style={{ margin: 0, paddingLeft: '1.25rem', fontSize: '0.8rem' }}>
                                                    {ex.instructions.map((inst, j) => (
                                                        <li key={j} style={{ marginBottom: '0.25rem', color: 'var(--text-secondary)' }}>{inst}</li>
                                                    ))}
                                                </ol>
                                            </div>
                                            <p style={{ fontSize: '0.75rem', color: 'var(--text-tertiary)', marginTop: '0.5rem' }}>
                                                Частота: {ex.frequency}
                                            </p>
                                        </div>
                                    </details>
                                ))}
                            </div>
                        </div>
                        
                        {/* 5 этапов биографической работы */}
                        <div className="card" style={{ marginBottom: '1rem', background: '#EFF6FF' }}>
                            <h3 style={{ marginBottom: '0.75rem' }}>🗺️ Пять этапов работы</h3>
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                                {BIOGRAPHY_WORK.workStages.map((stage, i) => (
                                    <div key={i} style={{ 
                                        display: 'flex', 
                                        gap: '0.75rem',
                                        alignItems: 'flex-start'
                                    }}>
                                        <div style={{ 
                                            width: '28px', 
                                            height: '28px', 
                                            background: 'var(--twilight-blue)', 
                                            color: 'white',
                                            borderRadius: '50%',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            fontSize: '0.85rem',
                                            fontWeight: 'bold',
                                            flexShrink: 0
                                        }}>
                                            {stage.stage}
                                        </div>
                                        <div style={{ flex: 1 }}>
                                            <strong style={{ fontSize: '0.9rem', display: 'block' }}>{stage.title}</strong>
                                            <p style={{ fontSize: '0.8rem', color: 'var(--text-secondary)', margin: '0.25rem 0' }}>
                                                {stage.description}
                                            </p>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                        
                        {/* Вопросы для переходных периодов */}
                        {sept && BIOGRAPHY_WORK.transitionQuestions[Math.floor(sept.currentAge / 7) * 7] && (
                            <div className="card" style={{ marginBottom: '1rem', background: '#FEF3C7' }}>
                                <h3 style={{ marginBottom: '0.5rem' }}>🔄 Вопросы для вашего возраста</h3>
                                <p style={{ fontSize: '0.85rem', color: 'var(--text-secondary)', marginBottom: '0.75rem' }}>
                                    {(() => {
                                        const key = Object.keys(BIOGRAPHY_WORK.transitionQuestions)
                                            .map(Number)
                                            .filter(k => Math.abs(k - sept.currentAge) < 5)
                                            .sort((a, b) => Math.abs(a - sept.currentAge) - Math.abs(b - sept.currentAge))[0];
                                        return key ? BIOGRAPHY_WORK.transitionQuestions[key]?.name : '';
                                    })()}
                                </p>
                                {(() => {
                                    const key = Object.keys(BIOGRAPHY_WORK.transitionQuestions)
                                        .map(Number)
                                        .filter(k => Math.abs(k - sept.currentAge) < 5)
                                        .sort((a, b) => Math.abs(a - sept.currentAge) - Math.abs(b - sept.currentAge))[0];
                                    const questions = key ? BIOGRAPHY_WORK.transitionQuestions[key]?.questions : [];
                                    return questions?.map((q, i) => (
                                        <p key={i} style={{ 
                                            fontSize: '0.85rem', 
                                            padding: '0.5rem',
                                            background: 'rgba(255,255,255,0.5)',
                                            borderRadius: '8px',
                                            marginBottom: i < questions.length - 1 ? '0.25rem' : 0
                                        }}>
                                            «{q}»
                                        </p>
                                    ));
                                })()}
                            </div>
                        )}
                        
                        {/* О методе */}
                        <div className="card" style={{ background: '#F5F0FF' }}>
                            <h3 style={{ marginBottom: '0.5rem' }}>📚 О биографической работе</h3>
                            <p style={{ fontSize: '0.85rem', color: 'var(--text-secondary)', lineHeight: '1.6' }}>
                                Биографическая работа в антропософском смысле — это осознанное исследование 
                                своей жизни как пути души. События рассматриваются не только психологически, 
                                но и как смысловые вехи.
                            </p>
                            <p style={{ fontSize: '0.85rem', color: 'var(--text-secondary)', lineHeight: '1.6', marginTop: '0.5rem' }}>
                                Цель — не красивый рассказ о прошлом, а пробуждение внутренней свободы 
                                и ответственности за дальнейший путь.
                            </p>
                            <p style={{ fontSize: '0.8rem', color: 'var(--text-tertiary)', marginTop: '0.75rem', fontStyle: 'italic' }}>
                                Основано на работах Гудрун Буркхард и антропософской традиции
                            </p>
                        </div>
                    </div>
                );
            }
            
            // Экран теста темперамента
            if (showTemperamentTest) {
                const currentQ = testAnswers.findIndex(a => a === null);
                const progress = testAnswers.filter(a => a !== null).length;
                
                if (testResult) {
                    const desc = TEMPERAMENT_TEST.getDescription(testResult.primary);
                    const secondaryDesc = testResult.secondary ? TEMPERAMENT_TEST.getDescription(testResult.secondary) : null;
                    
                    return (
                        <div className="fade-in">
                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '1rem' }}>
                                <button className="btn btn-secondary btn-small" onClick={() => { setShowTemperamentTest(false); setTestResult(null); setTestAnswers(Array(12).fill(null)); }}>← Закрыть</button>
                            </div>
                            
                            <div style={{ textAlign: 'center', marginBottom: '1.5rem' }}>
                                <div style={{ fontSize: '4rem', marginBottom: '0.5rem' }}>{desc.icon}</div>
                                <h1 style={{ color: desc.color }}>{desc.title}</h1>
                                <p style={{ color: 'var(--text-secondary)' }}>Стихия: {desc.element}</p>
                            </div>
                            
                            {/* Процентное соотношение */}
                            <div className="card" style={{ marginBottom: '1rem' }}>
                                <h3 style={{ marginBottom: '0.75rem' }}>Ваш темперамент</h3>
                                {Object.entries(testResult.percentages).sort((a, b) => b[1] - a[1]).map(([type, pct]) => {
                                    const info = TEMPERAMENT_TEST.getDescription(type);
                                    return (
                                        <div key={type} style={{ marginBottom: '0.5rem' }}>
                                            <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '0.85rem', marginBottom: '0.25rem' }}>
                                                <span>{info.icon} {info.title}</span>
                                                <span style={{ fontWeight: 'bold' }}>{pct}%</span>
                                            </div>
                                            <div className="progress-bar" style={{ height: '8px' }}>
                                                <div className="progress-fill" style={{ width: `${pct}%`, background: info.color }}></div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                            
                            {/* Сильные стороны */}
                            <div className="card" style={{ marginBottom: '0.75rem', background: desc.color + '15' }}>
                                <h3 style={{ marginBottom: '0.5rem' }}>💪 Сильные стороны</h3>
                                {desc.strengths.map((s, i) => (
                                    <p key={i} style={{ fontSize: '0.85rem', marginBottom: '0.25rem' }}>• {s}</p>
                                ))}
                            </div>
                            
                            {/* Зоны роста */}
                            <div className="card" style={{ marginBottom: '0.75rem' }}>
                                <h3 style={{ marginBottom: '0.5rem' }}>🌱 Пути развития</h3>
                                {desc.challenges.map((c, i) => (
                                    <p key={i} style={{ fontSize: '0.85rem', marginBottom: '0.25rem' }}>• {c}</p>
                                ))}
                            </div>
                            
                            {/* Рекомендации */}
                            <div className="recommendation-card" style={{ marginBottom: '0.75rem' }}>
                                <div className="recommendation-title">💡 Рекомендация</div>
                                <p style={{ fontSize: '0.9rem' }}>{desc.tip}</p>
                            </div>
                            
                            {/* Практики */}
                            <div className="card" style={{ marginBottom: '1rem' }}>
                                <h3 style={{ marginBottom: '0.5rem' }}>✨ Рекомендуемые практики</h3>
                                <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.4rem' }}>
                                    {desc.practices.map((p, i) => (
                                        <span key={i} className="btn btn-secondary btn-small">{p}</span>
                                    ))}
                                </div>
                            </div>
                            
                            {secondaryDesc && (
                                <div className="alert alert-info">
                                    <span>{secondaryDesc.icon}</span>
                                    <div>
                                        <strong>Вторичный темперамент: {secondaryDesc.title}</strong>
                                        <p style={{ fontSize: '0.8rem' }}>Его черты также проявляются в вашем характере</p>
                                    </div>
                                </div>
                            )}
                            
                            <button className="btn btn-primary btn-full" style={{ marginTop: '1rem' }} onClick={() => { setShowTemperamentTest(false); setTestResult(null); setTestAnswers(Array(12).fill(null)); }}>
                                Готово
                            </button>
                        </div>
                    );
                }
                
                return (
                    <div className="fade-in">
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' }}>
                            <button className="btn btn-secondary btn-small" onClick={() => { setShowTemperamentTest(false); setTestAnswers(Array(12).fill(null)); }}>← Отмена</button>
                            <span style={{ fontSize: '0.85rem', color: 'var(--text-secondary)' }}>{progress}/12</span>
                        </div>
                        
                        <div className="progress-bar" style={{ height: '6px', marginBottom: '1.5rem' }}>
                            <div className="progress-fill" style={{ width: `${(progress / 12) * 100}%` }}></div>
                        </div>
                        
                        <h2 style={{ marginBottom: '1.5rem' }}>Тест на темперамент</h2>
                        
                        {TEMPERAMENT_TEST.questions.map((q, qIdx) => (
                            <div key={qIdx} className="card" style={{ marginBottom: '0.75rem', background: testAnswers[qIdx] ? '#F0FDF4' : 'white' }}>
                                <p style={{ fontWeight: '600', marginBottom: '0.75rem', fontSize: '0.9rem' }}>
                                    {qIdx + 1}. {q.text}
                                </p>
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '0.4rem' }}>
                                    {q.answers.map((a, aIdx) => (
                                        <button 
                                            key={aIdx}
                                            className={`btn btn-small ${testAnswers[qIdx] === a.type ? 'btn-primary' : 'btn-secondary'}`}
                                            style={{ textAlign: 'left', whiteSpace: 'normal', height: 'auto', padding: '0.6rem 0.75rem' }}
                                            onClick={() => { 
                                                const newAnswers = [...testAnswers]; 
                                                newAnswers[qIdx] = a.type; 
                                                setTestAnswers(newAnswers); 
                                            }}
                                        >
                                            {a.text}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        ))}
                        
                        <button 
                            className="btn btn-primary btn-full" 
                            style={{ marginTop: '1rem' }}
                            onClick={calculateTemperamentResult}
                            disabled={testAnswers.some(a => a === null)}
                        >
                            Показать результат
                        </button>
                    </div>
                );
            }
            
            const calculatePHQ = () => {
                if (phqAnswers.some(a => a === null)) return;
                const score = phqAnswers.reduce((sum, a) => sum + a, 0);
                let severity, color, recommendation;
                if (score <= 4) { severity = 'Минимальная'; color = '#10B981'; recommendation = 'Продолжайте практики для поддержания состояния'; }
                else if (score <= 9) { severity = 'Лёгкая'; color = '#F59E0B'; recommendation = 'Рекомендуются ежедневные практики света и тепла'; }
                else if (score <= 14) { severity = 'Умеренная'; color = '#F97316'; recommendation = 'Желательна консультация специалиста + практики'; }
                else if (score <= 19) { severity = 'Умеренно-тяжёлая'; color = '#EF4444'; recommendation = 'Рекомендуется обратиться к специалисту'; }
                else { severity = 'Тяжёлая'; color = '#DC2626'; recommendation = 'Необходима профессиональная помощь'; }
                setPhqResult({ score, severity, color, recommendation });
                window.scrollTo(0, 0);
                DB.addPhqResult(score);
            };
            
            const phqHistory = DB.getPhqHistory();
            const shouldShowPhqReminder = DB.shouldShowPhqReminder();
            
            if (showPHQ) {
                return (
                    <div className="fade-in">
                        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '1rem' }}>
                            <button className="btn btn-secondary btn-small" onClick={() => { setShowPHQ(false); setPhqResult(null); setPhqAnswers(Array(9).fill(null)); }}>← Назад</button>
                        </div>
                        
                        {!phqResult ? (
                            <>
                                <h1>Оценка состояния</h1>
                                <p style={{ fontSize: '0.85rem', color: 'var(--text-secondary)', marginBottom: '1rem' }}>
                                    За последние 2 недели как часто вас беспокоило:
                                </p>
                                
                                {PHQ9_QUESTIONS.map((q, idx) => (
                                    <div key={idx} className="card" style={{ marginBottom: '0.5rem' }}>
                                        <p style={{ fontSize: '0.9rem', marginBottom: '0.5rem' }}>{idx + 1}. {q}</p>
                                        <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.4rem' }}>
                                            {PHQ9_OPTIONS.map(opt => (
                                                <button 
                                                    key={opt.value}
                                                    className={`btn btn-small ${phqAnswers[idx] === opt.value ? 'btn-primary' : 'btn-secondary'}`}
                                                    onClick={() => { const n = [...phqAnswers]; n[idx] = opt.value; setPhqAnswers(n); }}
                                                    style={{ fontSize: '0.7rem', padding: '6px 10px' }}
                                                >
                                                    {opt.label}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                ))}
                                
                                <button 
                                    className="btn btn-primary btn-full" 
                                    style={{ marginTop: '1rem' }}
                                    onClick={calculatePHQ}
                                    disabled={phqAnswers.some(a => a === null)}
                                >
                                    Показать результат
                                </button>
                            </>
                        ) : (
                            <div style={{ textAlign: 'center' }}>
                                <h1>Результат PHQ-9</h1>
                                <div style={{ fontSize: '3rem', fontWeight: 'bold', color: phqResult.color, margin: '1rem 0' }}>
                                    {phqResult.score} / 27
                                </div>
                                <div style={{ fontSize: '1.2rem', fontWeight: '600', color: phqResult.color, marginBottom: '1rem' }}>
                                    {phqResult.severity} депрессия
                                </div>
                                <div className="card" style={{ textAlign: 'left' }}>
                                    <p>{phqResult.recommendation}</p>
                                </div>
                                
                                {/* График истории PHQ */}
                                {phqHistory.length > 1 && (
                                    <div className="card" style={{ marginTop: '1rem', textAlign: 'left' }}>
                                        <h3 style={{ marginBottom: '0.75rem' }}>📊 История оценок</h3>
                                        <div style={{ display: 'flex', alignItems: 'flex-end', gap: '4px', height: '100px', padding: '0.5rem 0' }}>
                                            {phqHistory.slice(-10).map((item, idx) => {
                                                const height = Math.max(10, (item.score / 27) * 100);
                                                const barColor = item.score <= 4 ? '#10B981' : item.score <= 9 ? '#F59E0B' : item.score <= 14 ? '#F97316' : '#EF4444';
                                                const date = new Date(item.date);
                                                return (
                                                    <div key={idx} style={{ flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center' }}>
                                                        <span style={{ fontSize: '0.65rem', marginBottom: '2px' }}>{item.score}</span>
                                                        <div style={{ 
                                                            width: '100%', 
                                                            height: height + '%', 
                                                            background: barColor,
                                                            borderRadius: '4px 4px 0 0',
                                                            minHeight: '10px'
                                                        }} />
                                                        <span style={{ fontSize: '0.55rem', color: 'var(--text-tertiary)', marginTop: '2px' }}>
                                                            {date.getDate()}/{date.getMonth() + 1}
                                                        </span>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                        <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '0.65rem', color: 'var(--text-tertiary)', marginTop: '0.5rem' }}>
                                            <span>🟢 0-4 мин.</span>
                                            <span>🟡 5-9 лёгк.</span>
                                            <span>🟠 10-14 умер.</span>
                                            <span>🔴 15+ тяж.</span>
                                        </div>
                                    </div>
                                )}
                                
                                {phqResult.score >= 10 && (
                                    <div className="alert alert-warning" style={{ marginTop: '1rem', textAlign: 'left' }}>
                                        <span>📞</span>
                                        <div>
                                            <strong>Горячие линии помощи:</strong><br/>
                                            8-800-2000-122 (бесплатно, 24/7)
                                        </div>
                                    </div>
                                )}
                                <button className="btn btn-primary btn-full" style={{ marginTop: '1rem' }} onClick={() => { setShowPHQ(false); setPhqResult(null); setPhqAnswers(Array(9).fill(null)); }}>
                                    Готово
                                </button>
                            </div>
                        )}
                    </div>
                );
            }
            
            return (
                <div className="fade-in">
                    <h1>Профиль</h1>
                    
                    {/* Тема оформления */}
                    <div 
                        className="card" 
                        style={{ 
                            marginTop: '0.75rem', 
                            display: 'flex', 
                            justifyContent: 'space-between', 
                            alignItems: 'center'
                        }}
                    >
                        <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                            <span style={{ fontSize: '1.25rem' }}>{darkTheme ? '🌙' : '☀️'}</span>
                            <div>
                                <strong style={{ fontSize: '0.9rem' }}>Тема оформления</strong>
                                <p style={{ fontSize: '0.75rem', color: 'var(--text-secondary)' }}>
                                    {darkTheme ? 'Тёмная тема' : 'Светлая тема'}
                                </p>
                            </div>
                        </div>
                        <div 
                            onClick={toggleDarkTheme}
                            style={{ 
                                width: '50px', 
                                height: '28px', 
                                borderRadius: '14px', 
                                background: darkTheme ? 'var(--twilight-deep)' : '#ccc',
                                position: 'relative',
                                cursor: 'pointer',
                                transition: 'background 0.3s'
                            }}
                        >
                            <div style={{
                                width: '24px',
                                height: '24px',
                                borderRadius: '12px',
                                background: darkTheme ? '#FCD34D' : 'white',
                                position: 'absolute',
                                top: '2px',
                                left: darkTheme ? '24px' : '2px',
                                transition: 'left 0.3s, background 0.3s',
                                boxShadow: '0 1px 3px rgba(0,0,0,0.2)'
                            }} />
                        </div>
                    </div>
                    
                    <div className="grid-2" style={{ marginTop: '1rem', marginBottom: '1rem' }}>
                        <div className="stat-card">
                            <div className="stat-value">{practiceHistory.length}</div>
                            <div className="stat-label">практик</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-value">{journalEntries.length}</div>
                            <div className="stat-label">записей</div>
                        </div>
                    </div>
                    
                    {analysis?.trend && (
                        <div className="card" style={{ marginBottom: '0.75rem' }}>
                            <strong>Тренд за 7 дней:</strong>{' '}
                            {analysis.trend === 'improving' ? '📈 Улучшение' : analysis.trend === 'declining' ? '📉 Снижение' : '➡️ Стабильно'}
                        </div>
                    )}
                    
                    {/* PHQ-9 - removed from here, now below name */}
                    
                    <div className="card">
                        <h3 style={{ marginBottom: '0.5rem' }}>Имя</h3>
                        <div style={{ display: 'flex', gap: '0.5rem' }}>
                            <input type="text" value={name} onChange={e => setName(e.target.value)} placeholder="Как тебя зовут?" style={{ flex: 1, padding: '10px', borderRadius: '10px', border: '1px solid var(--earth-light)', fontSize: '0.9rem', fontFamily: 'inherit' }} />
                            <button className="btn btn-primary btn-small" onClick={() => saveProfile({ name })}>✓</button>
                        </div>
                    </div>
                    
                    {/* Дата рождения */}
                    <div className="card" style={{ marginTop: '0.75rem' }}>
                        <h3 style={{ marginBottom: '0.5rem' }}>Дата рождения</h3>
                        <p style={{ fontSize: '0.8rem', color: 'var(--text-secondary)', marginBottom: '0.5rem' }}>
                            Для биографической работы и расчёта жизненных циклов
                        </p>
                        <div style={{ display: 'flex', gap: '0.5rem' }}>
                            <input 
                                type="date" 
                                value={birthDate} 
                                onChange={e => setBirthDate(e.target.value)} 
                                style={{ 
                                    flex: 1, 
                                    padding: '10px', 
                                    borderRadius: '10px', 
                                    border: '1px solid var(--earth-light)', 
                                    fontSize: '0.9rem', 
                                    fontFamily: 'inherit' 
                                }} 
                            />
                            <button className="btn btn-primary btn-small" onClick={() => saveProfile({ birthDate })}>✓</button>
                        </div>
                        {currentSeptennial && (
                            <div style={{ marginTop: '0.75rem', padding: '0.75rem', background: currentSeptennial.color, borderRadius: '10px' }}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', marginBottom: '0.25rem' }}>
                                    <span style={{ fontSize: '1.25rem' }}>{currentSeptennial.icon}</span>
                                    <strong>{currentSeptennial.name}</strong>
                                    <span style={{ fontSize: '0.8rem', color: 'var(--text-secondary)' }}>
                                        ({currentSeptennial.currentAge} лет)
                                    </span>
                                </div>
                                <p style={{ fontSize: '0.85rem', color: 'var(--text-secondary)' }}>
                                    Тема: {currentSeptennial.theme}
                                </p>
                            </div>
                        )}
                    </div>
                    
                    {/* Биографическая работа */}
                    {birthDate && (
                        <div 
                            className="card card-clickable" 
                            style={{ 
                                marginTop: '0.75rem',
                                background: 'linear-gradient(135deg, #F5F0FF, #EDE9FE)'
                            }}
                            onClick={() => setShowBiography(true)}
                        >
                            <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
                                <span style={{ fontSize: '2rem' }}>📖</span>
                                <div style={{ flex: 1 }}>
                                    <strong>Биографическая работа</strong>
                                    <p style={{ fontSize: '0.8rem', color: 'var(--text-secondary)', marginTop: '0.25rem' }}>
                                        Семилетия, кризисы, "красная нить" жизни
                                    </p>
                                </div>
                                <span style={{ color: 'var(--text-tertiary)' }}>→</span>
                            </div>
                            {upcomingTransitions.length > 0 && (
                                <div style={{ 
                                    marginTop: '0.5rem', 
                                    paddingTop: '0.5rem', 
                                    borderTop: '1px solid rgba(0,0,0,0.1)' 
                                }}>
                                    <span style={{ fontSize: '0.75rem', color: 'var(--violet)' }}>
                                        ⏳ {upcomingTransitions[0].name} через ~{Math.round(upcomingTransitions[0].yearsUntil * 12)} мес.
                                    </span>
                                </div>
                            )}
                        </div>
                    )}
                    
                    {/* Распорядок дня */}
                    <div 
                        className="card card-clickable" 
                        style={{ 
                            marginTop: '0.75rem',
                            background: schedule 
                                ? (strictnessLevel === 'strict' ? 'linear-gradient(135deg, #FEE2E2, #FECACA)' : 'linear-gradient(135deg, #D1FAE5, #A7F3D0)')
                                : 'linear-gradient(135deg, #FEF3C7, #FDE68A)'
                        }}
                        onClick={() => setShowSchedule(true)}
                    >
                        <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
                            <span style={{ fontSize: '2rem' }}>📅</span>
                            <div style={{ flex: 1 }}>
                                <strong>Распорядок дня</strong>
                                <p style={{ fontSize: '0.8rem', color: 'var(--text-secondary)', marginTop: '0.25rem' }}>
                                    {schedule 
                                        ? `${schedule.filter(e => e.enabled).length} событий • ${notificationsEnabled ? '🔔' : '🔕'}`
                                        : 'Настрой режим и уведомления'
                                    }
                                </p>
                            </div>
                            <span style={{ color: 'var(--text-tertiary)' }}>→</span>
                        </div>
                        {schedule && (
                            <div style={{ 
                                marginTop: '0.5rem', 
                                paddingTop: '0.5rem', 
                                borderTop: '1px solid rgba(0,0,0,0.1)',
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'center'
                            }}>
                                <span style={{ fontSize: '0.75rem', color: 'var(--text-secondary)' }}>
                                    {(() => {
                                        const next = DAILY_SCHEDULE.getNextEvent(schedule);
                                        if (next) {
                                            const hrs = Math.floor(next.minutesUntil / 60);
                                            const mins = next.minutesUntil % 60;
                                            return `${next.icon} ${next.title} через ${hrs > 0 ? hrs + 'ч ' : ''}${mins}мин`;
                                        }
                                        return 'Нет предстоящих событий';
                                    })()}
                                </span>
                                {strictnessLevel === 'strict' && (
                                    <span style={{ fontSize: '0.7rem', color: '#DC2626' }}>🔒 Строгий</span>
                                )}
                            </div>
                        )}
                    </div>
                    
                    {/* PHQ-9 - теперь после имени */}
                    <div 
                        className="card card-clickable" 
                        style={{ 
                            marginTop: '0.75rem',
                            background: shouldShowPhqReminder ? '#FEF3C7' : '#F0F9FF',
                            border: shouldShowPhqReminder ? '2px solid var(--amber)' : 'none'
                        }} 
                        onClick={() => setShowPHQ(true)}
                    >
                        <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                            <span style={{ fontSize: '1.25rem' }}>📋</span>
                            <div style={{ flex: 1 }}>
                                <strong>Оценить состояние (PHQ-9)</strong>
                                <p style={{ fontSize: '0.75rem', color: 'var(--text-secondary)' }}>
                                    {shouldShowPhqReminder 
                                        ? '⏰ Пора пройти тест снова' 
                                        : 'Стандартизированный тест депрессии'
                                    }
                                </p>
                            </div>
                            {shouldShowPhqReminder && <span style={{ fontSize: '1.25rem' }}>→</span>}
                        </div>
                        {phqHistory.length > 0 && (
                            <div style={{ marginTop: '0.5rem', paddingTop: '0.5rem', borderTop: '1px solid var(--earth-light)' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '0.75rem', color: 'var(--text-secondary)' }}>
                                    <span>Последний результат: <strong style={{ color: phqHistory[phqHistory.length-1].score <= 4 ? '#10B981' : phqHistory[phqHistory.length-1].score <= 9 ? '#F59E0B' : '#EF4444' }}>{phqHistory[phqHistory.length-1].score}/27</strong></span>
                                    <span>{new Date(phqHistory[phqHistory.length-1].date).toLocaleDateString('ru-RU')}</span>
                                </div>
                            </div>
                        )}
                    </div>
                    
                    {/* ═══════════════════════════════════════════════════════════════ */}
                    {/* НОВЫЕ ВИДЖЕТЫ: Дерево, Ритуалы, Программы, Аналитика */}
                    {/* ═══════════════════════════════════════════════════════════════ */}
                    
                    {/* Дерево души - компактный виджет */}
                    <div 
                        className="card card-clickable"
                        style={{ marginTop: '0.75rem' }}
                        onClick={() => setPage('analytics')}
                    >
                        <TreeWidget compact={true} />
                    </div>
                    
                    {/* Ритуал дня */}
                    {(() => {
                        const ritualHour = new Date().getHours();
                        const suggestedRitual = ritualHour >= 5 && ritualHour < 11 ? 'morning' : 
                                               ritualHour >= 19 && ritualHour < 23 ? 'evening' : null;
                        
                        if (suggestedRitual) {
                            return (
                                <div 
                                    className="card card-clickable"
                                    style={{ 
                                        marginTop: '0.75rem',
                                        background: suggestedRitual === 'morning' 
                                            ? 'linear-gradient(135deg, #FEF3C7, #FDE68A)' 
                                            : 'linear-gradient(135deg, #E0E7FF, #C7D2FE)'
                                    }}
                                    onClick={() => setPage('rituals')}
                                >
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
                                        <span style={{ fontSize: '2rem' }}>
                                            {suggestedRitual === 'morning' ? '☀️' : '🌙'}
                                        </span>
                                        <div style={{ flex: 1 }}>
                                            <strong>
                                                {suggestedRitual === 'morning' ? 'Утренний ритуал' : 'Вечерний ритуал'}
                                            </strong>
                                            <p style={{ fontSize: '0.8rem', margin: 0 }}>
                                                {suggestedRitual === 'morning' 
                                                    ? 'Осознанное начало дня' 
                                                    : 'Мягкое завершение дня'}
                                            </p>
                                        </div>
                                        <span>→</span>
                                    </div>
                                </div>
                            );
                        }
                        return null;
                    })()}
                    
                    {/* Предупреждение предиктивной системы */}
                    {(() => {
                        const prediction = DB.getPrediction();
                        if (prediction) {
                            return (
                                <div 
                                    className="card"
                                    style={{ 
                                        marginTop: '0.75rem',
                                        background: '#FEF2F2',
                                        borderLeft: '4px solid #EF4444'
                                    }}
                                >
                                    <div style={{ display: 'flex', alignItems: 'flex-start', gap: '0.75rem' }}>
                                        <span style={{ fontSize: '1.5rem' }}>⚠️</span>
                                        <div style={{ flex: 1 }}>
                                            <strong>Внимание</strong>
                                            <p style={{ fontSize: '0.85rem', margin: '0.25rem 0' }}>
                                                {prediction.message}
                                            </p>
                                            <button 
                                                className="btn btn-small"
                                                style={{ marginTop: '0.5rem', background: '#FEE2E2', color: '#DC2626' }}
                                                onClick={() => setPage('crisis')}
                                            >
                                                🛡️ План безопасности
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            );
                        }
                        return null;
                    })()}
                    
                    {/* Быстрый доступ к новым разделам */}
                    <div style={{ 
                        display: 'grid', 
                        gridTemplateColumns: 'repeat(3, 1fr)', 
                        gap: '0.5rem', 
                        marginTop: '0.75rem' 
                    }}>
                        <div 
                            className="card card-clickable" 
                            style={{ textAlign: 'center', padding: '0.75rem' }}
                            onClick={() => setPage('programs')}
                        >
                            <div style={{ fontSize: '1.5rem' }}>📚</div>
                            <div style={{ fontSize: '0.7rem', marginTop: '0.25rem' }}>Программы</div>
                        </div>
                        <div 
                            className="card card-clickable" 
                            style={{ textAlign: 'center', padding: '0.75rem' }}
                            onClick={() => setPage('analytics')}
                        >
                            <div style={{ fontSize: '1.5rem' }}>📊</div>
                            <div style={{ fontSize: '0.7rem', marginTop: '0.25rem' }}>Аналитика</div>
                        </div>
                        <div 
                            className="card card-clickable" 
                            style={{ textAlign: 'center', padding: '0.75rem' }}
                            onClick={() => setPage('crisis')}
                        >
                            <div style={{ fontSize: '1.5rem' }}>🛡️</div>
                            <div style={{ fontSize: '0.7rem', marginTop: '0.25rem' }}>SOS</div>
                        </div>
                    </div>
                    
                    <div className="card" style={{ marginTop: '0.75rem' }}>
                        <h3 style={{ marginBottom: '0.5rem' }}>Темперамент</h3>
                        
                        {/* Кнопка теста */}
                        <div 
                            className="card card-clickable" 
                            style={{ background: '#EFF6FF', marginBottom: '0.75rem', padding: '0.75rem' }}
                            onClick={() => setShowTemperamentTest(true)}
                        >
                            <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                <span style={{ fontSize: '1.5rem' }}>🧪</span>
                                <div>
                                    <strong>Пройти тест на темперамент</strong>
                                    <p style={{ fontSize: '0.75rem', color: 'var(--text-secondary)' }}>12 вопросов • 3 минуты</p>
                                </div>
                            </div>
                        </div>
                        
                        {/* Или выбрать вручную */}
                        <p style={{ fontSize: '0.8rem', color: 'var(--text-tertiary)', marginBottom: '0.5rem', textAlign: 'center' }}>или выберите вручную:</p>
                        
                        <div className="grid-2">
                            {temperaments.map(t => (
                                <div key={t.id} className={`temperament-card ${profile.temperament === t.id ? 'active' : ''}`} style={{ background: t.color + '15' }} onClick={() => saveProfile({ temperament: t.id })}>
                                    <div className="temperament-icon">{t.icon}</div>
                                    <div className="temperament-name">{t.name}</div>
                                    <div className="temperament-element">{t.element}</div>
                                </div>
                            ))}
                        </div>
                    </div>
                    
                    {/* Горячие линии */}
                    <div className="card" style={{ marginTop: '0.75rem', background: '#FEF2F2' }}>
                        <h3 style={{ marginBottom: '0.5rem' }}>📞 Экстренная помощь</h3>
                        {CRISIS_LINES.map((line, idx) => (
                            <div key={idx} style={{ marginBottom: '0.5rem', paddingBottom: '0.5rem', borderBottom: idx < CRISIS_LINES.length - 1 ? '1px solid var(--earth-light)' : 'none' }}>
                                <strong style={{ fontSize: '0.85rem' }}>{line.name}</strong>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                    <a href={`tel:${line.phone}`} style={{ color: '#DC2626', fontWeight: '600', fontSize: '0.9rem' }}>{line.phone}</a>
                                    <span style={{ fontSize: '0.7rem', color: 'var(--text-tertiary)' }}>{line.note}</span>
                                </div>
                            </div>
                        ))}
                    </div>
                    
                    {/* Планировщик бани */}
                    <div className="card" style={{ marginTop: '0.75rem', background: '#FEF3C7' }}>
                        <h3 style={{ marginBottom: '0.5rem' }}>🧖 День бани</h3>
                        <p style={{ fontSize: '0.8rem', color: 'var(--text-secondary)', marginBottom: '0.75rem' }}>
                            Выберите день для еженедельного посещения бани. Мы напомним и подберём масла.
                        </p>
                        <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.4rem' }}>
                            {DAY_NAMES.map(day => (
                                <div 
                                    key={day.id}
                                    onClick={() => saveSaunaDay(saunaDay === day.id ? null : day.id)}
                                    style={{ 
                                        padding: '0.5rem 0.75rem',
                                        borderRadius: '10px',
                                        background: saunaDay === day.id ? 'var(--amber)' : 'var(--cream-light)',
                                        color: saunaDay === day.id ? 'var(--text-on-dark)' : 'var(--text-primary)',
                                        cursor: 'pointer',
                                        textAlign: 'center',
                                        border: saunaDay === day.id ? 'none' : '1px solid var(--earth-light)',
                                        minWidth: '42px'
                                    }}
                                >
                                    <div style={{ fontSize: '1rem' }}>{day.icon}</div>
                                    <div style={{ fontSize: '0.7rem', fontWeight: '600' }}>{day.short}</div>
                                </div>
                            ))}
                        </div>
                        {saunaDay !== null && (
                            <div style={{ marginTop: '0.75rem', padding: '0.5rem', background: 'rgba(255,255,255,0.7)', borderRadius: '8px' }}>
                                <p style={{ fontSize: '0.85rem' }}>
                                    <strong>{DAY_NAMES[saunaDay].full}</strong>: {DAY_NAMES[saunaDay].oils}
                                </p>
                            </div>
                        )}
                    </div>
                    
                    <div className="alert alert-warning" style={{ marginTop: '0.75rem' }}>
                        <span>⚠️</span>
                        <div style={{ fontSize: '0.8rem' }}>Это приложение не заменяет профессиональную помощь.</div>
                    </div>
                </div>
            );
        }

        // ═══════════════════════════════════════════════════════════════
        // СТРАНИЦА ПИТАНИЯ
        // ═══════════════════════════════════════════════════════════════
        
        function NutritionPage({ setPage }) {
            const [progress, setProgress] = useState(DB.getNutritionProgress());
            const [showMealPlan, setShowMealPlan] = useState(false);
            const [showTemperament, setShowTemperament] = useState(false);
            const [showRecipes, setShowRecipes] = useState(false);
            const [selectedMeal, setSelectedMeal] = useState(null);
            const [currentDayView, setCurrentDayView] = useState(null);
            const [recipes, setRecipes] = useState(() => {
                const saved = DB.getRecipes();
                // Добавляем рецепты по умолчанию если их нет
                const defaultIds = DEFAULT_RECIPES.map(r => r.id);
                const hasDefaults = saved.some(r => defaultIds.includes(r.id));
                if (!hasDefaults && saved.length === 0) {
                    return [...DEFAULT_RECIPES];
                }
                return saved.length > 0 ? saved : [...DEFAULT_RECIPES];
            });
            const [selectedRecipe, setSelectedRecipe] = useState(null);
            const [showAddRecipe, setShowAddRecipe] = useState(false);
            const [newRecipe, setNewRecipe] = useState({ title: '', ingredients: '', steps: '', tips: '' });
            
            const profile = DB.getProfile();
            const temperament = profile.temperament || 'melancholic';
            const tempInfo = TEMPERAMENT_NUTRITION[temperament];
            const hour = new Date().getHours();
            
            // Определяем текущий приём пищи
            const getCurrentMealType = () => {
                if (hour >= 6 && hour < 11) return 'morning';
                if (hour >= 11 && hour < 15) return 'lunch';
                if (hour >= 17 && hour < 21) return 'dinner';
                return null;
            };
            
            const currentMealType = getCurrentMealType();
            const currentMeal = currentMealType ? NUTRITION_PLAN[currentMealType] : null;
            
            // Начать программу
            const startProgram = () => {
                DB.startNutritionProgram();
                setProgress(DB.getNutritionProgress());
            };
            
            // Отметить день выполненным
            const completeDay = (day) => {
                DB.completeNutritionDay(day);
                setProgress(DB.getNutritionProgress());
            };
            
            // Получить достижения
            const achievements = NUTRITION_ACHIEVEMENTS.filter(a => a.condition(progress.completedDays?.length || 0));
            
            // Случайный пример успеха
            const randomSuccess = NUTRITION_EXAMPLES.success[Math.floor(Math.random() * NUTRITION_EXAMPLES.success.length)];
            const randomMotivation = NUTRITION_EXAMPLES.motivation[Math.floor(Math.random() * NUTRITION_EXAMPLES.motivation.length)];
            
            // Экран просмотра дня программы
            if (currentDayView !== null) {
                const dayData = WEEK_TRANSITION[currentDayView];
                const isCompleted = progress.completedDays?.includes(currentDayView + 1);
                
                return (
                    <div className="fade-in">
                        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '1rem' }}>
                            <button className="btn btn-secondary btn-small" onClick={() => setCurrentDayView(null)}>← Назад</button>
                            <span style={{ fontWeight: 'bold' }}>День {dayData.day} из 7</span>
                        </div>
                        
                        <div className="progress-bar" style={{ height: '8px', marginBottom: '1rem' }}>
                            <div className="progress-fill" style={{ width: `${(dayData.day / 7) * 100}%` }}></div>
                        </div>
                        
                        <h1>{dayData.title}</h1>
                        
                        <div className="card" style={{ background: '#FEF3C7', marginTop: '1rem' }}>
                            <strong>🎯 Фокус дня:</strong>
                            <p style={{ fontSize: '1.1rem', marginTop: '0.5rem' }}>{dayData.focus}</p>
                        </div>
                        
                        <div className="card" style={{ marginTop: '0.75rem' }}>
                            <h3 style={{ marginBottom: '0.75rem' }}>📋 Задачи на сегодня</h3>
                            {dayData.tasks.map((task, idx) => (
                                <div key={idx} style={{ 
                                    display: 'flex', 
                                    alignItems: 'center', 
                                    gap: '0.5rem', 
                                    padding: '0.5rem',
                                    background: isCompleted ? '#F0FDF4' : 'transparent',
                                    borderRadius: '8px',
                                    marginBottom: '0.5rem'
                                }}>
                                    <span style={{ fontSize: '1.25rem' }}>{isCompleted ? '✅' : '⬜'}</span>
                                    <span>{task}</span>
                                </div>
                            ))}
                        </div>
                        
                        <div className="recommendation-card" style={{ marginTop: '0.75rem' }}>
                            <div className="recommendation-title">💡 Совет</div>
                            <p>{dayData.tip}</p>
                        </div>
                        
                        <div className="card" style={{ background: '#F0FDF4', marginTop: '0.75rem' }}>
                            <strong>🌟 Мотивация:</strong>
                            <p style={{ marginTop: '0.5rem', fontStyle: 'italic' }}>{dayData.motivation}</p>
                        </div>
                        
                        {!isCompleted && (
                            <button 
                                className="btn btn-primary btn-full" 
                                style={{ marginTop: '1rem' }}
                                onClick={() => completeDay(dayData.day)}
                            >
                                ✓ День выполнен!
                            </button>
                        )}
                        
                        {isCompleted && (
                            <div className="alert alert-info" style={{ marginTop: '1rem' }}>
                                <span>🎉</span>
                                <div>Отлично! Этот день уже выполнен.</div>
                            </div>
                        )}
                    </div>
                );
            }
            
            // Экран плана питания
            if (showMealPlan) {
                return (
                    <div className="fade-in">
                        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '1rem' }}>
                            <button className="btn btn-secondary btn-small" onClick={() => setShowMealPlan(false)}>← Назад</button>
                        </div>
                        
                        <h1>🍽️ План питания</h1>
                        <p style={{ color: 'var(--text-secondary)', marginBottom: '1rem' }}>Палео-подход с учётом биоритмов</p>
                        
                        {['morning', 'lunch', 'dinner'].map(mealType => {
                            const meal = NUTRITION_PLAN[mealType];
                            return (
                                <div key={mealType} className="card" style={{ marginBottom: '0.75rem' }}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', marginBottom: '0.5rem' }}>
                                        <span style={{ fontSize: '1.5rem' }}>{meal.icon}</span>
                                        <div>
                                            <h3 style={{ margin: 0 }}>{meal.title}</h3>
                                            <p style={{ fontSize: '0.8rem', color: 'var(--text-secondary)', margin: 0 }}>{meal.principle}</p>
                                        </div>
                                    </div>
                                    
                                    <p style={{ fontSize: '0.85rem', marginBottom: '0.75rem' }}>{meal.description}</p>
                                    
                                    <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.4rem', marginBottom: '0.5rem' }}>
                                        {meal.foods.map((food, idx) => (
                                            <span key={idx} style={{ 
                                                background: '#F0FDF4', 
                                                padding: '0.3rem 0.6rem', 
                                                borderRadius: '15px',
                                                fontSize: '0.8rem'
                                            }}>
                                                {food.icon} {food.name}
                                            </span>
                                        ))}
                                    </div>
                                    
                                    <div style={{ fontSize: '0.75rem', color: '#DC2626' }}>
                                        ⛔ Избегать: {meal.avoid.join(', ')}
                                    </div>
                                </div>
                            );
                        })}
                        
                        {/* Исключить */}
                        <div className="card" style={{ background: '#FEF2F2', marginTop: '0.75rem' }}>
                            <h3 style={{ marginBottom: '0.5rem' }}>{NUTRITION_PLAN.excluded.title}</h3>
                            <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.4rem' }}>
                                {NUTRITION_PLAN.excluded.items.map((item, idx) => (
                                    <span key={idx} style={{ 
                                        background: 'white', 
                                        padding: '0.3rem 0.6rem', 
                                        borderRadius: '15px',
                                        fontSize: '0.8rem',
                                        border: '1px solid #FECACA'
                                    }}>
                                        {item.icon} {item.name}
                                    </span>
                                ))}
                            </div>
                        </div>
                    </div>
                );
            }
            
            // Экран питания по темпераменту
            if (showTemperament) {
                return (
                    <div className="fade-in">
                        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '1rem' }}>
                            <button className="btn btn-secondary btn-small" onClick={() => setShowTemperament(false)}>← Назад</button>
                        </div>
                        
                        <div style={{ textAlign: 'center', marginBottom: '1.5rem' }}>
                            <span style={{ fontSize: '3rem' }}>{tempInfo.icon}</span>
                            <h1>{tempInfo.title}</h1>
                            <p style={{ color: 'var(--text-secondary)' }}>Стихия: {tempInfo.element}</p>
                        </div>
                        
                        <div className="card" style={{ background: '#FEF3C7', marginBottom: '0.75rem' }}>
                            <strong>⚡ Особенности:</strong>
                            <p style={{ marginTop: '0.5rem' }}>{tempInfo.tendency}</p>
                        </div>
                        
                        <div className="card" style={{ marginBottom: '0.75rem' }}>
                            <h3 style={{ marginBottom: '0.75rem' }}>✅ Рекомендации</h3>
                            {tempInfo.recommendations.map((rec, idx) => (
                                <p key={idx} style={{ fontSize: '0.85rem', marginBottom: '0.5rem' }}>• {rec}</p>
                            ))}
                        </div>
                        
                        <div className="card" style={{ background: '#F0FDF4', marginBottom: '0.75rem' }}>
                            <h3 style={{ marginBottom: '0.5rem' }}>🌟 Суперпродукты для вас</h3>
                            <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.4rem' }}>
                                {tempInfo.superfoods.map((food, idx) => (
                                    <span key={idx} className="btn btn-small btn-secondary">{food}</span>
                                ))}
                            </div>
                        </div>
                        
                        <div className="card" style={{ background: '#FEF2F2' }}>
                            <h3 style={{ marginBottom: '0.5rem' }}>⛔ Лучше избегать</h3>
                            <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.4rem' }}>
                                {tempInfo.avoid.map((item, idx) => (
                                    <span key={idx} style={{ 
                                        background: 'white', 
                                        padding: '0.3rem 0.6rem', 
                                        borderRadius: '15px',
                                        fontSize: '0.8rem'
                                    }}>{item}</span>
                                ))}
                            </div>
                        </div>
                        
                        {/* Другие темпераменты */}
                        <h3 style={{ marginTop: '1.5rem', marginBottom: '0.75rem' }}>Другие темпераменты</h3>
                        <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.5rem' }}>
                            {Object.entries(TEMPERAMENT_NUTRITION).map(([key, info]) => (
                                key !== temperament && (
                                    <div 
                                        key={key}
                                        className="card card-clickable"
                                        style={{ flex: '1 1 45%', minWidth: '120px', textAlign: 'center' }}
                                        onClick={() => {
                                            // Временно показать другой темперамент
                                        }}
                                    >
                                        <span style={{ fontSize: '2rem' }}>{info.icon}</span>
                                        <p style={{ fontWeight: 'bold', fontSize: '0.85rem' }}>{info.title}</p>
                                    </div>
                                )
                            ))}
                        </div>
                    </div>
                );
            }
            
            // Экран рецептов
            if (showRecipes) {
                // Просмотр конкретного рецепта
                if (selectedRecipe) {
                    const recipe = [...DEFAULT_RECIPES, ...recipes].find(r => r.id === selectedRecipe) || recipes.find(r => r.id === selectedRecipe);
                    if (!recipe) {
                        setSelectedRecipe(null);
                        return null;
                    }
                    
                    return (
                        <div className="fade-in">
                            <button className="btn btn-secondary btn-small" onClick={() => setSelectedRecipe(null)} style={{ marginBottom: '1rem' }}>
                                ← К рецептам
                            </button>
                            
                            <h1 style={{ marginBottom: '0.5rem' }}>{recipe.title}</h1>
                            
                            <div style={{ display: 'flex', gap: '0.75rem', marginBottom: '1rem', flexWrap: 'wrap' }}>
                                {recipe.cookTime && (
                                    <span className="btn btn-small btn-secondary">⏱️ {recipe.cookTime}</span>
                                )}
                                {recipe.servings && (
                                    <span className="btn btn-small btn-secondary">🍽️ {recipe.servings}</span>
                                )}
                            </div>
                            
                            {recipe.description && (
                                <p style={{ color: 'var(--text-secondary)', marginBottom: '1rem' }}>{recipe.description}</p>
                            )}
                            
                            {/* Ингредиенты */}
                            <div className="card" style={{ marginBottom: '0.75rem' }}>
                                <h3 style={{ marginBottom: '0.75rem' }}>📝 Ингредиенты</h3>
                                {Array.isArray(recipe.ingredients) ? (
                                    recipe.ingredients.map((ing, idx) => (
                                        <p key={idx} style={{ fontSize: '0.9rem', marginBottom: '0.4rem' }}>{ing}</p>
                                    ))
                                ) : (
                                    <p style={{ whiteSpace: 'pre-wrap' }}>{recipe.ingredients}</p>
                                )}
                            </div>
                            
                            {/* Шаги приготовления */}
                            <div className="card" style={{ marginBottom: '0.75rem' }}>
                                <h3 style={{ marginBottom: '0.75rem' }}>👨‍🍳 Приготовление</h3>
                                {Array.isArray(recipe.steps) ? (
                                    recipe.steps.map((step, idx) => (
                                        <div key={idx} style={{ 
                                            marginBottom: '1rem', 
                                            paddingLeft: '1rem',
                                            borderLeft: '3px solid var(--amber)'
                                        }}>
                                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                                <strong style={{ color: 'var(--amber)' }}>
                                                    {idx + 1}. {step.title || 'Шаг ' + (idx + 1)}
                                                </strong>
                                                {step.time && (
                                                    <span style={{ fontSize: '0.75rem', color: 'var(--text-secondary)' }}>
                                                        ⏱️ {step.time}
                                                    </span>
                                                )}
                                            </div>
                                            <p style={{ fontSize: '0.9rem', marginTop: '0.25rem' }}>{step.text || step}</p>
                                        </div>
                                    ))
                                ) : (
                                    <p style={{ whiteSpace: 'pre-wrap' }}>{recipe.steps}</p>
                                )}
                            </div>
                            
                            {/* Советы */}
                            {recipe.tips && recipe.tips.length > 0 && (
                                <div className="card" style={{ background: '#FEF3C7' }}>
                                    <h3 style={{ marginBottom: '0.5rem' }}>💡 Советы</h3>
                                    {Array.isArray(recipe.tips) ? (
                                        recipe.tips.map((tip, idx) => (
                                            <p key={idx} style={{ fontSize: '0.85rem', marginBottom: '0.3rem' }}>{tip}</p>
                                        ))
                                    ) : (
                                        <p style={{ whiteSpace: 'pre-wrap' }}>{recipe.tips}</p>
                                    )}
                                </div>
                            )}
                            
                            {/* Кнопка удаления для своих рецептов */}
                            {!recipe.isDefault && (
                                <button 
                                    className="btn" 
                                    style={{ 
                                        marginTop: '1rem', 
                                        width: '100%', 
                                        background: '#FEE2E2', 
                                        color: '#DC2626' 
                                    }}
                                    onClick={() => {
                                        if (confirm('Удалить этот рецепт?')) {
                                            const updated = DB.deleteRecipe(recipe.id);
                                            setRecipes(updated);
                                            setSelectedRecipe(null);
                                        }
                                    }}
                                >
                                    🗑️ Удалить рецепт
                                </button>
                            )}
                        </div>
                    );
                }
                
                // Форма добавления рецепта
                if (showAddRecipe) {
                    return (
                        <div className="fade-in">
                            <button className="btn btn-secondary btn-small" onClick={() => setShowAddRecipe(false)} style={{ marginBottom: '1rem' }}>
                                ← Отмена
                            </button>
                            
                            <h1>📝 Новый рецепт</h1>
                            
                            <div className="card" style={{ marginTop: '1rem' }}>
                                <div style={{ marginBottom: '1rem' }}>
                                    <label style={{ display: 'block', marginBottom: '0.3rem', fontWeight: 'bold' }}>
                                        Название блюда *
                                    </label>
                                    <input 
                                        type="text"
                                        value={newRecipe.title}
                                        onChange={(e) => setNewRecipe({...newRecipe, title: e.target.value})}
                                        placeholder="Например: Суп-пюре из тыквы"
                                        style={{ width: '100%', padding: '0.75rem', borderRadius: '8px', border: '1px solid #ddd', fontSize: '1rem' }}
                                    />
                                </div>
                                
                                <div style={{ marginBottom: '1rem' }}>
                                    <label style={{ display: 'block', marginBottom: '0.3rem', fontWeight: 'bold' }}>
                                        Ингредиенты *
                                    </label>
                                    <textarea 
                                        value={newRecipe.ingredients}
                                        onChange={(e) => setNewRecipe({...newRecipe, ingredients: e.target.value})}
                                        placeholder="Каждый ингредиент с новой строки:&#10;Тыква — 500г&#10;Лук — 1 шт.&#10;Сливки — 100 мл"
                                        rows={5}
                                        style={{ width: '100%', padding: '0.75rem', borderRadius: '8px', border: '1px solid #ddd', fontSize: '1rem', resize: 'vertical' }}
                                    />
                                </div>
                                
                                <div style={{ marginBottom: '1rem' }}>
                                    <label style={{ display: 'block', marginBottom: '0.3rem', fontWeight: 'bold' }}>
                                        Приготовление *
                                    </label>
                                    <textarea 
                                        value={newRecipe.steps}
                                        onChange={(e) => setNewRecipe({...newRecipe, steps: e.target.value})}
                                        placeholder="Опишите шаги приготовления..."
                                        rows={6}
                                        style={{ width: '100%', padding: '0.75rem', borderRadius: '8px', border: '1px solid #ddd', fontSize: '1rem', resize: 'vertical' }}
                                    />
                                </div>
                                
                                <div style={{ marginBottom: '1rem' }}>
                                    <label style={{ display: 'block', marginBottom: '0.3rem', fontWeight: 'bold' }}>
                                        Советы (необязательно)
                                    </label>
                                    <textarea 
                                        value={newRecipe.tips}
                                        onChange={(e) => setNewRecipe({...newRecipe, tips: e.target.value})}
                                        placeholder="Полезные советы..."
                                        rows={3}
                                        style={{ width: '100%', padding: '0.75rem', borderRadius: '8px', border: '1px solid #ddd', fontSize: '1rem', resize: 'vertical' }}
                                    />
                                </div>
                                
                                <button 
                                    className="btn btn-primary"
                                    style={{ width: '100%' }}
                                    disabled={!newRecipe.title || !newRecipe.ingredients || !newRecipe.steps}
                                    onClick={() => {
                                        const recipe = {
                                            title: newRecipe.title,
                                            ingredients: newRecipe.ingredients,
                                            steps: newRecipe.steps,
                                            tips: newRecipe.tips,
                                            isDefault: false
                                        };
                                        const updated = DB.addRecipe(recipe);
                                        setRecipes(updated);
                                        setNewRecipe({ title: '', ingredients: '', steps: '', tips: '' });
                                        setShowAddRecipe(false);
                                    }}
                                >
                                    ✅ Сохранить рецепт
                                </button>
                            </div>
                        </div>
                    );
                }
                
                // Список рецептов
                const allRecipes = [...DEFAULT_RECIPES, ...recipes.filter(r => !r.isDefault)];
                
                return (
                    <div className="fade-in">
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' }}>
                            <button className="btn btn-secondary btn-small" onClick={() => setShowRecipes(false)}>
                                ← Назад
                            </button>
                            <button className="btn btn-primary btn-small" onClick={() => setShowAddRecipe(true)}>
                                + Добавить
                            </button>
                        </div>
                        
                        <h1>📖 Рецепты</h1>
                        <p style={{ color: 'var(--text-secondary)', marginBottom: '1rem' }}>
                            Полезные рецепты для здорового питания
                        </p>
                        
                        {allRecipes.length === 0 ? (
                            <div className="card" style={{ textAlign: 'center' }}>
                                <span style={{ fontSize: '3rem' }}>🍳</span>
                                <h3>Рецептов пока нет</h3>
                                <p style={{ color: 'var(--text-secondary)' }}>Добавьте свой первый рецепт!</p>
                            </div>
                        ) : (
                            allRecipes.map(recipe => (
                                <div 
                                    key={recipe.id}
                                    className="card card-clickable"
                                    style={{ marginBottom: '0.75rem' }}
                                    onClick={() => setSelectedRecipe(recipe.id)}
                                >
                                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                                        <div>
                                            <h3 style={{ marginBottom: '0.25rem' }}>{recipe.title}</h3>
                                            {recipe.description && (
                                                <p style={{ fontSize: '0.85rem', color: 'var(--text-secondary)', marginBottom: '0.5rem' }}>
                                                    {recipe.description.substring(0, 60)}...
                                                </p>
                                            )}
                                            <div style={{ display: 'flex', gap: '0.5rem', flexWrap: 'wrap' }}>
                                                {recipe.cookTime && (
                                                    <span style={{ fontSize: '0.75rem', color: 'var(--text-secondary)' }}>
                                                        ⏱️ {recipe.cookTime}
                                                    </span>
                                                )}
                                                {recipe.isDefault && (
                                                    <span style={{ 
                                                        fontSize: '0.7rem', 
                                                        background: '#FEF3C7', 
                                                        padding: '0.15rem 0.4rem', 
                                                        borderRadius: '10px' 
                                                    }}>
                                                        ⭐ Рекомендовано
                                                    </span>
                                                )}
                                            </div>
                                        </div>
                                        <span style={{ fontSize: '1.5rem' }}>→</span>
                                    </div>
                                </div>
                            ))
                        )}
                    </div>
                );
            }
            
            // Главный экран питания
            return (
                <div className="fade-in">
                    <h1>🥗 Питание</h1>
                    <p style={{ color: 'var(--text-secondary)', marginBottom: '1rem' }}>Палео-подход для здоровья и энергии</p>
                    
                    {/* Текущий приём пищи */}
                    {currentMeal && (
                        <div className="card" style={{ background: '#FEF3C7', marginBottom: '0.75rem' }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', marginBottom: '0.5rem' }}>
                                <span style={{ fontSize: '1.5rem' }}>{currentMeal.icon}</span>
                                <div>
                                    <strong>Сейчас время:</strong>
                                    <p style={{ fontSize: '0.9rem', margin: 0 }}>{currentMeal.title}</p>
                                </div>
                            </div>
                            <p style={{ fontSize: '0.85rem', color: 'var(--text-secondary)' }}>{currentMeal.principle}</p>
                            <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.3rem', marginTop: '0.5rem' }}>
                                {currentMeal.foods.slice(0, 4).map((food, idx) => (
                                    <span key={idx} style={{ 
                                        background: 'white', 
                                        padding: '0.2rem 0.5rem', 
                                        borderRadius: '10px',
                                        fontSize: '0.75rem'
                                    }}>
                                        {food.icon} {food.name}
                                    </span>
                                ))}
                            </div>
                        </div>
                    )}
                    
                    {/* Программа на неделю */}
                    <div className="card" style={{ marginBottom: '0.75rem' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '0.75rem' }}>
                            <h3>📅 7-дневная программа</h3>
                            {progress.startDate && (
                                <span style={{ fontSize: '0.75rem', color: 'var(--text-secondary)' }}>
                                    День {Math.min(progress.currentDay || 1, 7)}
                                </span>
                            )}
                        </div>
                        
                        {!progress.startDate ? (
                            <div>
                                <p style={{ fontSize: '0.85rem', marginBottom: '0.75rem' }}>
                                    Постепенный переход на здоровое питание за 7 дней с пояснениями и поддержкой.
                                </p>
                                <button className="btn btn-primary btn-full" onClick={startProgram}>
                                    🚀 Начать программу
                                </button>
                            </div>
                        ) : (
                            <div>
                                {/* Прогресс */}
                                <div style={{ display: 'flex', gap: '0.3rem', marginBottom: '0.75rem' }}>
                                    {WEEK_TRANSITION.map((day, idx) => {
                                        const isCompleted = progress.completedDays?.includes(day.day);
                                        const isCurrent = day.day === progress.currentDay;
                                        return (
                                            <div 
                                                key={idx}
                                                onClick={() => setCurrentDayView(idx)}
                                                style={{ 
                                                    flex: 1,
                                                    height: '40px',
                                                    borderRadius: '8px',
                                                    background: isCompleted ? 'var(--harmony-green)' : isCurrent ? '#FEF3C7' : '#f0f0f0',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    justifyContent: 'center',
                                                    cursor: 'pointer',
                                                    border: isCurrent ? '2px solid var(--amber)' : 'none',
                                                    color: isCompleted ? 'white' : 'var(--text-primary)',
                                                    fontWeight: 'bold',
                                                    fontSize: '0.8rem'
                                                }}
                                            >
                                                {isCompleted ? '✓' : day.day}
                                            </div>
                                        );
                                    })}
                                </div>
                                
                                {/* Текущий день */}
                                {progress.currentDay <= 7 && (
                                    <button 
                                        className="btn btn-primary btn-full"
                                        onClick={() => setCurrentDayView(progress.currentDay - 1)}
                                    >
                                        📖 Открыть день {progress.currentDay}
                                    </button>
                                )}
                                
                                {progress.completedDays?.length >= 7 && (
                                    <div className="alert alert-info" style={{ marginTop: '0.5rem' }}>
                                        <span>🎉</span>
                                        <div>Поздравляем! Вы прошли всю программу!</div>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                    
                    {/* Достижения */}
                    {achievements.length > 0 && (
                        <div className="card" style={{ marginBottom: '0.75rem' }}>
                            <h3 style={{ marginBottom: '0.5rem' }}>🏆 Ваши достижения</h3>
                            <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.5rem' }}>
                                {achievements.map(a => (
                                    <div key={a.id} style={{ 
                                        background: '#FEF3C7',
                                        padding: '0.5rem 0.75rem',
                                        borderRadius: '10px',
                                        fontSize: '0.8rem'
                                    }}>
                                        {a.icon} {a.name}
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                    
                    {/* Быстрые действия */}
                    <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '0.75rem' }}>
                        <div 
                            className="card card-clickable"
                            style={{ flex: 1, textAlign: 'center' }}
                            onClick={() => setShowMealPlan(true)}
                        >
                            <span style={{ fontSize: '2rem' }}>🍽️</span>
                            <p style={{ fontWeight: 'bold', fontSize: '0.85rem' }}>План питания</p>
                        </div>
                        <div 
                            className="card card-clickable"
                            style={{ flex: 1, textAlign: 'center' }}
                            onClick={() => setShowTemperament(true)}
                        >
                            <span style={{ fontSize: '2rem' }}>{tempInfo.icon}</span>
                            <p style={{ fontWeight: 'bold', fontSize: '0.85rem' }}>Темперамент</p>
                        </div>
                        <div 
                            className="card card-clickable"
                            style={{ flex: 1, textAlign: 'center' }}
                            onClick={() => setShowRecipes(true)}
                        >
                            <span style={{ fontSize: '2rem' }}>📖</span>
                            <p style={{ fontWeight: 'bold', fontSize: '0.85rem' }}>Рецепты</p>
                        </div>
                    </div>
                    
                    {/* Пример успеха */}
                    <div className="card" style={{ background: '#F0FDF4', marginBottom: '0.75rem' }}>
                        <strong>💬 История успеха:</strong>
                        <p style={{ fontSize: '0.85rem', marginTop: '0.5rem', fontStyle: 'italic' }}>{randomSuccess}</p>
                    </div>
                    
                    {/* Мотивация */}
                    <div className="recommendation-card">
                        <div className="recommendation-title">💡 Мудрость</div>
                        <p style={{ fontStyle: 'italic' }}>{randomMotivation}</p>
                    </div>
                </div>
            );
        }
        
        function App() {
            const [page, setPage] = useState('home');
            const [practice, setPractice] = useState(null);
            
            let content;
            if (page === 'home') content = <HomePage setPage={setPage} setPractice={setPractice} />;
            else if (page === 'day') content = <DayPage setPage={setPage} setPractice={setPractice} />;
            else if (page === 'walks') content = <WalkTrackerPage setPage={setPage} setPractice={setPractice} />;
            else if (page === 'nutrition') content = <NutritionPage setPage={setPage} />;
            else if (page === 'practices') content = <PracticesPage setPage={setPage} setPractice={setPractice} />;
            else if (page === 'practice') content = <PracticePage practice={practice} setPage={setPage} />;
            else if (page === 'chat') content = <ChatPage />;
            else if (page === 'journal') content = <JournalPage />;
            else if (page === 'profile') content = <ProfilePage setPage={setPage} setPractice={setPractice} />;
            else if (page === 'programs') content = <ProgramsPage setPage={setPage} setPractice={setPractice} />;
            else if (page === 'rituals') content = <RitualsPage setPage={setPage} />;
            else if (page === 'analytics') content = <AnalyticsPage setPage={setPage} />;
            else if (page === 'crisis') content = <CrisisPage setPage={setPage} />;
            
            return (
                <div className="app">
                    <main className="main">{content}</main>
                    <BottomNav page={page} setPage={setPage} />
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
